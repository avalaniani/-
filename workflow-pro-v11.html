<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WorkFlow Pro - מנהל משימות</title>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f0f4f8;
    --bg2: #e8eef5;
    --bg3: #eaf0f7;
    --card: #ffffff;
    --border: #dde5ef;
    --border2: #c8d5e5;
    --text: #2d3a4a;
    --text2: #6b7e96;
    --text3: #a0b0c4;
    --accent: #7bb3d8;
    --accent2: #5a9bc8;
    --accent3: rgba(123,179,216,0.15);
    --green: #6bc4a6;
    --green2: rgba(107,196,166,0.18);
    --red: #e88fa0;
    --red2: rgba(232,143,160,0.18);
    --yellow: #e8c46a;
    --yellow2: rgba(232,196,106,0.18);
    --blue: #7bb3d8;
    --blue2: rgba(123,179,216,0.18);
    --orange: #e8a87a;
    --orange2: rgba(232,168,122,0.18);
    --pink: #d4a0c8;
    --pink2: rgba(212,160,200,0.18);
    --radius: 12px;
    --shadow: 0 4px 24px rgba(100,130,170,0.12);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Heebo', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ─── Login Screen ─── */
  #loginScreen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e8f0fa 0%, #f5e8f5 40%, #e8f5f0 100%);
    padding: 20px;
  }

  .login-box {
    width: 100%;
    max-width: 420px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 20px 60px rgba(100,130,200,0.12);
  }

  .login-logo {
    text-align: center;
    margin-bottom: 32px;
  }

  .login-logo h1 {
    font-size: 28px;
    font-weight: 800;
    background: linear-gradient(135deg, #7bb3d8, #d4a0c8, #6bc4a6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -1px;
  }

  .login-logo p { color: var(--text2); font-size: 13px; margin-top: 4px; }

  .form-group { margin-bottom: 18px; }
  .form-group label { display:block; font-size:13px; color:var(--text2); margin-bottom:6px; font-weight:500; }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(108,99,255,0.2);
  }
  .form-group select option { background: var(--bg3); }
  .form-group textarea { resize: vertical; min-height: 80px; }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border-radius: 10px;
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
  }
  .btn-primary {
    background: var(--accent);
    color: white;
    width: 100%;
    justify-content: center;
    font-size: 15px;
  }
  .btn-primary:hover { background: var(--accent2); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(123,179,216,0.35); }
  .btn-sm { padding: 7px 14px; font-size: 12px; }
  .btn-outline { background: transparent; border: 1px solid var(--border2); color: var(--text2); }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: var(--red2); color: #c0506a; border: 1px solid transparent; }
  .btn-danger:hover { background: var(--red); color: white; }
  .btn-success { background: var(--green2); color: #3a9a7a; border: 1px solid transparent; }
  .btn-success:hover { background: var(--green); color: white; }

  .demo-accounts {
    margin-top: 24px;
    border-top: 1px solid var(--border);
    padding-top: 20px;
  }
  .demo-accounts p { font-size: 12px; color: var(--text3); margin-bottom: 10px; text-align:center; }
  .demo-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .demo-btn {
    padding: 10px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    text-align: right;
    transition: all 0.2s;
  }
  .demo-btn:hover { border-color: var(--accent); background: var(--accent3); }
  .demo-btn .role { font-size: 11px; color: var(--text3); }
  .demo-btn .name { font-size: 13px; font-weight: 600; color: var(--text); }

  /* ─── App Layout ─── */
  #app { display: none; min-height: 100vh; }

  .app-wrapper { min-height: 100vh; }

  /* Sidebar */
  .sidebar {
    width: 250px;
    background: var(--card);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    right: 0;
    height: 100vh;
    z-index: 200;
    transition: transform 0.25s ease;
    transform: translateX(100%);
    will-change: transform;
  }
  .sidebar.open { transform: translateX(0); }

  /* Desktop: always show sidebar, hide hamburger */
  @media (min-width: 769px) {
    .sidebar { transform: translateX(0) !important; }
    .hamburger { display: none !important; }
    .sidebar-overlay { display: none !important; }
  }

  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-logo {
    font-size: 18px;
    font-weight: 800;
    background: linear-gradient(135deg, #7bb3d8, #d4a0c8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .sidebar-user {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
    flex-shrink: 0;
  }

  .sidebar-user-info .name { font-size: 13px; font-weight: 600; }
  .sidebar-user-info .role-badge {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 20px;
    font-weight: 700;
    display: inline-block;
    margin-top: 2px;
    border: 1px solid transparent;
    letter-spacing: 0.2px;
  }

  .sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; }

  .nav-section-title {
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text3);
    padding: 8px 8px 6px;
    margin-top: 8px;
  }

  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: var(--text2);
    transition: all 0.15s;
    margin-bottom: 2px;
  }
  .nav-item:hover { background: var(--bg3); color: var(--text); }
  .nav-item.active { background: var(--accent3); color: var(--accent); font-weight: 600; }
  .nav-item .icon { font-size: 16px; width: 20px; text-align:center; }
  .nav-item .badge {
    margin-right: auto;
    background: var(--accent);
    color: white;
    font-size: 10px;
    padding: 1px 7px;
    border-radius: 20px;
  }

  .sidebar-footer {
    padding: 16px;
    border-top: 1px solid var(--border);
  }

  /* Main Content */
  .main-content {
    margin-right: 0;
    min-height: 100vh;
    background: var(--bg);
  }
  @media (min-width: 769px) {
    .main-content { margin-right: 250px; }
  }

  /* Top Bar */
  .topbar {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .topbar-title { font-size: 17px; font-weight: 700; }

  .topbar-actions { display: flex; align-items: center; gap: 12px; }

  .hamburger {
    display: flex;
    background: none;
    border: none;
    color: var(--text);
    font-size: 22px;
    cursor: pointer;
    padding: 4px;
  }

  /* Pages */
  .page { display: none; padding: 24px; max-width: 1200px; margin: 0 auto; }
  .page.active { display: block; }

  /* Cards & Panels */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
  }

  .card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .card-title { font-size: 15px; font-weight: 700; }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }

  .stat-card.purple::before { background: linear-gradient(90deg, var(--accent), var(--accent2)); }
  .stat-card.green::before { background: var(--green); }
  .stat-card.yellow::before { background: var(--yellow); }
  .stat-card.blue::before { background: var(--blue); }
  .stat-card.red::before { background: var(--red); }
  .stat-card.orange::before { background: var(--orange); }

  .stat-icon { font-size: 20px; flex-shrink: 0; }
  .stat-value { font-size: 28px; font-weight: 800; letter-spacing: -1px; margin-top: 10px; text-align: center; }
  .stat-label { font-size: 12px; color: var(--text2); font-weight: 600; }
  .stat-header { display: flex; align-items: center; justify-content: center; gap: 8px; }

  /* Tables */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th {
    text-align: right;
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text3);
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
  }
  td {
    padding: 12px 14px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    vertical-align: middle;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #f5f8fc; }

  /* Tags & Badges */
  .tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
  }
  .tag-purple { background: var(--accent3); color: #4a88b8; }
  .tag-green { background: var(--green2); color: #3a9a7a; }
  .tag-red { background: var(--red2); color: #c0506a; }
  .tag-yellow { background: var(--yellow2); color: #a07820; }
  .tag-blue { background: var(--blue2); color: #4a88b8; }
  .tag-orange { background: var(--orange2); color: #b06830; }
  .tag-gray { background: rgba(0,0,0,0.05); color: var(--text2); }

  /* Task Cards */
  .tasks-grid { display: flex; flex-direction: column; gap: 10px; }

  .task-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .task-card:hover { border-color: var(--border2); transform: translateX(-2px); box-shadow: var(--shadow); }
  .task-card.done { opacity: 0.6; }
  .task-card.done .task-title { text-decoration: line-through; }

  .task-card-top { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
  .task-title { font-size: 14px; font-weight: 600; line-height: 1.4; flex: 1; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .task-meta { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 10px; }
  .task-desc { font-size: 12px; color: var(--text2); line-height: 1.5; margin-top: 6px; }

  .priority-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 4px;
  }
  .p-high { background: var(--red); }
  .p-medium { background: var(--yellow); }
  .p-low { background: var(--green); }

  /* Notes */
  .notes-area {
    width: 100%;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 14px;
    line-height: 1.7;
    resize: vertical;
    min-height: 150px;
    outline: none;
    transition: border-color 0.2s;
  }
  .notes-area:focus { border-color: var(--accent); }

  /* Hours Table */
  .hours-table { border-radius: var(--radius); overflow: hidden; }
  .hours-table th { background: #f5f8fc; }
  .hours-input {
    width: 86px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 6px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 13px;
    text-align: center;
    outline: none;
  }
  .hours-input:focus { border-color: var(--accent); }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 28px;
    width: 100%;
    max-width: 480px;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: slideUp 0.25s ease;
  }
  @keyframes slideUp { from { transform: translateY(20px); opacity:0; } to { transform: translateY(0); opacity:1; } }
  .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
  .modal-close {
    position: absolute;
    top: 16px;
    left: 16px;
    background: none;
    border: none;
    color: var(--text2);
    font-size: 20px;
    cursor: pointer;
  }
  .modal-close:hover { color: var(--text); }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

  /* Company Cards (Admin) */
  .company-grid { display: flex; flex-direction: column; gap: 10px; }
  .company-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    transition: all 0.2s;
  }
  .company-card:hover { border-color: var(--border2); }
  .company-logo {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    margin-bottom: 12px;
  }
  .company-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
  .company-meta { font-size: 12px; color: var(--text2); margin-bottom: 14px; }
  .company-actions { display: flex; gap: 8px; }

  /* Signature area */
  .sig-box {
    background: var(--bg3);
    border: 2px dashed var(--border2);
    border-radius: var(--radius);
    padding: 24px;
    text-align: center;
  }
  .sig-stamp {
    display: inline-block;
    border: 3px solid var(--green);
    border-radius: 50%;
    padding: 16px 20px;
    color: #3a9a7a;
    font-weight: 800;
    font-size: 18px;
    transform: rotate(-15deg);
    box-shadow: 0 0 20px rgba(107,196,166,0.3);
  }

  /* Toggle Checkbox */
  .toggle-wrap { display: flex; align-items: center; gap: 10px; }
  .toggle {
    width: 44px;
    height: 24px;
    background: var(--border2);
    border-radius: 20px;
    cursor: pointer;
    position: relative;
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .toggle.on { background: var(--accent); }
  .toggle::after {
    content: '';
    position: absolute;
    width: 18px;
    height: 18px;
    background: white;
    border-radius: 50%;
    top: 3px;
    right: 3px;
    transition: transform 0.2s;
  }
  .toggle.on::after { transform: translateX(-20px); }

  /* Tabs */
  .tabs { display: flex; gap: 4px; background: var(--bg3); border-radius: 10px; padding: 4px; margin-bottom: 20px; overflow-x: auto; }
  .tab {
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: var(--text2);
    transition: all 0.15s;
    white-space: nowrap;
  }
  .tab.active { background: var(--card); color: var(--text); box-shadow: var(--shadow); }

  /* Notification dot */
  .notif-dot {
    width: 8px;
    height: 8px;
    background: var(--accent);
    border-radius: 50%;
    display: inline-block;
  }

  .active-sort { border-color: var(--accent) !important; color: var(--accent) !important; background: var(--accent3) !important; }

  /* Monthly hours grid — fixed layout so all 31 days always fit */
  .hours-grid-table {
    border-collapse: collapse;
    table-layout: fixed;
    width: 100%;
    font-size: 11px;
  }
  .hours-grid-table th {
    background: var(--bg3);
    padding: 5px 1px;
    text-align: center;
    font-size: 10px;
    font-weight: 700;
    border: 1px solid var(--border);
    overflow: hidden;
    white-space: nowrap;
  }
  .hours-grid-table th.worker-name-col {
    text-align: right;
    width: 120px;
    position: sticky;
    right: 0;
    background: var(--bg3);
    z-index: 2;
    border-right: 2px solid var(--border2);
    padding-right: 8px;
    padding-left: 4px;
  }
  .hours-grid-table th.total-col {
    width: 46px;
    background: #e8f0fa;
    border-left: 2px solid var(--border2);
  }
  .hours-grid-table td {
    padding: 5px 1px;
    text-align: center;
    border: 1px solid var(--border);
    font-size: 10px;
    overflow: hidden;
    white-space: nowrap;
    color: var(--text);
  }
  .hours-grid-table td.worker-name-td {
    text-align: right;
    font-weight: 700;
    font-size: 11px;
    background: #fafcff;
    position: sticky;
    right: 0;
    z-index: 1;
    border-right: 2px solid var(--border2);
    padding: 6px 8px 6px 4px;
    width: 120px;
  }
  .hours-grid-table td.total-td {
    font-weight: 800;
    font-size: 11px;
    color: #4a6080;
    background: #f0f5fb;
    border-left: 2px solid var(--border2);
    width: 46px;
  }
  .hours-grid-table th.today-col { background: #ddeeff; color: #3366aa; }
  .hours-grid-table td.today-col { background: #eef6ff; }
  .hours-grid-table td.weekend-col { background: #fff5f5; color: #c0506a; }
  .hours-grid-table th.weekend-col { background: #ffe8ea; color: #c0506a; }
  .hours-grid-table td.signed-cell { background: #f0fff4; }
  .hours-grid-table td.has-hours { font-weight: 700; color: #3366aa; }
  .hours-grid-table tr.total-row td { background: #f0f5fb; font-weight: 800; font-size: 11px; border-top: 2px solid var(--border2); }
  .hours-grid-table tr:hover td { background: #f5f8fc; }
  .hours-grid-table tr:hover td.worker-name-td { background: #e8f0fa; }
  .hours-grid-table tr:hover td.today-col { background: #ddeeff; }
  /* Fullscreen — bigger text, still fixed layout */
  #fs-workers-grid-wrap .hours-grid-table { font-size: 13px; }
  #fs-workers-grid-wrap .hours-grid-table th { font-size: 12px; padding: 7px 2px; }
  #fs-workers-grid-wrap .hours-grid-table td { font-size: 12px; padding: 8px 2px; }
  #fs-workers-grid-wrap .hours-grid-table td.worker-name-td { font-size: 13px; width: 140px; }
  #fs-workers-grid-wrap .hours-grid-table th.worker-name-col { width: 140px; }
  #fs-workers-grid-wrap .hours-grid-table td.total-td { font-size: 13px; }
  #fs-workers-grid-wrap .hours-grid-table tr.total-row td { font-size: 12px; }



  /* Progress bar */
  .progress-bar {
    background: var(--bg3);
    border-radius: 20px;
    height: 6px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    border-radius: 20px;
    transition: width 0.5s;
  }

  /* Search input */
  .search-input {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 14px;
    color: var(--text);
    font-family: 'Heebo', sans-serif;
    font-size: 13px;
    outline: none;
    width: 200px;
    transition: all 0.2s;
  }
  .search-input:focus { border-color: var(--accent); width: 240px; }

  /* Empty state */
  .empty-state { text-align: center; padding: 48px 20px; color: var(--text3); }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* Sidebar overlay — hidden by default, shown on mobile when open */
  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 150;
  }
  .sidebar-overlay.open { display: block; }

  /* Responsive */
  @media (max-width: 768px) {
    .page { padding: 16px; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .tasks-grid { grid-template-columns: 1fr; }
    .topbar { padding: 0 16px; }
    .search-input { width: 140px; }
    .search-input:focus { width: 160px; }
    /* Worker page tablet */
    #page-worker-hours .card { padding: 14px; }
    .hours-input { width: 70px !important; font-size: 11px; padding: 3px 3px; }
    .hi-time { width: 70px !important; }
    .hours-table th, .hours-table td { padding: 6px 3px; font-size: 11px; }
    #worker-name-display { font-size: 18px !important; }
    #worker-total-hours, #worker-work-days, #worker-avg-hours { font-size: 22px !important; }
  }

  @media (max-width: 480px) {
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .company-grid { grid-template-columns: 1fr; }
    .demo-grid { grid-template-columns: 1fr; }

    /* Worker page narrow mobile */
    #page-worker-hours { padding: 10px !important; }
    #page-worker-hours > .card { padding: 12px 10px !important; }

    /* Worker header: stack vertically on mobile */
    #page-worker-hours > .card:first-child > div:first-child {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 10px !important;
    }
    #page-worker-hours > .card:first-child > div:first-child > div:last-child {
      width: 100%;
      justify-content: space-between;
    }
    #worker-month-label { font-size: 13px !important; min-width: 80px !important; }
    #page-worker-hours .btn-outline.btn-sm { padding: 6px 8px; font-size: 11px; }

    /* Stats row */
    #worker-total-hours, #worker-work-days, #worker-avg-hours { font-size: 20px !important; }

    /* Hours table compact */
    .hours-table { font-size: 11px; }
    .hours-table th, .hours-table td { padding: 5px 2px; }
    .hours-input { width: 58px !important; font-size: 10px !important; padding: 2px 2px !important; }
    .hi-time { width: 58px !important; }

    /* Signature inputs full width */
    .sig-box input.search-input { width: 100% !important; box-sizing: border-box; }
    #sig-full-month-block > div:last-child { flex-direction: column; gap: 8px; }
    #sig-full-month-block > div:last-child > * { width: 100%; box-sizing: border-box; }
    /* Date inputs: each takes its own row so full date (day) is visible */
    #sigDayFrom, #sigDayTo { width: 100% !important; min-width: 150px !important; box-sizing: border-box; }
    #sig-signed .btn { width: 100%; justify-content: center; }
    /* Stack date inputs vertically on small screens */
    #sigDayFrom + span + #sigDayTo { margin-top: 0; }

    /* Topbar search narrower */
    .topbar-actions .search-input { width: 100px; }
    .topbar-actions .search-input:focus { width: 120px; }
  }

  @media (max-width: 360px) {
    /* Very narrow phones (320px) */
    #page-worker-hours { padding: 6px !important; }
    #page-worker-hours > .card { padding: 10px 8px !important; }
    .hours-input { width: 50px !important; font-size: 10px !important; padding: 2px 1px !important; }
    .hi-time { width: 50px !important; }
    .hours-table th, .hours-table td { padding: 3px 2px; }
    /* Hide notes column on very small screens */
    .hours-table th:last-child, .hours-table td:last-child { display: none; }
    .btn-sm { padding: 5px 7px; font-size: 11px; }
    .topbar-title { font-size: 14px; }
  }

  /* Analytics responsive */
  @media (max-width: 768px) {
    #page-ceo-analytics [style*="grid-template-columns:1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }
  }

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen">
  <div class="login-box">
    <div class="login-logo">
      <h1>WorkFlow Pro ⚡</h1>
      <p>מערכת ניהול משימות מתקדמת</p>
    </div>
    <div class="form-group">
      <label>שם משתמש</label>
      <input type="text" id="loginUser" placeholder="הכנס שם משתמש">
    </div>
    <div class="form-group">
      <label>סיסמה</label>
      <input type="password" id="loginPass" placeholder="הכנס סיסמה">
    </div>
    <div id="loginError" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none;">שם משתמש או סיסמה שגויים</div>
    <button class="btn btn-primary" onclick="doLogin()">כניסה למערכת</button>
    <div class="demo-accounts">
      <p>כניסה מהירה לדמו</p>
      <div class="demo-grid">
        <div class="demo-btn" onclick="quickLogin('admin','admin123')">
          <div class="role">👑 מנהל מערכת</div>
          <div class="name">Admin</div>
        </div>
        <div class="demo-btn" onclick="quickLogin('ceo_techcorp','ceo123')">
          <div class="role">🏢 מנכ"ל</div>
          <div class="name">TechCorp</div>
        </div>
        <div class="demo-btn" onclick="quickLogin('employee1','emp123')">
          <div class="role">💼 עובד</div>
          <div class="name">דוד לוי</div>
        </div>
        <div class="demo-btn" onclick="quickLogin('worker1','work123')">
          <div class="role">🔧 פועל</div>
          <div class="name">יוסף כהן</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
  <div class="app-wrapper">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">WorkFlow Pro ⚡</div>
        <div class="sidebar-user">
          <div class="user-avatar" id="userAvatar"></div>
          <div class="sidebar-user-info">
            <div class="name" id="userName"></div>
            <div class="role-badge" id="roleBadge"></div>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav" id="sidebarNav"></nav>
      <div class="sidebar-footer">
        <button class="btn btn-outline btn-sm" onclick="logout()" style="width:100%;justify-content:center;">🚪 יציאה</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main-content">
      <div class="topbar">
        <button class="hamburger" onclick="toggleSidebar()">☰</button>
        <div class="topbar-title" id="pageTitle">לוח בקרה</div>
        <div class="topbar-actions">
          <input type="text" id="globalSearch" class="search-input" placeholder="🔍 חיפוש..." oninput="handleSearch(this.value)">
          <span id="topbarInfo" style="font-size:12px;color:var(--text2);"></span>
        </div>
      </div>

      <!-- ════════════════ ADMIN PAGES ════════════════ -->
      <!-- Admin Dashboard -->
      <div class="page" id="page-admin-dashboard">
        <div class="stats-grid">
          <div class="stat-card purple">
            <div class="stat-header"><div class="stat-icon">🏢</div><div class="stat-label">חברות במערכת</div></div>
            <div class="stat-value" id="stat-companies">3</div>
          </div>
          <div class="stat-card blue">
            <div class="stat-header"><div class="stat-icon">👥</div><div class="stat-label">משתמשים רשומים</div></div>
            <div class="stat-value" id="stat-users">12</div>
          </div>
          <div class="stat-card green">
            <div class="stat-header"><div class="stat-icon">✅</div><div class="stat-label">משימות הושלמו</div></div>
            <div class="stat-value">48</div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-header"><div class="stat-icon">⏳</div><div class="stat-label">משימות פתוחות</div></div>
            <div class="stat-value">23</div>
          </div>
        </div>
      </div>

      <!-- Admin Companies -->
      <div class="page" id="page-admin-companies">
        <div class="card-header" style="margin-bottom:14px;flex-wrap:nowrap;gap:8px;">
          <div class="card-title" style="font-size:18px;white-space:nowrap;">🏢 ניהול חברות</div>
          <button class="btn btn-primary btn-sm" onclick="openAddCompany()" style="white-space:nowrap;">+ הוסף חברה</button>
        </div>
        <!-- Sort bar -->
        <div class="card" style="padding:12px 16px;margin-bottom:14px;">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
            <span style="font-size:12px;color:var(--text2);font-weight:600;">מיון לפי:</span>
            <button class="sort-btn btn btn-outline btn-sm active-sort" id="csort-name" onclick="setCompanySort('name')">שם ↕</button>
            <button class="sort-btn btn btn-outline btn-sm" id="csort-employees" onclick="setCompanySort('employees')">עובדים ↕</button>
            <button class="sort-btn btn btn-outline btn-sm" id="csort-workers" onclick="setCompanySort('workers')">פועלים ↕</button>
            <button class="sort-btn btn btn-outline btn-sm" id="csort-total" onclick="setCompanySort('total')">סה"כ אנשים ↕</button>
          </div>
        </div>
        <div id="companiesGrid"></div>
      </div>

      <!-- Admin Users -->
      <div class="page" id="page-admin-users">
        <div class="card-header" style="margin-bottom:16px;flex-wrap:nowrap;gap:8px;">
          <div class="card-title" style="font-size:18px;white-space:nowrap;">👥 ניהול משתמשים וסיסמאות</div>
          <button class="btn btn-primary btn-sm" onclick="openAddUser()" style="white-space:nowrap;">+ הוסף משתמש</button>
        </div>
        <!-- Filters & Sort bar -->
        <div class="card" style="padding:14px 18px;margin-bottom:14px;">
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
            <input type="text" id="usersSearch" class="search-input" style="width:220px;" placeholder="🔍 חיפוש לפי שם / משתמש..." oninput="renderAdminUsers()">
            <select id="usersFilterRole" onchange="renderAdminUsers()" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;outline:none;cursor:pointer;">
              <option value="">כל התפקידים</option>
              <option value="admin">👑 מנהל מערכת</option>
              <option value="ceo">🏢 מנכ"ל</option>
              <option value="employee">💼 עובד</option>
              <option value="worker">🔧 פועל</option>
            </select>
            <select id="usersFilterCompany" onchange="renderAdminUsers()" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;outline:none;cursor:pointer;">
              <option value="">כל החברות</option>
            </select>
            <div style="margin-right:auto;display:flex;gap:6px;align-items:center;">
              <span style="font-size:12px;color:var(--text2);">מיון לפי:</span>
              <button class="sort-btn btn btn-outline btn-sm active-sort" id="sort-name" onclick="setSort('name')">שם ↕</button>
              <button class="sort-btn btn btn-outline btn-sm" id="sort-role" onclick="setSort('role')">תפקיד ↕</button>
              <button class="sort-btn btn btn-outline btn-sm" id="sort-company" onclick="setSort('company')">חברה ↕</button>
            </div>
          </div>
        </div>
        <div class="card" style="padding:0;">
          <div class="table-wrap">
            <table>
              <thead><tr><th>שם</th><th>תפקיד</th><th>חברה</th><th>שם משתמש</th><th>סיסמה</th><th>פעולות</th></tr></thead>
              <tbody id="usersTableBody"></tbody>
            </table>
          </div>
          <div id="usersCount" style="padding:10px 16px;font-size:12px;color:var(--text3);border-top:1px solid var(--border);"></div>
        </div>
      </div>

      <!-- Admin Notes -->
      <div class="page" id="page-admin-notes">
        <div class="card">
          <div class="card-header">
            <div class="card-title">📝 הערות אישיות - מנהל המערכת</div>
            <button class="btn btn-success btn-sm" onclick="saveNotes('admin')">💾 שמור</button>
          </div>
          <textarea class="notes-area" id="admin-notes" placeholder="כתוב כאן הערות אישיות..." rows="12"></textarea>
        </div>
        <div id="admin-quick-notes" style="margin-top:16px;"></div>
        <button class="btn btn-outline btn-sm" onclick="addQuickNote('admin')" style="margin-top:10px;">+ הוסף פתק מהיר</button>
      </div>

      <!-- Admin AI Assistant -->
      <div class="page" id="page-admin-ai">
        <div style="display:flex;flex-direction:column;height:calc(100vh - 140px);gap:0;">
          <div class="card" style="margin-bottom:12px;padding:16px 20px;background:linear-gradient(135deg,#e8f0ff,#f0e8ff);border-color:#b8c8f0;flex-shrink:0;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#4a6cc8,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 12px rgba(74,108,200,0.3);">🤖</div>
              <div>
                <div style="font-size:17px;font-weight:800;">עוזר AI — מנהל מערכת</div>
                <div style="font-size:12px;color:var(--text2);">שאל שאלות על המערכת, קבל עצות לשיפור, ובצע פעולות ניהוליות</div>
              </div>
              <button onclick="clearAdminAiChat()" class="btn btn-outline btn-sm" style="margin-right:auto;font-size:11px;">🗑️ נקה שיחה</button>
            </div>
          </div>

          <div id="admin-ai-suggestions" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;flex-shrink:0;">
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">📊 כמה חברות וכמה משתמשים יש במערכת?</button>
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">💡 מה אפשר לשפר במערכת?</button>
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">🏢 תן לי סיכום על כל החברות</button>
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">👥 מי המשתמשים ללא חברה?</button>
            <button onclick="sendAdminAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#b8c8f0;color:#4a6cc8;">⚠️ האם יש בעיות או אנומליות במערכת?</button>
          </div>

          <div id="admin-ai-messages" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px;padding:4px 2px;min-height:0;">
            <div id="admin-ai-welcome" style="text-align:center;padding:32px 16px;color:var(--text2);">
              <div style="font-size:40px;margin-bottom:12px;">🤖</div>
              <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;">שלום מנהל המערכת!</div>
              <div style="font-size:13px;line-height:1.7;">אני מכיר את כל הנתונים במערכת ויכול לעזור לך לנהל אותה.<br>
              אני יכול <strong>לענות שאלות</strong>, לתת <strong>עצות לשיפור</strong>, וגם <strong>לבצע פעולות</strong> כמו הוספת חברה, הוספת משתמש, מחיקה, ועוד.</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:flex-end;margin-top:10px;flex-shrink:0;">
            <textarea id="admin-ai-input" placeholder="שאל שאלה או בקש לבצע פעולה..." rows="2"
              style="flex:1;border:2px solid #b8c8f0;border-radius:12px;padding:10px 14px;font-family:inherit;font-size:13px;resize:none;outline:none;line-height:1.5;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='#4a6cc8'" onblur="this.style.borderColor='#b8c8f0'"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAdminAiMessage();}"></textarea>
            <button onclick="sendAdminAiMessage()" id="admin-ai-send-btn"
              style="background:linear-gradient(135deg,#4a6cc8,#8b5cf6);color:white;border:none;border-radius:12px;padding:10px 18px;cursor:pointer;font-size:18px;height:46px;flex-shrink:0;box-shadow:0 4px 12px rgba(74,108,200,0.3);">➤</button>
          </div>
          <div style="font-size:10px;color:var(--text3);text-align:center;margin-top:6px;flex-shrink:0;">Enter לשליחה • Shift+Enter לשורה חדשה</div>
        </div>
      </div>

      <!-- ════════════════ CEO PAGES ════════════════ -->
      <!-- CEO Dashboard -->
      <div class="page" id="page-ceo-dashboard">
        <div id="ceo-company-header" class="card" style="margin-bottom:20px;padding:24px;background:linear-gradient(135deg,#e8f0fa,#f5e8f5);border-color:var(--accent);">
          <div style="font-size:28px;margin-bottom:8px;" id="ceo-company-emoji">🏢</div>
          <div style="font-size:22px;font-weight:800;" id="ceo-company-name">חברה שלי</div>
          <div style="color:var(--text2);font-size:13px;" id="ceo-company-field">תחום פעילות</div>
        </div>
        <div class="stats-grid">
          <div class="stat-card blue">
            <div class="stat-header"><div class="stat-icon">💼</div><div class="stat-label">עובדים</div></div>
            <div class="stat-value" id="ceo-stat-employees">0</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-header"><div class="stat-icon">🔧</div><div class="stat-label">פועלים</div></div>
            <div class="stat-value" id="ceo-stat-workers">0</div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-header"><div class="stat-icon">📋</div><div class="stat-label">משימות פתוחות</div></div>
            <div class="stat-value" id="ceo-stat-tasks">0</div>
          </div>
          <div class="stat-card green">
            <div class="stat-header"><div class="stat-icon">✅</div><div class="stat-label">הושלמו</div></div>
            <div class="stat-value" id="ceo-stat-done">0</div>
          </div>
        </div>

        <!-- ── Analytics Section (merged) ── -->
        <div style="margin-top:28px;border-top:2px solid var(--border);padding-top:20px;">

          <!-- Smart Alerts -->
          <div id="ceo-analytics-alerts" style="margin-bottom:20px;"></div>

          <!-- Month selector + title row -->
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
            <div style="font-size:17px;font-weight:800;">📊 ניתוח וביצועים</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <button class="btn btn-outline btn-sm" onclick="changeAnalyticsMonth(-1)">▶</button>
              <span id="analytics-month-label" style="font-size:14px;font-weight:700;min-width:120px;text-align:center;"></span>
              <button class="btn btn-outline btn-sm" onclick="changeAnalyticsMonth(1)">◀</button>
            </div>
          </div>

          <!-- Summary stat cards -->
          <div class="stats-grid" id="analytics-stat-cards" style="margin-bottom:24px;"></div>

          <!-- Charts row -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
            <div class="card" style="padding:20px;">
              <div class="card-header"><div class="card-title">⏱️ שעות לפי פועל — חודש נוכחי</div></div>
              <div style="position:relative;height:260px;"><canvas id="chart-worker-hours"></canvas></div>
            </div>
            <div class="card" style="padding:20px;">
              <div class="card-header"><div class="card-title">📈 השוואת חודשים — 6 חודשים אחרונים</div></div>
              <div style="position:relative;height:260px;"><canvas id="chart-monthly-comparison"></canvas></div>
            </div>
          </div>

          <!-- Top Performers + Month comparison -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
            <div class="card" style="padding:20px;">
              <div class="card-header"><div class="card-title">🏆 Top Performers — החודש</div></div>
              <div id="analytics-top-performers"></div>
            </div>
            <div class="card" style="padding:20px;">
              <div class="card-header"><div class="card-title">🔄 השוואה לחודש קודם</div></div>
              <div id="analytics-month-compare"></div>
            </div>
          </div>

        </div>
      </div>

      <!-- CEO Employees -->
      <div class="page" id="page-ceo-employees">
        <div class="card-header" style="margin-bottom:20px;flex-wrap:nowrap;gap:8px;">
          <div class="card-title" style="font-size:18px;white-space:nowrap;">💼 ניהול עובדים</div>
          <button class="btn btn-primary btn-sm" onclick="ceoOpenAddMember('employee')" style="white-space:nowrap;">+ הוסף עובד</button>
        </div>
        <div class="card">
          <div class="table-wrap">
            <table>
              <thead><tr><th>עובד</th><th>תפקיד</th><th>משימות פתוחות</th><th>משימות הושלמו</th><th>הספק</th><th>פעולות</th></tr></thead>
              <tbody id="ceo-employees-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CEO Workers -->
      <div class="page" id="page-ceo-workers">
        <!-- Workers list section -->
        <div class="card" style="margin-bottom:16px;">
          <div class="card-header" style="flex-wrap:wrap;gap:10px;">
            <div style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px 6px;border-radius:8px;transition:background 0.15s;" onclick="toggleSection('workers-section','workers-toggle-icon')" onmouseover="this.style.background='rgba(0,0,0,0.04)'" onmouseout="this.style.background='transparent'">
              <span id="workers-toggle-icon" style="font-size:14px;transition:transform 0.2s;display:inline-block;color:var(--text3);">▾</span>
              <div class="card-title" style="margin:0;">🔧 ניהול פועלים ושעות</div>
            </div>
            <div style="display:flex;gap:8px;margin-right:auto;" id="workers-action-btns">
              <button class="btn btn-primary btn-sm" onclick="ceoOpenAddMember('worker')" id="btn-add-worker">+ הוסף פועל</button>
              <button class="btn btn-outline btn-sm" onclick="openBulkImportWorkers()" id="btn-import-workers"
                style="border-color:var(--green);color:var(--green);transition:background 0.15s,color 0.15s;white-space:nowrap;"
                onmouseover="this.style.background='var(--green)';this.style.color='white'"
                onmouseout="this.style.background='transparent';this.style.color='var(--green)'">📥 ייבוא פועלים מאקסל</button>
            </div>
          </div>
          <div id="workers-section">
            <!-- Workers search -->
            <div style="padding:10px 0 8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <select id="workers-search-type" onchange="filterWorkersTable()" style="border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:12px;background:var(--bg3);color:var(--text);cursor:pointer;font-family:inherit;">
                <option value="name">🔎 שם</option>
                <option value="idpassport" selected>🪪 ת"ז / דרכון</option>
              </select>
              <input type="text" id="workers-search-input" placeholder="חפש פועל..." oninput="filterWorkersTable()"
                style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:13px;background:white;color:var(--text);min-width:180px;font-family:inherit;outline:none;">
              <span id="workers-search-count" style="font-size:12px;color:var(--text2);"></span>
            </div>
            <div class="table-wrap">
              <table>
                <thead><tr><th>פועל</th><th>סה"כ שעות</th><th>שעות חתומות ✅</th><th>שעות לא חתומות ⏳</th><th>סטטוס</th><th>צפייה</th><th>פעולות</th></tr></thead>
                <tbody id="ceo-workers-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Monthly Grid View -->
        <div class="card" style="margin-bottom:16px;">
          <div class="card-header" style="flex-wrap:wrap;gap:10px;">
            <div style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:4px 6px;border-radius:8px;transition:background 0.15s;" onclick="toggleSection('grid-section','grid-toggle-icon')" onmouseover="this.style.background='rgba(0,0,0,0.04)'" onmouseout="this.style.background='transparent'">
              <span id="grid-toggle-icon" style="font-size:14px;transition:transform 0.2s;display:inline-block;color:var(--text3);">▾</span>
              <div class="card-title" style="margin:0;">📅 לוח שעות חודשי</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-right:auto;">
              <button class="btn btn-outline btn-sm" onclick="changeGridMonth(-1)">▶</button>
              <span id="grid-month-label" style="font-size:14px;font-weight:700;min-width:110px;text-align:center;"></span>
              <button class="btn btn-outline btn-sm" onclick="changeGridMonth(1)">◀</button>

              <!-- Zoom control -->
              <div style="display:flex;align-items:center;gap:0;background:var(--bg3);border:1px solid var(--border);border-radius:10px;overflow:hidden;">
                <button onclick="stepGridZoom(-0.5, false)" style="border:none;background:none;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);line-height:1;transition:background 0.15s;" onmouseover="this.style.background='rgba(0,0,0,0.06)'" onmouseout="this.style.background='none'" title="הקטן">−</button>
                <div style="width:1px;height:20px;background:var(--border);"></div>
                <div style="display:flex;align-items:center;gap:4px;padding:0 8px;">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="color:var(--text3);flex-shrink:0;"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
                  <span id="grid-zoom-label" style="font-size:12px;font-weight:600;color:var(--text);min-width:26px;text-align:center;">11px</span>
                  <input type="range" id="grid-zoom-slider" min="7" max="18" step="0.5" value="11"
                    oninput="applyGridZoom(this.value, false)"
                    style="width:70px;cursor:pointer;accent-color:var(--accent);height:3px;appearance:none;-webkit-appearance:none;background:linear-gradient(to left, var(--accent) 0%, var(--border) 0%);border-radius:2px;outline:none;">
                </div>
                <div style="width:1px;height:20px;background:var(--border);"></div>
                <button onclick="stepGridZoom(0.5, false)" style="border:none;background:none;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);line-height:1;transition:background 0.15s;" onmouseover="this.style.background='rgba(0,0,0,0.06)'" onmouseout="this.style.background='none'" title="הגדל">+</button>
              </div>

              <button class="btn btn-outline btn-sm" onclick="fitGridToScreen(false)" title="התאם לרוחב המסך" style="font-size:12px;">⬜ התאם</button>
              <button class="btn btn-outline btn-sm" onclick="openGridFullscreen()" title="מסך מלא" style="font-size:14px;padding:6px 10px;">⛶ מסך מלא</button>
              <button class="btn btn-success btn-sm" onclick="copyGridToExcel()" title="העתקה לאקסל" style="font-size:12px;gap:5px;">📋 העתק לאקסל</button>
            </div>
          </div>

          <div id="grid-section">
            <!-- Search bar -->
            <div style="padding:10px 0 4px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <select id="grid-search-type" onchange="renderCeoWorkersGrid(false)" style="border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:12px;background:var(--bg3);color:var(--text);cursor:pointer;">
                <option value="name">🔎 חיפוש לפי שם</option>
                <option value="idpassport" selected>🪪 חיפוש לפי ת"ז / דרכון</option>
              </select>
              <input type="text" id="grid-search-input" placeholder="הקלד לחיפוש..." oninput="renderCeoWorkersGrid(false)"
                style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:13px;background:white;color:var(--text);min-width:180px;font-family:inherit;">
              <span id="grid-search-count" style="font-size:12px;color:var(--text2);"></span>
            </div>

            <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;" id="grid-scroll-container">
              <div id="workers-grid-wrap"></div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:16px;">
          <div class="card-header">
            <div class="card-title">🔑 ניהול סיסמת חתימה</div>
          </div>
          <p style="color:var(--text2);font-size:13px;margin-bottom:14px;">קבע את הסיסמה שמנהל האתר ישתמש בה לאישור דוחות שעות</p>

          <!-- Current password display -->
          <div style="background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px;">
            <div style="font-size:12px;color:var(--text2);margin-bottom:8px;font-weight:600;">סיסמה נוכחית:</div>
            <div style="display:flex;align-items:center;gap:8px;">
              <span id="current-sig-pass-display" style="font-family:monospace;font-size:15px;letter-spacing:3px;background:white;border:1px solid var(--border);border-radius:6px;padding:6px 14px;min-width:160px;color:var(--text);">••••••••</span>
              <button onclick="toggleCurrentSigPass()" id="current-sig-pass-eye" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;cursor:pointer;font-size:14px;" title="הצג/הסתר">👁️</button>
            </div>
          </div>

          <!-- Set new password -->
          <div style="font-size:12px;color:var(--text2);margin-bottom:8px;font-weight:600;">הגדר סיסמה חדשה:</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <input type="password" id="sigPasswordInput" class="search-input" style="width:200px;" placeholder="סיסמת חתימה חדשה">
            <button class="btn btn-success btn-sm" onclick="setSigPassword()">💾 שמור סיסמה</button>
          </div>
        </div>
      </div>

      <!-- CEO Tasks -->
      <div class="page" id="page-ceo-tasks">
        <div class="card-header" style="margin-bottom:20px;flex-wrap:nowrap;gap:8px;">
          <div class="card-title" style="font-size:18px;white-space:nowrap;">📋 ניהול משימות</div>
          <button class="btn btn-primary btn-sm" onclick="openAddTask('ceo')">+ הוסף משימה</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
          <div class="tabs" style="margin-bottom:0;flex:1;">
            <div class="tab active" onclick="filterTasks('all',this)">הכל</div>
            <div class="tab" onclick="filterTasks('open',this)">פתוחות</div>
            <div class="tab" onclick="filterTasks('done',this)">הושלמו</div>
            <div class="tab" onclick="filterTasks('high',this)">דחוף</div>
          </div>
          <select id="ceo-task-employee-filter" onchange="renderCeoTasks()" style="border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:13px;background:var(--bg3);color:var(--text);cursor:pointer;font-family:inherit;">
            <option value="">👥 כל העובדים</option>
          </select>
        </div>
        <div class="tasks-grid" id="ceo-tasks-grid"></div>
      </div>

      <!-- CEO Credentials -->
      <div class="page" id="page-ceo-credentials">
        <div class="card" style="margin-bottom:20px;padding:20px;background:linear-gradient(135deg,#fdf5e8,#fef9f0);border-color:var(--yellow);">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">🔑</div>
            <div>
              <div style="font-size:17px;font-weight:800;">פרטי כניסה של הצוות</div>
              <div style="font-size:13px;color:var(--text2);">שמות משתמש וסיסמאות של כל העובדים והפועלים בחברה שלך</div>
            </div>
          </div>
          <div style="margin-top:12px;padding:10px 14px;background:rgba(232,196,106,0.2);border-radius:8px;font-size:12px;color:#a07820;display:flex;align-items:center;gap:8px;">
            🔒 <span>המידע הזה רגיש — שמור אותו בסודיות ואל תשתף עם גורמים לא מורשים</span>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">💼 עובדים</div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>שם</th><th>שם משתמש</th><th>ת"ז / דרכון</th><th>סיסמה</th><th>עריכה</th></tr></thead>
              <tbody id="ceo-emp-creds-table"></tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">🔧 פועלים</div>
          </div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>שם</th><th>שם משתמש</th><th>ת"ז / דרכון</th><th>סיסמה</th><th>עריכה</th></tr></thead>
              <tbody id="ceo-worker-creds-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CEO Notes -->
      <div class="page" id="page-ceo-notes">
        <div class="card">
          <div class="card-header">
            <div class="card-title">📝 הערות אישיות - מנכ"ל</div>
            <button class="btn btn-success btn-sm" onclick="saveNotes('ceo')">💾 שמור</button>
          </div>
          <textarea class="notes-area" id="ceo-notes" placeholder="כתוב כאן הערות עסקיות, תזכורות, ודברים חשובים..." rows="12"></textarea>
        </div>
        <div id="ceo-quick-notes" style="margin-top:16px;"></div>
        <button class="btn btn-outline btn-sm" onclick="addQuickNote('ceo')" style="margin-top:10px;">+ הוסף פתק מהיר</button>
      </div>

      <!-- CEO AI Assistant -->
      <div class="page" id="page-ceo-ai">
        <div style="display:flex;flex-direction:column;height:calc(100vh - 140px);gap:0;">
          <!-- Header -->
          <div class="card" style="margin-bottom:12px;padding:16px 20px;background:linear-gradient(135deg,#f0ebff,#e8f0ff);border-color:#c8b8f0;flex-shrink:0;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#7b63d8,#5a9bc8);display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 12px rgba(123,99,216,0.3);">🤖</div>
              <div>
                <div style="font-size:17px;font-weight:800;">עוזר AI</div>
                <div style="font-size:12px;color:var(--text2);">שאל שאלות על החברה שלך, קבל תובנות, ובצע פעולות</div>
              </div>
              <button onclick="clearAiChat()" class="btn btn-outline btn-sm" style="margin-right:auto;font-size:11px;">🗑️ נקה שיחה</button>
            </div>
          </div>

          <!-- Suggested prompts -->
          <div id="ai-suggestions" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;flex-shrink:0;">
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">📊 כמה פועלים יש לי?</button>
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">⏰ מי עבד הכי הרבה שעות החודש?</button>
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">📋 כמה משימות פתוחות יש?</button>
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">✅ מי עוד לא חתם על דוח שעות?</button>
            <button onclick="sendAiSuggestion(this.textContent)" class="btn btn-outline btn-sm" style="font-size:11px;border-color:#c8b8f0;color:#7b63d8;">🔥 אילו משימות דחופות יש?</button>
          </div>

          <!-- Chat messages -->
          <div id="ai-chat-messages" style="flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:12px;padding:4px 2px;min-height:0;">
            <div id="ai-welcome-msg" style="text-align:center;padding:32px 16px;color:var(--text2);">
              <div style="font-size:40px;margin-bottom:12px;">🤖</div>
              <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:6px;">שלום! אני העוזר החכם שלך</div>
              <div style="font-size:13px;">אני יכול לענות על שאלות על הפועלים, העובדים, המשימות, ושעות העבודה בחברה שלך.<br>אני יכול גם לבצע פעולות כמו יצירת משימות ועוד.</div>
            </div>
          </div>

          <!-- Input area -->
          <div style="display:flex;gap:8px;align-items:flex-end;margin-top:10px;flex-shrink:0;">
            <textarea id="ai-input" placeholder="שאל שאלה או בקש לבצע פעולה..." rows="2"
              style="flex:1;border:2px solid #c8b8f0;border-radius:12px;padding:10px 14px;font-family:inherit;font-size:13px;resize:none;outline:none;line-height:1.5;transition:border-color 0.2s;"
              onfocus="this.style.borderColor='#7b63d8'" onblur="this.style.borderColor='#c8b8f0'"
              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAiMessage();}"></textarea>
            <button onclick="sendAiMessage()" id="ai-send-btn" style="background:linear-gradient(135deg,#7b63d8,#5a9bc8);color:white;border:none;border-radius:12px;padding:10px 18px;cursor:pointer;font-size:18px;height:46px;flex-shrink:0;box-shadow:0 4px 12px rgba(123,99,216,0.3);transition:opacity 0.2s;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">➤</button>
          </div>
          <div style="font-size:10px;color:var(--text3);text-align:center;margin-top:6px;flex-shrink:0;">Enter לשליחה • Shift+Enter לשורה חדשה</div>
        </div>
      </div>


      <!-- ════════════════ CEO REQUESTS PAGE ════════════════ -->
      <div class="page" id="page-ceo-requests">
        <div class="card" style="margin-bottom:16px;padding:20px;background:linear-gradient(135deg,#f0ebff,#e8f0ff);border-color:#c8b8f0;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">📬</div>
            <div style="flex:1;">
              <div style="font-size:17px;font-weight:800;">פניות ובקשות פועלים</div>
              <div style="font-size:13px;color:var(--text2);">כל הפניות מהפועלים שלך — ציוד חסר, בטיחות, בקשות שונות</div>
            </div>
            <span id="ceo-requests-badge" style="background:#e88fa0;color:white;font-size:13px;font-weight:800;padding:4px 12px;border-radius:20px;display:none;"></span>
          </div>
        </div>
        <div class="card" style="padding:14px 18px;margin-bottom:14px;">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <span style="font-size:13px;color:var(--text2);font-weight:600;">סנן לפי סטטוס:</span>
            <select id="ceo-req-filter" onchange="renderCeoRequests()" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:7px 12px;font-size:13px;color:var(--text);font-family:inherit;cursor:pointer;outline:none;">
              <option value="all">📋 הכל</option>
              <option value="pending">⏳ ממתין לטיפול</option>
              <option value="inprogress">🔄 בטיפול</option>
              <option value="done">✅ טופל</option>
            </select>
          </div>
        </div>
        <div id="ceo-requests-container"></div>
      </div>

      <!-- ════════════════ EMPLOYEE PAGES ════════════════ -->
      <!-- Employee Dashboard -->
      <div class="page" id="page-emp-dashboard">
        <div class="card" style="background:linear-gradient(135deg,#e8f5ef,#f0f8e8);border-color:var(--green);margin-bottom:20px;padding:24px;">
          <div style="font-size:14px;color:var(--text2);">שלום,</div>
          <div style="font-size:26px;font-weight:800;" id="emp-welcome-name">עובד</div>
          <div style="color:var(--text2);font-size:13px;" id="emp-company-label">חברה</div>
        </div>
        <div class="stats-grid">
          <div class="stat-card yellow">
            <div class="stat-header"><div class="stat-icon">📋</div><div class="stat-label">משימות פתוחות</div></div>
            <div class="stat-value" id="emp-stat-open">0</div>
          </div>
          <div class="stat-card green">
            <div class="stat-header"><div class="stat-icon">✅</div><div class="stat-label">הושלמו</div></div>
            <div class="stat-value" id="emp-stat-done">0</div>
          </div>
          <div class="stat-card red">
            <div class="stat-header"><div class="stat-icon">🔥</div><div class="stat-label">דחופות</div></div>
            <div class="stat-value" id="emp-stat-urgent">0</div>
          </div>
          <div class="stat-card purple">
            <div class="stat-header"><div class="stat-icon">📅</div><div class="stat-label">להיום</div></div>
            <div class="stat-value" id="emp-stat-today">0</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">🔥 משימות דחופות</div>
          </div>
          <div id="emp-urgent-tasks"></div>
        </div>
      </div>

      <!-- Employee Tasks -->
      <div class="page" id="page-emp-tasks">
        <div class="card-header" style="margin-bottom:20px;">
          <div class="card-title" style="font-size:18px;">📋 המשימות שלי</div>
          <button class="btn btn-primary btn-sm" onclick="openAddTask('emp')">+ הוסף משימה</button>
        </div>
        <div class="tabs">
          <div class="tab active" onclick="filterEmpTasks('all',this)">הכל</div>
          <div class="tab" onclick="filterEmpTasks('open',this)">פתוחות</div>
          <div class="tab" onclick="filterEmpTasks('done',this)">הושלמו</div>
          <div class="tab" onclick="filterEmpTasks('high',this)">דחוף</div>
          <div class="tab" onclick="filterEmpTasks('mine',this)">שיצרתי</div>
        </div>
        <div class="tasks-grid" id="emp-tasks-grid"></div>
      </div>

      <!-- Employee Notes -->
      <div class="page" id="page-emp-notes">
        <div class="card">
          <div class="card-header">
            <div class="card-title">📝 הערות אישיות</div>
            <button class="btn btn-success btn-sm" onclick="saveNotes('emp')">💾 שמור</button>
          </div>
          <textarea class="notes-area" id="emp-notes" placeholder="כתוב כאן הערות, תזכורות, ורעיונות..." rows="12"></textarea>
        </div>
        <div id="emp-quick-notes" style="margin-top:16px;"></div>
        <button class="btn btn-outline btn-sm" onclick="addQuickNote('emp')" style="margin-top:10px;">+ הוסף פתק מהיר</button>
      </div>

      <!-- Employee Calendar -->
      <div class="page" id="page-emp-calendar">
        <div class="card">
          <div class="card-header">
            <div class="card-title">📅 לוח משימות לפי תאריך</div>
          </div>
          <div id="emp-calendar-content" style="color:var(--text2);text-align:center;padding:40px;">
            לוח זמנים יוצג כאן<br>
            <div style="margin-top:20px;" id="emp-upcoming-tasks"></div>
          </div>
        </div>
      </div>

      <!-- ════════════════ WORKER PAGES ════════════════ -->
      <!-- Worker Hours -->
      <div class="page" id="page-worker-hours">
        <div class="card" style="margin-bottom:20px;padding:20px;background:linear-gradient(135deg,#fdf0e8,#fdf5e8);border-color:var(--orange);">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
            <div>
              <div style="font-size:20px;font-weight:800;" id="worker-name-display">שם הפועל</div>
              <div style="color:var(--text2);font-size:13px;" id="worker-company-display">חברה</div>
            </div>
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:nowrap;">
              <button class="btn btn-outline btn-sm" onclick="changeWorkerMonth(-1)" style="padding:6px 10px;white-space:nowrap;">◀</button>
              <div id="worker-month-label" style="font-size:14px;font-weight:700;min-width:100px;text-align:center;white-space:nowrap;"></div>
              <button class="btn btn-outline btn-sm" onclick="changeWorkerMonth(1)" style="padding:6px 10px;white-space:nowrap;">▶</button>
            </div>
          </div>
          <div style="margin-top:14px;display:flex;gap:20px;flex-wrap:wrap;">
            <div><div style="font-size:26px;font-weight:800;color:#b06830;" id="worker-total-hours">0</div><div style="font-size:12px;color:var(--text2);">סה"כ שעות</div></div>
            <div><div style="font-size:26px;font-weight:800;color:#a07820;" id="worker-work-days">0</div><div style="font-size:12px;color:var(--text2);">ימי עבודה</div></div>
            <div><div style="font-size:26px;font-weight:800;color:#3a9a7a;" id="worker-avg-hours">0</div><div style="font-size:12px;color:var(--text2);">ממוצע יומי</div></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header" style="flex-wrap:wrap;gap:8px;">
            <div class="card-title" style="white-space:nowrap;">📊 דוח שעות חודשי</div>
            <div style="display:flex;gap:8px;flex-wrap:nowrap;">
              <button class="btn btn-outline btn-sm" onclick="exportHours()" style="white-space:nowrap;">📥 ייצוא</button>
              <button class="btn btn-success btn-sm" id="worker-save-btn" onclick="saveWorkerHours()" style="white-space:nowrap;">💾 שמור</button>
            </div>
          </div>
          <div id="worker-locked-banner" style="display:none;background:#fde8ec;border:1px solid #e88fa0;border-radius:10px;padding:12px 16px;margin-bottom:14px;color:#c0506a;font-size:13px;font-weight:600;">
            🔒 הדוח נחתם על ידי מנהל האתר — לא ניתן לערוך שעות. לשינוי, פנה למנהל האתר לביטול החתימה.
          </div>
          <div class="table-wrap" style="-webkit-overflow-scrolling:touch;">
            <table class="hours-table" style="min-width:320px;">
              <thead><tr><th>תאריך</th><th>יום</th><th>הגעה</th><th>יציאה</th><th>שעות</th><th>הערות</th></tr></thead>
              <tbody id="worker-hours-table"></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:16px;">
          <div class="card-header">
            <div class="card-title">✍️ אישור מנהל אתר</div>
          </div>
          <div id="sig-status-area">
            <!-- Unsigned state -->
            <div class="sig-box" id="sig-unsigned">
              <div style="font-size:36px;margin-bottom:10px;">📋</div>
              <div style="color:var(--text2);margin-bottom:18px;font-size:14px;">הדוח טרם אושר על ידי מנהל האתר</div>

              <!-- Sign full month -->
              <div id="sig-full-month-block" style="background:#f0f7ff;border:1px solid #c8dff5;border-radius:10px;padding:16px;margin-bottom:12px;text-align:right;">
                <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:#4a88b8;">✅ חתימה על כל החודש</div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                  <input type="password" id="sigPasswordVerify" class="search-input" placeholder="סיסמת מנהל אתר" style="width:190px;flex:1;min-width:0;">
                  <button class="btn btn-primary btn-sm" onclick="signReport('full')">✅ חתום על כל החודש</button>
                </div>
              </div>

              <!-- Sign specific days -->
              <div style="background:#f5f0ff;border:1px solid #d8c8f5;border-radius:10px;padding:16px;text-align:right;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:8px;">
                  <div style="font-size:13px;font-weight:700;color:#7b63d8;">📅 חתימה על ימים ספציפיים</div>
                  <button class="btn btn-sm" style="background:#e8e0ff;color:#7b63d8;border:1px solid #d8c8f5;font-size:11px;padding:5px 10px;" onclick="setSignToday()">📌 סמן להיום</button>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:13px;font-weight:700;color:#7b63d8;white-space:nowrap;min-width:24px;">מ:</span>
                    <input type="date" id="sigDayFrom" class="search-input" style="flex:1;min-width:0;">
                  </div>
                  <div style="display:flex;align-items:center;gap:8px;">
                    <span style="font-size:13px;font-weight:700;color:#7b63d8;white-space:nowrap;min-width:24px;">עד:</span>
                    <input type="date" id="sigDayTo" class="search-input" style="flex:1;min-width:0;">
                  </div>
                </div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;">
                  <input type="password" id="sigPasswordVerifyPartial" class="search-input" placeholder="סיסמת מנהל אתר" style="width:190px;flex:1;min-width:0;">
                  <button class="btn btn-sm" style="background:#7b63d8;color:white;" onclick="signReport('partial')">📅 חתום על טווח ימים</button>
                </div>
              </div>
            </div>

            <!-- Signed state -->
            <div class="sig-box" id="sig-signed" style="display:none;">
              <div style="margin-bottom:12px;">
                <div class="sig-stamp">✓ אושר</div>
              </div>
              <div style="color:#3a9a7a;font-weight:600;margin-top:14px;font-size:14px;" id="sig-info">אושר על ידי מנהל האתר</div>
              <div id="sig-partial-info" style="color:#7b63d8;font-size:12px;margin-top:6px;display:none;"></div>
              <!-- Note when partially signed — can still add more -->
              <div id="sig-partial-note" style="display:none;background:#f5f0ff;border:1px solid #d8c8f5;border-radius:8px;padding:10px 14px;margin-top:12px;font-size:12px;color:#7b63d8;">
                📅 ניתן להמשיך ולחתום על ימים נוספים באמצעות הטופס למטה
              </div>
              <!-- Unsign section -->
              <div style="margin-top:16px;background:#fff5f5;border:1px solid #f0c0c8;border-radius:10px;padding:14px;">
                <div style="font-size:12px;color:#c0506a;margin-bottom:10px;">לביטול החתימה, יש להזין את סיסמת מנהל האתר:</div>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                  <input type="password" id="unsignPassword" class="search-input" placeholder="סיסמת מנהל אתר" style="width:190px;flex:1;min-width:0;">
                  <button class="btn btn-danger btn-sm" onclick="unsignReport()">❌ בטל אישור</button>
                </div>
              </div>
            </div>

            <!-- Partial signed indicator (days) -->
            <div id="sig-days-list" style="margin-top:12px;display:none;">
              <div style="font-size:12px;font-weight:700;color:#7b63d8;margin-bottom:6px;">📅 תאריכים חתומים:</div>
              <div id="sig-days-tags" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Worker Requests -->
      <div class="page" id="page-worker-requests">
        <div class="card" style="margin-bottom:16px;padding:20px;background:linear-gradient(135deg,#f0ebff,#e8f0ff);border-color:#c8b8f0;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="font-size:32px;">📬</div>
            <div>
              <div style="font-size:17px;font-weight:800;">פניות ובקשות</div>
              <div style="font-size:13px;color:var(--text2);">שלח בקשה למנכ"ל — ציוד חסר, בעיה, הצעה או כל פנייה אחרת</div>
            </div>
          </div>
        </div>

        <!-- New request form -->
        <div class="card" style="margin-bottom:16px;">
          <div class="card-header">
            <div class="card-title">✉️ פנייה חדשה</div>
          </div>
          <div class="form-group">
            <label>סוג הפנייה</label>
            <select id="request-type" style="width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-family:'Heebo',sans-serif;font-size:14px;color:var(--text);outline:none;">
              <option value="equipment">🔧 ציוד חסר</option>
              <option value="safety">⛑️ בטיחות</option>
              <option value="schedule">📅 לוח זמנים</option>
              <option value="payment">💰 תשלום / שכר</option>
              <option value="other">💬 כללי / אחר</option>
            </select>
          </div>
          <div class="form-group">
            <label>תוכן הפנייה</label>
            <textarea id="request-text" class="notes-area" rows="4" placeholder="תאר את הבעיה, הבקשה, או מה חסר לך..."></textarea>
          </div>
          <button class="btn btn-primary" onclick="submitWorkerRequest()" style="width:100%;justify-content:center;">📤 שלח פנייה</button>
        </div>

        <!-- Previous requests by this worker -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">📋 הפניות שלי</div>
          </div>
          <div id="worker-requests-list"></div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- Fullscreen Grid Overlay -->
<div id="gridFullscreenOverlay" style="display:none;position:fixed;inset:0;background:rgba(20,30,50,0.82);z-index:9999;padding:20px;box-sizing:border-box;backdrop-filter:blur(4px);">
  <div style="background:var(--card);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,0.3);height:100%;display:flex;flex-direction:column;overflow:hidden;">
    <!-- Header -->
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid var(--border);flex-shrink:0;">
      <div style="display:flex;align-items:center;gap:12px;">
        <span style="font-size:20px;">📅</span>
        <div>
          <div style="font-size:17px;font-weight:800;" id="fs-grid-title">לוח שעות חודשי</div>
          <div style="font-size:12px;color:var(--text2);" id="fs-grid-subtitle"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-outline btn-sm" onclick="changeGridMonthFS(-1)">▶ חודש קודם</button>
        <span id="fs-grid-month-label" style="font-size:14px;font-weight:700;min-width:110px;text-align:center;"></span>
        <button class="btn btn-outline btn-sm" onclick="changeGridMonthFS(1)">חודש הבא ◀</button>

        <!-- FS Zoom control -->
        <div style="display:flex;align-items:center;gap:0;background:var(--bg3);border:1px solid var(--border);border-radius:10px;overflow:hidden;">
          <button onclick="stepGridZoom(-0.5, true)" style="border:none;background:none;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);line-height:1;transition:background 0.15s;" onmouseover="this.style.background='rgba(0,0,0,0.06)'" onmouseout="this.style.background='none'" title="הקטן">−</button>
          <div style="width:1px;height:20px;background:var(--border);"></div>
          <div style="display:flex;align-items:center;gap:4px;padding:0 8px;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="color:var(--text3);flex-shrink:0;"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            <span id="fs-grid-zoom-label" style="font-size:12px;font-weight:600;color:var(--text);min-width:26px;text-align:center;">13px</span>
            <input type="range" id="fs-grid-zoom-slider" min="7" max="22" step="0.5" value="13"
              oninput="applyGridZoom(this.value, true)"
              style="width:80px;cursor:pointer;accent-color:var(--accent);height:3px;appearance:none;-webkit-appearance:none;background:linear-gradient(to left, var(--accent) 0%, var(--border) 0%);border-radius:2px;outline:none;">
          </div>
          <div style="width:1px;height:20px;background:var(--border);"></div>
          <button onclick="stepGridZoom(0.5, true)" style="border:none;background:none;padding:6px 10px;cursor:pointer;font-size:14px;color:var(--text2);line-height:1;transition:background 0.15s;" onmouseover="this.style.background='rgba(0,0,0,0.06)'" onmouseout="this.style.background='none'" title="הגדל">+</button>
        </div>
        <button class="btn btn-outline btn-sm" onclick="fitGridToScreen(true)" style="font-size:12px;">⬜ התאם</button>
        <button onclick="closeGridFullscreen()" style="background:#f0f0f0;border:none;border-radius:50%;width:34px;height:34px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-right:8px;" title="סגור">✕</button>
      </div>
    </div>
    <!-- Legend + FS Search -->
    <div style="padding:8px 24px;border-bottom:1px solid var(--border);display:flex;gap:12px;align-items:center;flex-wrap:wrap;flex-shrink:0;">
      <span style="font-size:11px;color:var(--text2);font-weight:600;">מקרא:</span>
      <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#ddeeff;border-radius:3px;display:inline-block;border:1px solid #aaccee;"></span>היום</span>
      <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#ffe8ea;border-radius:3px;display:inline-block;border:1px solid #f0c0c4;"></span>סוף שבוע</span>
      <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:#f0fff4;border-radius:3px;display:inline-block;border:1px solid #a8e0b8;"></span>יום חתום ✓</span>
      <span style="font-size:11px;display:flex;align-items:center;gap:4px;"><span style="width:14px;height:14px;background:white;border-radius:3px;display:inline-block;border:1px solid var(--border);color:#3366aa;font-weight:700;text-align:center;line-height:14px;font-size:9px;">8</span>שעות עבודה</span>
      <!-- Search in FS -->
      <div style="display:flex;gap:6px;align-items:center;margin-right:auto;">
        <select id="fs-grid-search-type" onchange="renderCeoWorkersGrid(true)" style="border:1px solid var(--border);border-radius:8px;padding:4px 8px;font-size:11px;background:var(--bg3);color:var(--text);cursor:pointer;">
          <option value="name">🔎 שם</option>
          <option value="idpassport" selected>🪪 ת"ז / דרכון</option>
        </select>
        <input type="text" id="fs-grid-search-input" placeholder="חיפוש..." oninput="renderCeoWorkersGrid(true)"
          style="border:1px solid var(--border);border-radius:8px;padding:4px 10px;font-size:12px;background:white;color:var(--text);width:150px;font-family:inherit;">
        <span id="fs-grid-search-count" style="font-size:11px;color:var(--text2);white-space:nowrap;"></span>
        <button class="btn btn-success btn-sm" onclick="copyGridToExcelFS()" style="font-size:11px;padding:4px 10px;">📋 העתק לאקסל</button>
      </div>
      <span style="font-size:11px;color:var(--text3);">לחץ ESC או ✕ לסגירה</span>
    </div>
    <!-- Grid content -->
    <div style="flex:1;overflow:auto;padding:16px 24px;">
      <div id="fs-workers-grid-wrap"></div>
    </div>
  </div>
</div>


<div class="modal-overlay" id="modalOverlay">
  <div class="modal" id="modalContent">
    <button class="modal-close" onclick="closeModal()">✕</button>
    <div id="modalBody"></div>
  </div>
</div>

<script>
// ═══════════════════════════════════════════
// DATA
// ═══════════════════════════════════════════
// ═══════════════════════════════════════════════════════════════
// SUPABASE BRIDGE v2 — STANDALONE (ללא Next.js / שרת)
// ═══════════════════════════════════════════════════════════════
// כל הקריאות ישירות ל-Supabase JS Client.
// הגדר את המשתנים הבאים:
//   SUPABASE_URL  — https://xxx.supabase.co
//   SUPABASE_ANON — מפתח anon public
// ─────────────────────────────────────────────────────────────

// !! החלף את הערכים האלו בערכים האמיתיים שלך מ-Supabase Dashboard !!
const SUPABASE_URL  = '__SUPABASE_URL__';
const SUPABASE_ANON = '__SUPABASE_ANON_KEY__';

const HAS_SUPABASE = Boolean(
  SUPABASE_URL  && SUPABASE_URL  !== '__SUPABASE_URL__' &&
  SUPABASE_ANON && SUPABASE_ANON !== '__SUPABASE_ANON_KEY__'
);

// Initialize Supabase client
const sb = HAS_SUPABASE
  ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: true, autoRefreshToken: true }
    })
  : null;

if (!HAS_SUPABASE) {
  console.log('📦 WorkFlow Pro: מצב דמו — אין Supabase מוגדר');
}

// ── Session storage ───────────────────────────────────────────
// שמור session ב-sessionStorage כדי שה-UI יידע מי מחובר
let _sbSession = null;

function getSbSession() {
  if (_sbSession) return _sbSession;
  const stored = sessionStorage.getItem('wfp_user');
  if (stored) { try { return JSON.parse(stored); } catch(e) {} }
  return null;
}

function setSbSession(user) {
  _sbSession = user;
  if (user) sessionStorage.setItem('wfp_user', JSON.stringify(user));
  else sessionStorage.removeItem('wfp_user');
}

// ── Map DB row → app object ───────────────────────────────────
function mapUser(u) {
  return {
    id:           u.id,
    username:     u.username,
    password:     u.password_hash || '',
    name:         u.name,
    role:         u.role,
    company:      u.company_id,
    avatar:       u.avatar        || '💼',
    avatarColor:  u.avatar_color  || '#60a5fa',
    idType:       u.id_type       || 'id',
    idNumber:     u.id_number     || '',
    ceoInterface: u.ceo_interface || false,
    fieldWorker:  u.field_worker  || false,
  };
}

function mapCompany(c, signedMap = {}) {
  return {
    id:          c.id,
    name:        c.name,
    field:       c.field        || '',
    emoji:       c.emoji        || '🏢',
    color:       c.color        || '#6c63ff',
    sigPassword: c.sig_password || '',
    signed:      signedMap[c.id] || {},
  };
}

function mapTask(t) {
  return {
    id:           t.id,
    title:        t.title,
    desc:         t.description || '',
    assignedTo:   t.assigned_to,
    assignedBy:   t.assigned_by,
    company:      t.company_id,
    priority:     t.priority    || 'medium',
    status:       t.status      || 'open',
    dueDate:      t.due_date    || '',
    createdByEmp: t.created_by_emp || false,
    subtasks:     (t.subtasks || []).map(s => ({
      id: s.id, taskId: s.task_id, title: s.title, done: s.done,
    })),
  };
}

function mapRequest(r) {
  return {
    id:         r.id,
    workerId:   r.worker_id,
    workerName: r.worker_name,
    company:    r.company_id,
    type:       r.type,
    text:       r.text,
    date:       r.created_at
      ? new Date(r.created_at).toLocaleDateString('he-IL')
      : new Date().toLocaleDateString('he-IL'),
    status:     r.status || 'pending',
    reply:      r.reply  || '',
  };
}

function buildHoursMap(rows) {
  const map = {};
  (rows || []).forEach(row => {
    const d = new Date(row.work_date);
    const key = `${row.worker_id}-${d.getFullYear()}-${d.getMonth()}`;
    if (!map[key]) map[key] = {};
    map[key][d.getDate()] = {
      hours: String(row.hours || ''),
      start: row.start_time ? row.start_time.slice(0,5) : '',
      end:   row.end_time   ? row.end_time.slice(0,5)   : '',
      note:  row.note || '',
    };
  });
  return map;
}

function buildSignedMap(rows) {
  // Returns: { companyId: { "workerId-year-month": { type, days, date } } }
  const map = {};
  (rows || []).forEach(sig => {
    if (!map[sig.company_id]) map[sig.company_id] = {};
    const key = `${sig.worker_id}-${sig.year}-${sig.month}`;
    map[sig.company_id][key] = {
      type: sig.type,
      days: sig.days || null,
      date: new Date(sig.signed_at).toLocaleDateString('he-IL'),
    };
  });
  return map;
}

// ── Loading overlay ───────────────────────────────────────────
function showLoadingOverlay(show) {
  let overlay = document.getElementById('sb-loading-overlay');
  if (!overlay && show) {
    overlay = document.createElement('div');
    overlay.id = 'sb-loading-overlay';
    overlay.style.cssText = 'position:fixed;inset:0;background:rgba(255,255,255,0.95);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px;';
    overlay.innerHTML = `
      <div style="font-size:44px;">⚡</div>
      <div style="font-size:17px;font-weight:800;color:#1e293b;">WorkFlow Pro</div>
      <div style="font-size:13px;color:#64748b;">מתחבר ל-Supabase...</div>
      <div style="width:220px;height:4px;background:#e2e8f0;border-radius:4px;overflow:hidden;">
        <div style="height:100%;background:linear-gradient(90deg,#6c63ff,#a78bfa);border-radius:4px;animation:sbLoad 1.4s ease-in-out infinite;"></div>
      </div>`;
    document.head.insertAdjacentHTML('beforeend',
      '<style>@keyframes sbLoad{0%{width:0%;margin-right:100%}50%{width:55%;margin-right:0}100%{width:0%;margin-right:100%}}</style>');
    document.body.appendChild(overlay);
  } else if (overlay && !show) {
    overlay.style.opacity = '0';
    overlay.style.transition = 'opacity 0.3s';
    setTimeout(() => overlay?.remove(), 300);
  }
}

// ── bcrypt-lite: verify plain-text OR bcrypt hash ─────────────
// For demo/dev: passwords stored as plain text in seed data
// For production: passwords stored as bcrypt hashes (server-side)
// Since we're standalone, we verify via Supabase Edge Function or
// fall back to plain-text comparison for demo seed data
async function verifyLogin(username, password) {
  if (!sb) return null;
  const { data: user, error } = await sb
    .from('users')
    .select('*')
    .eq('username', username.trim().toLowerCase())
    .single();
  if (error || !user) return null;
  // Simple comparison: works with both plain-text (demo) and hashed (prod)
  // In production, passwords are bcrypt hashes — they won't match plain text
  // To support bcrypt in standalone mode, use a Supabase Edge Function for auth
  const hash = user.password_hash || '';
  const matches = hash.startsWith('$2')
    ? await bcryptVerify(password, hash)  // bcrypt hash
    : hash === password;                  // plain text (demo)
  if (!matches) return null;
  return user;
}

// Lightweight bcrypt verify using SubtleCrypto (for browser)
// Returns true if password matches bcrypt hash
// Note: full bcrypt in browser requires a JS library — we use a CDN-loaded one
async function bcryptVerify(password, hash) {
  // If dcrypt library is loaded (optional), use it
  if (window.dcrypt?.check) return window.dcrypt.check(password, hash);
  // Fallback: can't verify bcrypt in browser without library → deny
  console.warn('bcrypt verification not available in standalone mode');
  return false;
}

// ════════════════════════════════════════════════════════════════
// INIT — Load all data from Supabase on startup
// ════════════════════════════════════════════════════════════════
async function initSupabaseData() {
  if (!HAS_SUPABASE) return; // demo mode — use DATA as-is

  showLoadingOverlay(true);
  try {
    // Check if user has an active session (from sessionStorage)
    const sessionUser = getSbSession();
    if (!sessionUser) {
      showLoadingOverlay(false);
      return; // Show login screen
    }

    await loadAndInjectData(sessionUser);
    showLoadingOverlay(false);
  } catch (err) {
    console.error('Supabase init error:', err);
    showLoadingOverlay(false);
    showToast('⚠️ שגיאה בטעינת נתונים — מצב דמו', 'error');
  }
}

async function loadAndInjectData(dbUser) {
  const companyId = dbUser.company_id;
  const role = dbUser.role;

  // 1. Companies
  let compQ = sb.from('companies').select('*').order('name');
  if (role !== 'admin' && companyId) compQ = compQ.eq('id', companyId);
  const { data: dbCompanies = [] } = await compQ;

  // 2. Users
  let usersQ = sb.from('users')
    .select('id,username,password_hash,name,role,company_id,avatar,avatar_color,id_type,id_number,ceo_interface,field_worker')
    .order('name');
  if (role !== 'admin' && companyId) usersQ = usersQ.eq('company_id', companyId);
  const { data: dbUsers = [] } = await usersQ;

  // 3. Tasks (with subtasks)
  let tasksQ = sb.from('tasks').select('*,subtasks(*)').order('created_at', { ascending: false });
  if (role === 'worker') {
    tasksQ = sb.from('tasks').select('*,subtasks(*)').eq('id', -1); // empty
  } else if (role === 'employee' && !dbUser.ceo_interface) {
    tasksQ = tasksQ.eq('assigned_to', dbUser.id);
  } else if (companyId) {
    tasksQ = tasksQ.eq('company_id', companyId);
  }
  const { data: dbTasks = [] } = await tasksQ;

  // 4. Requests
  let reqQ = sb.from('requests').select('*').order('created_at', { ascending: false });
  if (role === 'worker') reqQ = reqQ.eq('worker_id', dbUser.id);
  else if (companyId) reqQ = reqQ.eq('company_id', companyId);
  const { data: dbRequests = [] } = await reqQ;

  // 5. Worker hours (current + prev 2 months)
  const workers = dbUsers.filter(u => u.role === 'worker');
  const allHoursRows = [];
  const now = new Date();
  if (workers.length > 0) {
    const workerIds = workers.map(w => w.id);
    // Build date range: 3 months back
    let py = now.getFullYear(), pm = now.getMonth() - 2;
    if (pm < 0) { pm += 12; py--; }
    const startDate = `${py}-${String(pm+1).padStart(2,'0')}-01`;
    const { data: hoursRows = [] } = await sb.from('worker_hours')
      .select('*')
      .in('worker_id', workerIds)
      .gte('work_date', startDate);
    allHoursRows.push(...hoursRows);
  }

  // 6. Signatures
  let sigsRows = [];
  if (companyId) {
    const { data: sigs = [] } = await sb.from('signatures')
      .select('*')
      .eq('company_id', companyId);
    sigsRows = sigs;
  }

  // 7. Notes for current user
  const { data: noteRow } = await sb.from('notes')
    .select('*').eq('user_id', dbUser.id).single();

  // ── Inject into DATA ──
  const signedByCompany = buildSignedMap(sigsRows);
  DATA.users     = dbUsers.map(mapUser);
  DATA.companies = dbCompanies.map(c => mapCompany(c, signedByCompany));
  DATA.tasks     = dbTasks.map(mapTask);
  DATA.requests  = dbRequests.map(mapRequest);
  DATA.workerHours = buildHoursMap(allHoursRows);
  if (noteRow?.content) {
    DATA.notes[`${dbUser.role}-${dbUser.id}`] = noteRow.content;
  }

  // Auto-login
  const appUser = DATA.users.find(u => u.id === dbUser.id);
  if (appUser) login(appUser);
}

// ════════════════════════════════════════════════════════════════
// AUTH
// ════════════════════════════════════════════════════════════════
async function sbDoLogin(username, password) {
  if (!sb) return null;
  const dbUser = await verifyLogin(username, password);
  if (!dbUser) return null;
  setSbSession(dbUser);
  return dbUser;
}

async function sbDoLogout() {
  setSbSession(null);
}

// ════════════════════════════════════════════════════════════════
// WRITE WRAPPERS
// ════════════════════════════════════════════════════════════════

// ── Users ────────────────────────────────────────────────────
async function sbCreateUser(payload) {
  if (!sb) return { ok: false };
  const dbPayload = {
    username:     payload.username,
    password_hash: payload.password, // plain for demo; hash server-side for prod
    name:         payload.name,
    role:         payload.role,
    company_id:   payload.company_id,
    avatar:       payload.avatar       || '💼',
    avatar_color: payload.avatar_color || '#60a5fa',
    id_type:      payload.id_type      || 'id',
    id_number:    payload.id_number    || null,
    ceo_interface: false,
    field_worker:  false,
  };
  const { data, error } = await sb.from('users').insert(dbPayload).select('*').single();
  if (error) { console.error('sbCreateUser:', error); return { ok: false, data: error }; }
  DATA.users.push(mapUser(data));
  return { ok: true, data };
}

async function sbUpdateUser(id, updates) {
  if (!sb) return { ok: false };
  // Map camelCase → snake_case
  const dbUpdates = {};
  if (updates.name         !== undefined) dbUpdates.name         = updates.name;
  if (updates.username     !== undefined) dbUpdates.username     = updates.username;
  if (updates.role         !== undefined) dbUpdates.role         = updates.role;
  if (updates.company_id   !== undefined) dbUpdates.company_id   = updates.company_id;
  if (updates.id_type      !== undefined) dbUpdates.id_type      = updates.id_type;
  if (updates.id_number    !== undefined) dbUpdates.id_number    = updates.id_number;
  if (updates.avatar       !== undefined) dbUpdates.avatar       = updates.avatar;
  if (updates.avatar_color !== undefined) dbUpdates.avatar_color = updates.avatar_color;
  if (updates.ceo_interface !== undefined) dbUpdates.ceo_interface = updates.ceo_interface;
  if (updates.field_worker  !== undefined) dbUpdates.field_worker  = updates.field_worker;
  if (updates.password     !== undefined) dbUpdates.password_hash = updates.password;
  const { data, error } = await sb.from('users').update(dbUpdates).eq('id', id).select('*').single();
  if (error) { console.error('sbUpdateUser:', error); return { ok: false, data: error }; }
  const idx = DATA.users.findIndex(u => u.id === id);
  if (idx !== -1) DATA.users[idx] = mapUser(data);
  return { ok: true, data };
}

async function sbDeleteUser(id) {
  if (!sb) return { ok: false };
  const { error } = await sb.from('users').delete().eq('id', id);
  if (error) { console.error('sbDeleteUser:', error); return { ok: false }; }
  const idx = DATA.users.findIndex(u => u.id === id);
  if (idx !== -1) DATA.users.splice(idx, 1);
  return { ok: true };
}

// ── Tasks ────────────────────────────────────────────────────
async function sbCreateTask(payload) {
  if (!sb) return { ok: false };
  const { data, error } = await sb.from('tasks').insert({
    title:         payload.title,
    description:   payload.description || '',
    assigned_to:   payload.assigned_to,
    assigned_by:   payload.assigned_by || getSbSession()?.id,
    company_id:    payload.company_id,
    priority:      payload.priority    || 'medium',
    due_date:      payload.due_date    || null,
    created_by_emp: payload.created_by_emp || false,
  }).select('*').single();
  if (error) { console.error('sbCreateTask:', error); return { ok: false }; }
  const newTask = mapTask({ ...data, subtasks: [] });
  DATA.tasks.unshift(newTask);
  return { ok: true, data };
}

async function sbUpdateTask(id, updates) {
  if (!sb) return { ok: false };
  const dbUpdates = {};
  if (updates.title       !== undefined) dbUpdates.title       = updates.title;
  if (updates.description !== undefined) dbUpdates.description = updates.description;
  if (updates.status      !== undefined) dbUpdates.status      = updates.status;
  if (updates.priority    !== undefined) dbUpdates.priority    = updates.priority;
  if (updates.due_date    !== undefined) dbUpdates.due_date    = updates.due_date;
  if (updates.assigned_to !== undefined) dbUpdates.assigned_to = updates.assigned_to;
  const { data, error } = await sb.from('tasks').update(dbUpdates).eq('id', id)
    .select('*').single();
  if (error) { console.error('sbUpdateTask:', error); return { ok: false }; }
  // Keep subtasks from local state
  const idx = DATA.tasks.findIndex(t => t.id === id);
  if (idx !== -1) {
    const subs = DATA.tasks[idx].subtasks;
    DATA.tasks[idx] = mapTask({ ...data, subtasks: subs || [] });
  }
  return { ok: true, data };
}

async function sbDeleteTask(id) {
  if (!sb) return { ok: false };
  const { error } = await sb.from('tasks').delete().eq('id', id);
  if (error) { console.error('sbDeleteTask:', error); return { ok: false }; }
  const idx = DATA.tasks.findIndex(t => t.id === id);
  if (idx !== -1) DATA.tasks.splice(idx, 1);
  return { ok: true };
}

async function sbCreateSubtask(taskId, title) {
  if (!sb) return { ok: false };
  const { data, error } = await sb.from('subtasks')
    .insert({ task_id: taskId, title, done: false }).select('*').single();
  if (error) { console.error('sbCreateSubtask:', error); return { ok: false }; }
  const task = DATA.tasks.find(t => t.id === taskId);
  if (task) {
    if (!task.subtasks) task.subtasks = [];
    task.subtasks.push({ id: data.id, taskId, title, done: false });
  }
  return { ok: true, data };
}

async function sbToggleSubtask(taskId, subtaskId, done) {
  if (!sb) return { ok: false };
  const { error } = await sb.from('subtasks').update({ done }).eq('id', subtaskId);
  if (error) { console.error('sbToggleSubtask:', error); return { ok: false }; }
  const task = DATA.tasks.find(t => t.id === taskId);
  const sub = task?.subtasks?.find(s => s.id === subtaskId);
  if (sub) sub.done = done;
  return { ok: true };
}

async function sbDeleteSubtask(taskId, subtaskId) {
  if (!sb) return { ok: false };
  const { error } = await sb.from('subtasks').delete().eq('id', subtaskId);
  if (error) { console.error('sbDeleteSubtask:', error); return { ok: false }; }
  const task = DATA.tasks.find(t => t.id === taskId);
  if (task?.subtasks) task.subtasks = task.subtasks.filter(s => s.id !== subtaskId);
  return { ok: true };
}

// ── Companies ────────────────────────────────────────────────
async function sbCreateCompany(payload) {
  if (!sb) return { ok: false };
  const id = payload.name.toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9]/g,'');
  const { data, error } = await sb.from('companies').insert({
    id, name: payload.name, field: payload.field || 'כללי',
    emoji: payload.emoji || '🏢', color: payload.color || '#6c63ff',
  }).select('*').single();
  if (error) { console.error('sbCreateCompany:', error); return { ok: false, data: error }; }
  DATA.companies.push(mapCompany(data));
  return { ok: true, data };
}

async function sbUpdateCompany(id, updates) {
  if (!sb) return { ok: false };
  const dbUpdates = {};
  if (updates.name        !== undefined) dbUpdates.name        = updates.name;
  if (updates.field       !== undefined) dbUpdates.field       = updates.field;
  if (updates.emoji       !== undefined) dbUpdates.emoji       = updates.emoji;
  if (updates.color       !== undefined) dbUpdates.color       = updates.color;
  if (updates.sig_password !== undefined) dbUpdates.sig_password = updates.sig_password;
  const { error } = await sb.from('companies').update(dbUpdates).eq('id', id);
  if (error) { console.error('sbUpdateCompany:', error); return { ok: false }; }
  const c = DATA.companies.find(x => x.id === id);
  if (c) {
    if (updates.name)         c.name        = updates.name;
    if (updates.field)        c.field       = updates.field;
    if (updates.emoji)        c.emoji       = updates.emoji;
    if (updates.color)        c.color       = updates.color;
    if (updates.sig_password) c.sigPassword = updates.sig_password;
  }
  return { ok: true };
}

async function sbDeleteCompany(id) {
  if (!sb) return { ok: false };
  const { error } = await sb.from('companies').delete().eq('id', id);
  if (error) { console.error('sbDeleteCompany:', error); return { ok: false }; }
  const idx = DATA.companies.findIndex(c => c.id === id);
  if (idx !== -1) DATA.companies.splice(idx, 1);
  return { ok: true };
}

// ── Hours ────────────────────────────────────────────────────
const _hoursSaveTimers = {};
function sbSaveHour(workerId, year, month, day, entry) {
  if (!sb) return;
  const key = `${workerId}-${year}-${month}-${day}`;
  clearTimeout(_hoursSaveTimers[key]);
  _hoursSaveTimers[key] = setTimeout(async () => {
    const pad2 = n => String(n).padStart(2,'0');
    const work_date = `${year}-${pad2(month+1)}-${pad2(day)}`;
    await sb.from('worker_hours').upsert({
      worker_id: workerId, work_date,
      hours:      parseFloat(entry.hours) || 0,
      start_time: entry.start || null,
      end_time:   entry.end   || null,
      note:       entry.note  || null,
    }, { onConflict: 'worker_id,work_date' });
  }, 800);
}

// ── Signatures ────────────────────────────────────────────────
async function sbSign(workerId, year, month, type, days) {
  if (!sb) return;
  const session = getSbSession();
  await sb.from('signatures').upsert({
    worker_id:  workerId,
    company_id: session?.company_id,
    year, month, type, days,
  }, { onConflict: 'worker_id,year,month' });
}

async function sbUnsign(workerId, year, month) {
  if (!sb) return;
  await sb.from('signatures')
    .delete()
    .eq('worker_id', workerId)
    .eq('year', year)
    .eq('month', month);
}

// ── Requests ─────────────────────────────────────────────────
async function sbCreateRequest(payload) {
  if (!sb) return { ok: false };
  const session = getSbSession();
  const { data, error } = await sb.from('requests').insert({
    worker_id:   session?.id,
    worker_name: session ? DATA.users.find(u=>u.id===session.id)?.name || session.name : 'פועל',
    company_id:  session?.company_id,
    type:        payload.type,
    text:        payload.text,
    status:      'pending',
  }).select('*').single();
  if (error) { console.error('sbCreateRequest:', error); return { ok: false }; }
  DATA.requests.unshift(mapRequest(data));
  return { ok: true, data };
}

async function sbUpdateRequest(id, updates) {
  if (!sb) return { ok: false };
  const { error } = await sb.from('requests').update(updates).eq('id', id);
  if (error) { console.error('sbUpdateRequest:', error); return { ok: false }; }
  const idx = DATA.requests.findIndex(r => r.id === id);
  if (idx !== -1) Object.assign(DATA.requests[idx], updates);
  return { ok: true };
}

async function sbDeleteRequest(id) {
  if (!sb) return { ok: false };
  const { error } = await sb.from('requests').delete().eq('id', id);
  if (error) { console.error('sbDeleteRequest:', error); return { ok: false }; }
  const idx = DATA.requests.findIndex(r => r.id === id);
  if (idx !== -1) DATA.requests.splice(idx, 1);
  return { ok: true };
}

// ── Notes ─────────────────────────────────────────────────────
const _notesTimer = {};
function sbSaveNote(content) {
  if (!sb) return;
  const session = getSbSession();
  if (!session) return;
  clearTimeout(_notesTimer._t);
  _notesTimer._t = setTimeout(async () => {
    await sb.from('notes').upsert(
      { user_id: session.id, content, updated_at: new Date().toISOString() },
      { onConflict: 'user_id' }
    );
  }, 1000);
}

// ── Load more hours when user navigates months ─────────────────
async function sbLoadMonthHours(workerId, year, month) {
  if (!sb) return;
  const key = `${workerId}-${year}-${month}`;
  if (DATA.workerHours[key] !== undefined) return; // already loaded
  const pad2 = n => String(n).padStart(2,'0');
  const startDate = `${year}-${pad2(month+1)}-01`;
  const endDate   = new Date(year, month+1, 0).toISOString().split('T')[0];
  const { data: rows = [] } = await sb.from('worker_hours')
    .select('*').eq('worker_id', workerId)
    .gte('work_date', startDate).lte('work_date', endDate);
  const map = buildHoursMap(rows);
  Object.assign(DATA.workerHours, map);
  if (!DATA.workerHours[key]) DATA.workerHours[key] = {}; // mark as loaded (even if empty)
}

// END OF SUPABASE BRIDGE
// ═══════════════════════════════════════════════════════════════

const DATA = {
  users: [
    { id:1, username:'admin', password:'admin123', name:'מנהל המערכת', role:'admin', company:null, avatar:'👑', avatarColor:'#6c63ff' },
    { id:2, username:'ceo_techcorp', password:'ceo123', name:'אלי ישראלי', role:'ceo', company:'techcorp', avatar:'🏢', avatarColor:'#60a5fa' },
    { id:3, username:'ceo_buildpro', password:'ceo456', name:'מיכל גולן', role:'ceo', company:'buildpro', avatar:'🏗️', avatarColor:'#fb923c' },
    { id:4, username:'employee1', password:'emp123', name:'דוד לוי', role:'employee', company:'techcorp', avatar:'💼', avatarColor:'#4ade80', idType:'id', idNumber:'312456789' },
    { id:5, username:'employee2', password:'emp456', name:'שרה רוזן', role:'employee', company:'techcorp', avatar:'💼', avatarColor:'#fbbf24', idType:'id', idNumber:'208754321' },
    { id:6, username:'employee3', password:'emp789', name:'רון אבן', role:'employee', company:'buildpro', avatar:'💼', avatarColor:'#f87171', idType:'id', idNumber:'425678901' },
    { id:7, username:'worker1', password:'work123', name:'יוסף כהן', role:'worker', company:'buildpro', avatar:'🔧', avatarColor:'#fb923c', idType:'id', idNumber:'234567890' },
    { id:8, username:'worker2', password:'work456', name:'אחמד חסן', role:'worker', company:'buildpro', avatar:'🔧', avatarColor:'#a78bfa', idType:'passport', idNumber:'AB1234567' },
    { id:9, username:'ceo_cleanit', password:'ceo789', name:'נועה שמיר', role:'ceo', company:'cleanit', avatar:'✨', avatarColor:'#34d399' },
    { id:10, username:'employee4', password:'emp321', name:'טל ברק', role:'employee', company:'cleanit', avatar:'💼', avatarColor:'#60a5fa', idType:'id', idNumber:'316789012' },
    { id:11, username:'worker3', password:'work789', name:'פאדי יוסף', role:'worker', company:'techcorp', avatar:'🔧', avatarColor:'#f59e0b', idType:'passport', idNumber:'CD9876543' },
    { id:12, username:'worker4', password:'work321', name:'ג׳ורג׳ מסיח', role:'worker', company:'cleanit', avatar:'🔧', avatarColor:'#ec4899', idType:'passport', idNumber:'EF5678901' },
  ],
  companies: [
    { id:'techcorp', name:'TechCorp', emoji:'💻', field:'פיתוח תוכנה ואפליקציות', employees:3, color:'#6c63ff', sigPassword:'sign123', signed:{} },
    { id:'buildpro', name:'BuildPro', emoji:'🏗️', field:'בנייה ופיתוח נדל"ן', employees:3, color:'#fb923c', sigPassword:'sign456', signed:{} },
    { id:'cleanit', name:'CleanIt', emoji:'✨', field:'שירותי ניקיון ותחזוקה', employees:2, color:'#34d399', sigPassword:'sign789', signed:{} },
  ],
  tasks: [
    { id:1, title:'עיצוב דף הבית החדש', desc:'ליצור מקאפ לדף הבית המעודכן', assignedTo:4, assignedBy:2, company:'techcorp', priority:'high', status:'open', dueDate:'2026-02-25', createdByEmp:false },
    { id:2, title:'תיקון באג בלוגין', desc:'משתמשים מדווחים על שגיאת 500', assignedTo:4, assignedBy:2, company:'techcorp', priority:'high', status:'open', dueDate:'2026-02-22', createdByEmp:false },
    { id:3, title:'כתיבת תיעוד API', desc:'לתעד את כל הנקודות הקיימות', assignedTo:5, assignedBy:2, company:'techcorp', priority:'medium', status:'open', dueDate:'2026-03-01', createdByEmp:false },
    { id:4, title:'פגישת לקוח', desc:'הכנת מצגת לפגישה', assignedTo:5, assignedBy:2, company:'techcorp', priority:'low', status:'done', dueDate:'2026-02-18', createdByEmp:false },
    { id:5, title:'בדיקת ביסוס יסודות', desc:'לבצע בדיקה מקיפה', assignedTo:6, assignedBy:3, company:'buildpro', priority:'high', status:'open', dueDate:'2026-02-23', createdByEmp:false },
    { id:6, title:'תכנון תשתית חשמל', desc:'להכין תוכנית מפורטת', assignedTo:6, assignedBy:3, company:'buildpro', priority:'medium', status:'open', dueDate:'2026-02-28', createdByEmp:false },
    { id:7, title:'הוספת פיצ׳ר חדש', desc:'הוספת לוח שנה למשתמשים', assignedTo:4, assignedBy:4, company:'techcorp', priority:'medium', status:'open', dueDate:'2026-03-05', createdByEmp:true },
    { id:8, title:'ניקיון חדר שרתים', desc:'פעם בשבוע', assignedTo:10, assignedBy:9, company:'cleanit', priority:'low', status:'open', dueDate:'2026-02-27', createdByEmp:false },
  ],
  notes: {},
  quickNotes: {},
  requests: [],
  workerHours: (function() {
    const d = {};
    const now = new Date();
    const y = now.getFullYear();
    // workers: id 7 (יוסף כהן, buildpro), 8 (אחמד חסן, buildpro), 12 (ג'ורג' מסיח, cleanit)
    // company buildpro workers: 7, 8
    // company cleanit workers: 12
    // company techcorp workers: 11
    const demoWorkers = [
      { id:7,  company:'buildpro', hoursProfile:[8,7,9,0,8,8,0,7,9,8,0,0,8,7,9,8,0,8,8,7,0,9,8,7,0,8,8,9,0,8] },
      { id:8,  company:'buildpro', hoursProfile:[6,7,0,8,6,7,0,8,7,6,0,0,7,8,6,7,0,6,8,7,0,6,7,8,0,7,6,0,0,7] },
      { id:11, company:'techcorp', hoursProfile:[9,8,0,9,8,9,0,0,8,9,0,0,9,8,7,9,0,8,9,0,0,9,8,9,0,8,0,9,0,9] },
      { id:12, company:'cleanit', hoursProfile:[5,6,0,7,5,6,0,6,5,7,0,0,6,5,6,7,0,5,7,6,0,5,6,7,0,6,5,0,0,6] },
    ];

    // Current month
    demoWorkers.forEach(w => {
      const key = `${w.id}-${y}-${now.getMonth()}`;
      d[key] = {};
      w.hoursProfile.forEach((h, i) => {
        if (h > 0) {
          d[key][i+1] = { start:'08:00', end: `${String(8+h).padStart(2,'0')}:00`, hours: String(h), note:'' };
        }
      });
    });

    // Previous month
    let pm = now.getMonth() - 1, py = y;
    if (pm < 0) { pm = 11; py--; }
    const prevProfile = [7,8,0,7,8,7,0,8,7,8,0,0,7,8,7,8,0,7,8,7,0,8,7,6,0,7,8,0,0,7];
    demoWorkers.forEach(w => {
      const key = `${w.id}-${py}-${pm}`;
      d[key] = {};
      prevProfile.forEach((h, i) => {
        const adj = Math.max(0, h + (w.id % 3 - 1));
        if (adj > 0) {
          d[key][i+1] = { start:'08:00', end: `${String(8+adj).padStart(2,'0')}:00`, hours: String(adj), note:'' };
        }
      });
    });

    // 2 months ago
    let pm2 = now.getMonth() - 2, py2 = y;
    if (pm2 < 0) { pm2 += 12; py2--; }
    const prev2Profile = [6,7,0,8,6,7,0,7,6,8,0,0,7,6,7,8,0,6,8,7,0,6,7,6,0,7,6,0,0,7];
    demoWorkers.forEach(w => {
      const key = `${w.id}-${py2}-${pm2}`;
      d[key] = {};
      prev2Profile.forEach((h, i) => {
        const adj = Math.max(0, h + (w.id % 2));
        if (adj > 0) {
          d[key][i+1] = { start:'08:00', end: `${String(8+adj).padStart(2,'0')}:00`, hours: String(adj), note:'' };
        }
      });
    });

    return d;
  })(),
};

let currentUser = null;
let currentPage = null;
let workerCurrentMonth = new Date().getMonth();
let workerCurrentYear = new Date().getFullYear();
let taskFilter = 'all';
let nextTaskId = 100;
let nextSubtaskId = 1000;

// ═══════════════════════════════════════════
// AUTH
// ═══════════════════════════════════════════
async function doLogin() {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value.trim();
  if (!u || !p) { document.getElementById('loginError').style.display = 'block'; return; }

  if (HAS_SUPABASE) {
    const btn = document.querySelector('#loginScreen .btn-primary') ||
                document.querySelector('#loginScreen button[type="button"]');
    if (btn) { btn.disabled = true; btn.textContent = '⏳ מתחבר...'; }
    showLoadingOverlay(true);

    const dbUser = await sbDoLogin(u, p);

    showLoadingOverlay(false);
    if (btn) { btn.disabled = false; btn.textContent = '🔐 כניסה'; }

    if (!dbUser) {
      document.getElementById('loginError').style.display = 'block';
      return;
    }
    await loadAndInjectData(dbUser);
    return;
  }

  // Demo mode — in-memory only
  const user = DATA.users.find(x => x.username === u && x.password === p);
  if (!user) { document.getElementById('loginError').style.display = 'block'; return; }
  login(user);
}

function quickLogin(u, p) {
  document.getElementById('loginUser').value = u;
  document.getElementById('loginPass').value = p;
  doLogin();
}

function login(user) {
  currentUser = user;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('loginError').style.display = 'none';
  // Always start with sidebar closed (mobile)
  closeSidebar();

  // Setup user header
  const av = document.getElementById('userAvatar');
  av.textContent = user.avatar;
  av.style.background = user.avatarColor + '33';
  av.style.color = user.avatarColor;
  document.getElementById('userName').textContent = user.name;

  const roleLabels = { admin:'מנהל מערכת', ceo:'מנכ"ל', employee:'עובד', worker:'פועל' };
  const roleColors = { admin:'#6c63ff', ceo:'#60a5fa', employee:'#4ade80', worker:'#fb923c' };
  // If employee has CEO interface or field worker, show appropriate badge
  const effectiveRole = getEffectiveRole(user);
  const badge = document.getElementById('roleBadge');
  if (user.ceoInterface && user.role === 'employee') {
    badge.textContent = 'ממשק עובד מורחב';
  } else if (user.fieldWorker && user.role === 'employee') {
    badge.textContent = 'עובד שטח';
  } else {
    badge.textContent = roleLabels[user.role];
  }
  badge.style.background = (roleColors[effectiveRole] || roleColors[user.role]) + '18';
  badge.style.color = roleColors[effectiveRole] || roleColors[user.role];
  badge.style.border = '1px solid ' + (roleColors[effectiveRole] || roleColors[user.role]) + '55';

  buildNav();
  routeToRole();
}

function logout() {
  if (HAS_SUPABASE) sbDoLogout();
  currentUser = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  closeSidebar();
}

// ═══════════════════════════════════════════
// NAV
// ═══════════════════════════════════════════
const navConfigs = {
  admin: [
    { page:'admin-dashboard', icon:'📊', label:'לוח בקרה' },
    { page:'admin-companies', icon:'🏢', label:'ניהול חברות' },
    { page:'admin-users', icon:'👥', label:'משתמשים וסיסמאות' },
    { page:'admin-notes', icon:'📝', label:'הערות אישיות' },
    { page:'admin-ai', icon:'🤖', label:'עוזר AI' },
  ],
  ceo: [
    { page:'ceo-dashboard', icon:'📊', label:'לוח בקרה' },
    { page:'ceo-employees', icon:'💼', label:'עובדים' },
    { page:'ceo-workers', icon:'🔧', label:'פועלים ושעות' },
    { page:'ceo-tasks', icon:'📋', label:'משימות' },
    { page:'ceo-notes', icon:'📝', label:'הערות אישיות' },
    { page:'ceo-requests', icon:'📬', label:'פניות פועלים' },
    { page:'ceo-credentials', icon:'🔑', label:'שמות משתמש וסיסמאות' },
    { page:'ceo-ai', icon:'🤖', label:'עוזר AI' },
  ],
  employee: [
    { page:'emp-dashboard', icon:'🏠', label:'ראשי' },
    { page:'emp-tasks', icon:'📋', label:'המשימות שלי' },
    { page:'emp-calendar', icon:'📅', label:'לוח זמנים' },
    { page:'emp-notes', icon:'📝', label:'הערות אישיות' },
  ],
  fieldWorker: [
    { page:'emp-dashboard', icon:'🏠', label:'ראשי' },
    { page:'emp-tasks', icon:'📋', label:'המשימות שלי' },
    { page:'ceo-workers', icon:'🔧', label:'פועלים ושעות' },
    { page:'ceo-requests', icon:'📬', label:'פניות פועלים' },
    { page:'ceo-credentials', icon:'🔑', label:'סיסמאות פועלים' },
    { page:'emp-calendar', icon:'📅', label:'לוח זמנים' },
    { page:'emp-notes', icon:'📝', label:'הערות אישיות' },
  ],
  worker: [
    { page:'worker-hours', icon:'⏰', label:'דוח שעות' },
    { page:'worker-requests', icon:'📬', label:'פניות ובקשות' },
  ],
};

function getEffectiveRole(user) {
  if (!user) return null;
  if (user.role === 'employee' && user.ceoInterface) return 'ceo';
  if (user.role === 'employee' && user.fieldWorker) return 'fieldWorker';
  return user.role;
}

function buildNav() {
  const nav = document.getElementById('sidebarNav');
  const effectiveRole = getEffectiveRole(currentUser);
  const config = navConfigs[effectiveRole] || [];
  nav.innerHTML = '';
  config.forEach(item => {
    const el = document.createElement('div');
    el.className = 'nav-item';
    el.dataset.page = item.page;
    let badgeHtml = '';
    if (item.page === 'ceo-requests') {
      const pending = DATA.requests.filter(r => r.company === currentUser.company && r.status === 'pending').length;
      if (pending > 0) badgeHtml = `<span class="badge">${pending}</span>`;
    }
    el.innerHTML = `<span class="icon">${item.icon}</span>${item.label}${badgeHtml}`;
    el.onclick = () => { goPage(item.page); closeSidebar(); };
    nav.appendChild(el);
  });
}

function goPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const pg = document.getElementById('page-' + pageId);
  if (pg) pg.classList.add('active');
  const nav = document.querySelector(`[data-page="${pageId}"]`);
  if (nav) nav.classList.add('active');

  const labels = { 'admin-dashboard':'לוח בקרה','admin-companies':'ניהול חברות','admin-users':'משתמשים','admin-notes':'הערות',
    'ceo-dashboard':'לוח בקרה','ceo-employees':'עובדים','ceo-workers':'פועלים','ceo-tasks':'משימות','ceo-credentials':'סיסמאות הצוות','ceo-notes':'הערות','ceo-analytics':'ניתוח וביצועים','ceo-requests':'פניות פועלים',
    'emp-dashboard':'ראשי','emp-tasks':'המשימות שלי','emp-calendar':'לוח זמנים','emp-notes':'הערות',
    'worker-hours':'דוח שעות','worker-requests':'פניות ובקשות' };
  document.getElementById('pageTitle').textContent = labels[pageId] || pageId;
  currentPage = pageId;
  // Clear global search on page change
  const gs = document.getElementById('globalSearch');
  if (gs) gs.value = '';
  document.getElementById('topbarInfo').textContent = '';
  renderPage(pageId);
}

function routeToRole() {
  const defaults = { admin:'admin-dashboard', ceo:'ceo-dashboard', employee:'emp-dashboard', worker:'worker-hours', fieldWorker:'emp-dashboard' };
  closeSidebar();
  const effectiveRole = getEffectiveRole(currentUser);
  goPage(defaults[effectiveRole] || 'emp-dashboard');
}

// ═══════════════════════════════════════════
// RENDER PAGES
// ═══════════════════════════════════════════
function renderPage(pageId) {
  if (pageId === 'admin-companies') renderAdminCompanies();
  else if (pageId === 'admin-users') renderAdminUsers();
  else if (pageId === 'admin-notes') renderNotes('admin');
  else if (pageId === 'admin-ai') { /* page is static, just focus input */ setTimeout(() => document.getElementById('admin-ai-input')?.focus(), 100); }
  else if (pageId === 'ceo-dashboard') renderCeoDashboard();
  else if (pageId === 'ceo-employees') renderCeoEmployees();
  else if (pageId === 'ceo-workers') { renderCeoWorkers(); renderCeoWorkersGrid(false); setTimeout(() => { fitGridToScreen(false); updateSliderFill(document.getElementById('grid-zoom-slider')); }, 80); }
  else if (pageId === 'ceo-tasks') renderCeoTasks();
  else if (pageId === 'ceo-credentials') renderCeoCredentials();
  else if (pageId === 'ceo-notes') renderNotes('ceo');
  else if (pageId === 'ceo-requests') renderCeoRequests();
  else if (pageId === 'ceo-ai') initAiPage();
  else if (pageId === 'emp-dashboard') renderEmpDashboard();
  else if (pageId === 'emp-tasks') renderEmpTasks();
  else if (pageId === 'emp-calendar') renderEmpCalendar();
  else if (pageId === 'emp-notes') renderNotes('emp');
  else if (pageId === 'worker-hours') renderWorkerHours();
  else if (pageId === 'worker-requests') renderWorkerRequests();
  else if (pageId === 'worker-notes') renderNotes('worker');
}

// ── ADMIN ──
let companySortState = { field: 'name', dir: 1 };

function setCompanySort(field) {
  if (companySortState.field === field) {
    companySortState.dir *= -1;
  } else {
    companySortState.field = field;
    companySortState.dir = 1;
  }
  // Update button labels
  const fields = { name:'שם', employees:'עובדים', workers:'פועלים', total:'סה"כ אנשים' };
  Object.keys(fields).forEach(f => {
    const btn = document.getElementById('csort-' + f);
    if (!btn) return;
    btn.classList.toggle('active-sort', f === companySortState.field);
    btn.textContent = fields[f] + (f === companySortState.field ? (companySortState.dir === 1 ? ' ↓' : ' ↑') : ' ↕');
  });
  renderAdminCompanies();
}

function renderAdminCompanies() {
  const grid = document.getElementById('companiesGrid');
  document.getElementById('stat-companies').textContent = DATA.companies.length;
  document.getElementById('stat-users').textContent = DATA.users.filter(u => u.role !== 'admin').length;

  // Compute stats per company
  let companies = DATA.companies.map(c => {
    const employees = DATA.users.filter(u => u.company === c.id && u.role === 'employee').length;
    const workers   = DATA.users.filter(u => u.company === c.id && u.role === 'worker').length;
    const ceos      = DATA.users.filter(u => u.company === c.id && u.role === 'ceo').length;
    const total     = employees + workers + ceos;
    return { ...c, employees, workers, ceos, total };
  });

  // Sort
  const { field, dir } = companySortState;
  companies.sort((a, b) => {
    if (field === 'name') return dir * a.name.localeCompare(b.name, 'he');
    return dir * (b[field] - a[field]);
  });

  // Max values for bar widths
  const maxEmp = Math.max(...companies.map(c => c.employees), 1);
  const maxWkr = Math.max(...companies.map(c => c.workers), 1);
  const maxTot = Math.max(...companies.map(c => c.total), 1);

  grid.innerHTML = companies.map((c, idx) => {
    const rank = (field !== 'name') ? `<span style="font-size:11px;background:${c.color}22;color:${c.color};border-radius:6px;padding:2px 8px;font-weight:700;">#${idx + 1}</span>` : '';
    return `
    <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 20px;display:flex;align-items:center;gap:16px;border-right:4px solid ${c.color};transition:box-shadow 0.2s;" onmouseover="this.style.boxShadow='var(--shadow)'" onmouseout="this.style.boxShadow='none'">
      <!-- Emoji + Name -->
      <div style="width:44px;height:44px;border-radius:12px;background:${c.color}22;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0;">${c.emoji}</div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
          <div style="font-size:15px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.name}</div>
          ${rank}
        </div>
        <div style="font-size:12px;color:var(--text3);margin-bottom:10px;">${c.field}</div>
        <!-- Stats bars -->
        <div style="display:flex;flex-direction:column;gap:5px;">
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:11px;color:var(--text2);width:52px;flex-shrink:0;">💼 עובדים</span>
            <div style="flex:1;background:var(--bg3);border-radius:6px;height:7px;overflow:hidden;"><div style="height:100%;border-radius:6px;background:#4ade80;width:${maxEmp > 0 ? (c.employees/maxEmp*100).toFixed(1) : 0}%;transition:width 0.4s;"></div></div>
            <span style="font-size:12px;font-weight:700;color:#2a8a4a;min-width:18px;text-align:left;">${c.employees}</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:11px;color:var(--text2);width:52px;flex-shrink:0;">🔧 פועלים</span>
            <div style="flex:1;background:var(--bg3);border-radius:6px;height:7px;overflow:hidden;"><div style="height:100%;border-radius:6px;background:#fb923c;width:${maxWkr > 0 ? (c.workers/maxWkr*100).toFixed(1) : 0}%;transition:width 0.4s;"></div></div>
            <span style="font-size:12px;font-weight:700;color:#c05820;min-width:18px;text-align:left;">${c.workers}</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:11px;color:var(--text2);width:52px;flex-shrink:0;">👥 סה"כ</span>
            <div style="flex:1;background:var(--bg3);border-radius:6px;height:7px;overflow:hidden;"><div style="height:100%;border-radius:6px;background:#60a5fa;width:${maxTot > 0 ? (c.total/maxTot*100).toFixed(1) : 0}%;transition:width 0.4s;"></div></div>
            <span style="font-size:12px;font-weight:700;color:#2060a0;min-width:18px;text-align:left;">${c.total}</span>
          </div>
        </div>
      </div>
      <!-- Actions -->
      <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">
        <button class="btn btn-outline btn-sm" onclick="editCompany('${c.id}')">✏️ עריכה</button>
        <button class="btn btn-danger btn-sm" onclick="deleteCompany('${c.id}')">🗑️ מחק</button>
      </div>
    </div>`;
  }).join('');
}

let adminUserSort = { field: 'name', dir: 1 };

function setSort(field) {
  if (adminUserSort.field === field) {
    adminUserSort.dir *= -1;
  } else {
    adminUserSort.field = field;
    adminUserSort.dir = 1;
  }
  document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active-sort'));
  const btn = document.getElementById('sort-' + field);
  if (btn) btn.classList.add('active-sort');
  // update arrow indicators
  document.querySelectorAll('.sort-btn').forEach(b => {
    const f = b.id.replace('sort-','');
    const labels = { name:'שם', role:'תפקיד', company:'חברה' };
    b.textContent = labels[f] + (adminUserSort.field === f ? (adminUserSort.dir === 1 ? ' ↑' : ' ↓') : ' ↕');
  });
  renderAdminUsers();
}

function renderAdminUsers() {
  // Populate company filter dropdown
  const companyFilter = document.getElementById('usersFilterCompany');
  if (companyFilter) {
    const cur = companyFilter.value;
    companyFilter.innerHTML = '<option value="">כל החברות</option>' +
      DATA.companies.map(c => `<option value="${c.id}" ${cur===c.id?'selected':''}>${c.emoji} ${c.name}</option>`).join('');
  }

  const roleLabels = { admin:'👑 מנהל מערכת', ceo:'🏢 מנכ"ל', employee:'💼 עובד', worker:'🔧 פועל' };
  const searchVal = (document.getElementById('usersSearch')?.value || '').toLowerCase().trim();
  const roleFilter = document.getElementById('usersFilterRole')?.value || '';
  const companyVal = companyFilter?.value || '';

  let users = [...DATA.users];

  // Filter
  if (searchVal) users = users.filter(u =>
    u.name.toLowerCase().includes(searchVal) ||
    u.username.toLowerCase().includes(searchVal)
  );
  if (roleFilter) users = users.filter(u => u.role === roleFilter);
  if (companyVal) users = users.filter(u => u.company === companyVal);

  // Sort
  const sortField = adminUserSort.field;
  const sortDir = adminUserSort.dir;
  users.sort((a, b) => {
    let va, vb;
    if (sortField === 'name') { va = a.name; vb = b.name; }
    else if (sortField === 'role') {
      const order = { admin:0, ceo:1, employee:2, worker:3 };
      va = order[a.role] ?? 9; vb = order[b.role] ?? 9;
      return (va - vb) * sortDir;
    }
    else if (sortField === 'company') {
      const ca = DATA.companies.find(c => c.id === a.company);
      const cb = DATA.companies.find(c => c.id === b.company);
      va = ca ? ca.name : 'ת'; vb = cb ? cb.name : 'ת';
    }
    return va < vb ? -sortDir : va > vb ? sortDir : 0;
  });

  const tbody = document.getElementById('usersTableBody');
  if (!users.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:32px;font-size:14px;">😕 לא נמצאו משתמשים</td></tr>';
  } else {
    tbody.innerHTML = users.map(u => {
      const company = DATA.companies.find(c => c.id === u.company);
      return `
      <tr>
        <td><div style="display:flex;align-items:center;gap:8px;">
          <div style="width:30px;height:30px;border-radius:50%;background:${u.avatarColor}33;color:${u.avatarColor};display:flex;align-items:center;justify-content:center;font-size:13px;">${u.avatar}</div>
          <span style="font-weight:600;">${highlightText(u.name, searchVal)}</span>
        </div></td>
        <td>${roleLabels[u.role]}</td>
        <td>${company ? `${company.emoji} ${company.name}` : '—'}</td>
        <td><code style="background:var(--bg3);padding:3px 8px;border-radius:5px;font-size:12px;">${highlightText(u.username, searchVal)}</code></td>
        <td>
          <div style="display:flex;align-items:center;gap:6px;">
            <span id="pass-display-${u.id}" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 10px;font-size:12px;font-family:monospace;letter-spacing:2px;">••••••••</span>
            <button onclick="togglePassView(${u.id},'${u.password}')" title="הצג/הסתר סיסמה" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 8px;cursor:pointer;font-size:13px;color:var(--text2);" id="eye-btn-${u.id}">👁️</button>
          </div>
        </td>
        <td>
          <div style="display:flex;gap:6px;">
            <button class="btn btn-outline btn-sm" onclick="editUser(${u.id})">✏️</button>
            <button class="btn btn-outline btn-sm" onclick="changePassword(${u.id})">🔑</button>
            ${u.role !== 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">🗑️</button>` : ''}
          </div>
        </td>
      </tr>`;
    }).join('');
  }

  const countEl = document.getElementById('usersCount');
  if (countEl) countEl.textContent = `מציג ${users.length} מתוך ${DATA.users.length} משתמשים`;
}

function highlightText(text, query) {
  if (!query) return text;
  const idx = text.toLowerCase().indexOf(query);
  if (idx === -1) return text;
  return text.slice(0,idx) + `<mark style="background:#fde68a;border-radius:3px;padding:0 2px;">${text.slice(idx, idx+query.length)}</mark>` + text.slice(idx+query.length);
}

// Global search handler
function handleSearch(val) {
  const q = val.toLowerCase().trim();
  if (!q) { document.getElementById('topbarInfo').textContent = ''; return; }

  if (currentPage === 'admin-users') {
    const el = document.getElementById('usersSearch');
    if (el) { el.value = val; renderAdminUsers(); }
    return;
  }
  if (currentPage === 'ceo-tasks' || currentPage === 'emp-tasks') {
    searchTasks(q);
    return;
  }
  if (currentPage === 'ceo-credentials') {
    searchCredentials(q);
    return;
  }
  if (currentPage === 'ceo-employees') {
    searchEmployees(q);
    return;
  }
}

function searchTasks(q) {
  const isCeo = currentPage === 'ceo-tasks';
  const grid = document.getElementById(isCeo ? 'ceo-tasks-grid' : 'emp-tasks-grid');
  let tasks = DATA.tasks.filter(t =>
    (isCeo ? t.company === currentUser.company : t.assignedTo === currentUser.id) &&
    (t.title.toLowerCase().includes(q) || (t.desc || '').toLowerCase().includes(q))
  );
  renderTaskCards(grid, tasks, isCeo ? 'ceo' : 'emp');
  document.getElementById('topbarInfo').textContent = `${tasks.length} תוצאות`;
}

function searchEmployees(q) {
  const tbody = document.getElementById('ceo-employees-table');
  const emps = DATA.users.filter(u =>
    u.company === currentUser.company && u.role === 'employee' &&
    (u.name.toLowerCase().includes(q) || u.username.toLowerCase().includes(q))
  );
  if (!emps.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:24px;">לא נמצאו תוצאות</td></tr>'; return; }
  renderCeoEmployees();
}

function searchCredentials(q) {
  // Re-render with highlight
  renderCeoCredentials(q);
}


// ── CEO ──

// ═══════════════════════════════════════════
// CEO ANALYTICS
// ═══════════════════════════════════════════
let analyticsMonth = new Date().getMonth();
let analyticsYear  = new Date().getFullYear();
let chartWorkerHours = null;
let chartMonthly     = null;

function changeAnalyticsMonth(delta) {
  analyticsMonth += delta;
  if (analyticsMonth > 11) { analyticsMonth = 0; analyticsYear++; }
  if (analyticsMonth < 0)  { analyticsMonth = 11; analyticsYear--; }
  renderCeoAnalytics();
}

function getWorkerHoursForMonth(workerId, year, month) {
  const key = `${workerId}-${year}-${month}`;
  const entries = DATA.workerHours[key] || {};
  let total = 0;
  Object.values(entries).forEach(e => {
    const h = e.start && e.end ? calcHoursFromTime(e.start, e.end) : (parseFloat(e.hours) || 0);
    total += h;
  });
  return Math.round(total * 10) / 10;
}

function renderCeoAnalytics() {
  const monthNames = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];
  const now = new Date();

  // Month label
  const lbl = document.getElementById('analytics-month-label');
  if (lbl) lbl.textContent = `${monthNames[analyticsMonth]} ${analyticsYear}`;

  const company  = DATA.companies.find(c => c.id === currentUser.company);
  const workers  = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const tasks    = DATA.tasks.filter(t => t.company === currentUser.company);
  const openTasks = tasks.filter(t => t.status === 'open');
  const overdue  = tasks.filter(t => t.status === 'open' && t.dueDate && new Date(t.dueDate) < now);

  // ── Smart Alerts ────────────────────────────────────────────────────────────
  const alertsEl = document.getElementById('ceo-analytics-alerts');
  const alerts = [];

  // Workers who didn't submit hours this month
  const noHoursWorkers = workers.filter(w => getWorkerHoursForMonth(w.id, analyticsYear, analyticsMonth) === 0);
  if (noHoursWorkers.length > 0) {
    alerts.push({
      color:'#e88fa0', bg:'#fff0f3', icon:'⏰',
      text: `${noHoursWorkers.length} פועל${noHoursWorkers.length > 1 ? 'ים' : ''} עדיין לא הגיש${noHoursWorkers.length > 1 ? 'ו' : ''} שעות לחודש זה`,
      sub: noHoursWorkers.map(w => w.name).join(' • ')
    });
  }

  // Overdue tasks
  if (overdue.length > 0) {
    alerts.push({
      color:'#e8a87a', bg:'#fff5ee', icon:'📋',
      text: `יש ${overdue.length} משימ${overdue.length > 1 ? 'ות' : 'ה'} שעבר${overdue.length > 1 ? 'ו' : 'ה'} את תאריך היעד`,
      sub: overdue.map(t => t.title).join(' • ')
    });
  }

  // Workers not signed last month
  let prevM = analyticsMonth - 1, prevY = analyticsYear;
  if (prevM < 0) { prevM = 11; prevY--; }
  const unsignedPrev = workers.filter(w => {
    const key = `${w.id}-${prevY}-${prevM}`;
    const hrs = getWorkerHoursForMonth(w.id, prevY, prevM);
    const sig = company && company.signed[key];
    return hrs > 0 && (!sig || sig.type !== 'full');
  });
  if (unsignedPrev.length > 0) {
    alerts.push({
      color:'#7bb3d8', bg:'#eef5ff', icon:'✍️',
      text: `דוח ${monthNames[prevM]} לא נחתם עבור ${unsignedPrev.length} פועל${unsignedPrev.length > 1 ? 'ים' : ''}`,
      sub: unsignedPrev.map(w => w.name).join(' • ')
    });
  }

  if (alertsEl) {
    if (alerts.length === 0) {
      alertsEl.innerHTML = `<div style="background:#f0fff4;border:1px solid #a8e8c0;border-radius:12px;padding:14px 18px;display:flex;align-items:center;gap:12px;font-size:14px;font-weight:600;color:#2d8a5a;">✅ <span>הכל תקין — אין התראות פעילות</span></div>`;
    } else {
      alertsEl.innerHTML = alerts.map(a => `
        <div style="background:${a.bg};border:1px solid ${a.color}55;border-radius:12px;padding:14px 18px;margin-bottom:10px;border-right:4px solid ${a.color};">
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:20px;">${a.icon}</span>
            <div>
              <div style="font-size:13px;font-weight:700;color:#2d3a4a;">${a.text}</div>
              ${a.sub ? `<div style="font-size:11px;color:#6b7e96;margin-top:3px;">${a.sub}</div>` : ''}
            </div>
          </div>
        </div>`).join('');
    }
  }

  // ── Summary Stat Cards ──────────────────────────────────────────────────────
  const totalHoursThisMonth = workers.reduce((sum, w) => sum + getWorkerHoursForMonth(w.id, analyticsYear, analyticsMonth), 0);
  const avgHoursPerWorker = workers.length ? (totalHoursThisMonth / workers.length).toFixed(1) : 0;
  const signedCount = workers.filter(w => {
    const key = `${w.id}-${analyticsYear}-${analyticsMonth}`;
    const sig = company && company.signed[key];
    if (!sig) return false;
    // "full" signature covers everything
    if (sig.type === 'full') return true;
    // "partial" — only counts if every day that has hours is in the signed days list
    if (sig.type === 'partial') {
      const entries = DATA.workerHours[key] || {};
      const workedDays = Object.keys(entries)
        .map(Number)
        .filter(d => {
          const e = entries[d];
          const h = e.start && e.end ? calcHoursFromTime(e.start, e.end) : (parseFloat(e.hours) || 0);
          return h > 0;
        });
      if (workedDays.length === 0) return false;
      return workedDays.every(d => sig.days.includes(d));
    }
    return false;
  }).length;

  const statCards = document.getElementById('analytics-stat-cards');
  if (statCards) {
    statCards.innerHTML = `
      <div class="stat-card orange">
        <div class="stat-header"><div class="stat-icon">⏱️</div><div class="stat-label">סה"כ שעות החודש</div></div>
        <div class="stat-value">${totalHoursThisMonth.toFixed(1)}</div>
      </div>
      <div class="stat-card blue">
        <div class="stat-header"><div class="stat-icon">📊</div><div class="stat-label">ממוצע לפועל</div></div>
        <div class="stat-value">${avgHoursPerWorker}</div>
      </div>
      <div class="stat-card green">
        <div class="stat-header"><div class="stat-icon">✅</div><div class="stat-label">דוחות חתומים</div></div>
        <div class="stat-value">${signedCount}/${workers.length}</div>
      </div>
      <div class="stat-card red">
        <div class="stat-header"><div class="stat-icon">⚠️</div><div class="stat-label">משימות באיחור</div></div>
        <div class="stat-value">${overdue.length}</div>
      </div>`;
  }

  // ── Bar Chart: hours per worker this month ──────────────────────────────────
  const workerNames = workers.map(w => w.name.split(' ')[0]); // first name only
  const workerHours = workers.map(w => getWorkerHoursForMonth(w.id, analyticsYear, analyticsMonth));
  const barColors   = workers.map(w => w.avatarColor + 'cc');
  const barBorders  = workers.map(w => w.avatarColor);

  const ctxBar = document.getElementById('chart-worker-hours');
  if (ctxBar) {
    if (chartWorkerHours) { chartWorkerHours.destroy(); chartWorkerHours = null; }
    chartWorkerHours = new Chart(ctxBar, {
      type: 'bar',
      data: {
        labels: workerNames,
        datasets: [{
          label: 'שעות',
          data: workerHours,
          backgroundColor: barColors,
          borderColor: barBorders,
          borderWidth: 2,
          borderRadius: 8,
          borderSkipped: false,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => ` ${ctx.parsed.y} שעות`
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.06)' },
            ticks: { font: { family: 'Heebo', size: 11 }, color: '#6b7e96' }
          },
          x: {
            grid: { display: false },
            ticks: { font: { family: 'Heebo', size: 11 }, color: '#2d3a4a' }
          }
        }
      }
    });
  }

  // ── Line Chart: monthly comparison (last 6 months total) ───────────────────
  const months6 = [];
  const totals6 = [];
  for (let i = 5; i >= 0; i--) {
    let m = analyticsMonth - i, y = analyticsYear;
    if (m < 0) { m += 12; y--; }
    months6.push(monthNames[m].substring(0, 3) + ' ' + y.toString().slice(2));
    const total = workers.reduce((sum, w) => sum + getWorkerHoursForMonth(w.id, y, m), 0);
    totals6.push(Math.round(total * 10) / 10);
  }

  // Per-worker lines for last 6 months (max 5 workers to avoid clutter)
  const lineWorkers = workers.slice(0, 5);
  const lineColors = ['#7bb3d8','#6bc4a6','#e8c46a','#e88fa0','#d4a0c8'];
  const datasets = lineWorkers.map((w, i) => {
    const data = [];
    for (let k = 5; k >= 0; k--) {
      let m = analyticsMonth - k, y = analyticsYear;
      if (m < 0) { m += 12; y--; }
      data.push(getWorkerHoursForMonth(w.id, y, m));
    }
    return {
      label: w.name.split(' ')[0],
      data,
      borderColor: lineColors[i],
      backgroundColor: lineColors[i] + '22',
      borderWidth: 2.5,
      pointRadius: 4,
      pointHoverRadius: 6,
      tension: 0.35,
      fill: false,
    };
  });

  // Also add a "total" line
  datasets.unshift({
    label: 'סה"כ',
    data: totals6,
    borderColor: '#5a9bc8',
    backgroundColor: 'rgba(91,155,200,0.08)',
    borderWidth: 3,
    pointRadius: 5,
    pointHoverRadius: 7,
    tension: 0.35,
    fill: true,
    borderDash: [],
  });

  const ctxLine = document.getElementById('chart-monthly-comparison');
  if (ctxLine) {
    if (chartMonthly) { chartMonthly.destroy(); chartMonthly = null; }
    chartMonthly = new Chart(ctxLine, {
      type: 'line',
      data: { labels: months6, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { font: { family: 'Heebo', size: 11 }, color: '#6b7e96', boxWidth: 12, padding: 12 }
          },
          tooltip: {
            callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y} שע'` }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.06)' },
            ticks: { font: { family: 'Heebo', size: 11 }, color: '#6b7e96' }
          },
          x: {
            grid: { display: false },
            ticks: { font: { family: 'Heebo', size: 11 }, color: '#6b7e96' }
          }
        }
      }
    });
  }

  // ── Top Performers ──────────────────────────────────────────────────────────
  const topEl = document.getElementById('analytics-top-performers');
  if (topEl) {
    const ranked = [...workers]
      .map(w => ({ w, hrs: getWorkerHoursForMonth(w.id, analyticsYear, analyticsMonth) }))
      .sort((a, b) => b.hrs - a.hrs);
    const medals = ['🥇','🥈','🥉'];
    const maxHrs = ranked[0]?.hrs || 1;

    if (!ranked.length || ranked.every(r => r.hrs === 0)) {
      topEl.innerHTML = '<div class="empty-state"><div class="icon">📊</div><p>אין נתוני שעות לחודש זה</p></div>';
    } else {
      topEl.innerHTML = ranked.map((r, i) => `
        <div style="display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);${i === ranked.length - 1 ? 'border-bottom:none;' : ''}">
          <div style="font-size:20px;width:28px;text-align:center;flex-shrink:0;">${medals[i] || (i + 1)}</div>
          <div style="width:32px;height:32px;border-radius:50%;background:${r.w.avatarColor}33;color:${r.w.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;flex-shrink:0;">${r.w.name[0]}</div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.w.name}</div>
            <div style="margin-top:4px;background:var(--bg3);border-radius:20px;height:6px;overflow:hidden;">
              <div style="height:100%;border-radius:20px;background:${r.w.avatarColor};width:${maxHrs > 0 ? (r.hrs / maxHrs * 100).toFixed(1) : 0}%;transition:width 0.5s;"></div>
            </div>
          </div>
          <div style="font-size:15px;font-weight:800;color:${r.w.avatarColor};white-space:nowrap;flex-shrink:0;">${r.hrs.toFixed(1)} <span style="font-size:10px;font-weight:400;color:var(--text2);">שע'</span></div>
        </div>`).join('');
    }
  }

  // ── Month vs Prev Month comparison ─────────────────────────────────────────
  const compareEl = document.getElementById('analytics-month-compare');
  if (compareEl) {
    let pm = analyticsMonth - 1, py = analyticsYear;
    if (pm < 0) { pm = 11; py--; }

    const rows = workers.map(w => {
      const cur  = getWorkerHoursForMonth(w.id, analyticsYear, analyticsMonth);
      const prev = getWorkerHoursForMonth(w.id, py, pm);
      const diff = cur - prev;
      const pct  = prev > 0 ? ((diff / prev) * 100).toFixed(0) : (cur > 0 ? '+100' : '0');
      const arrow = diff > 0 ? '↑' : diff < 0 ? '↓' : '→';
      const clr   = diff > 0 ? '#3a9a7a' : diff < 0 ? '#c0506a' : '#6b7e96';
      return { w, cur, prev, diff, pct, arrow, clr };
    }).sort((a,b) => b.diff - a.diff);

    if (!rows.length) {
      compareEl.innerHTML = '<div class="empty-state"><div class="icon">🔄</div><p>אין נתונים להשוואה</p></div>';
    } else {
      compareEl.innerHTML = `
        <div style="font-size:11px;color:var(--text3);display:flex;justify-content:space-between;padding:0 4px;margin-bottom:8px;font-weight:600;">
          <span>פועל</span>
          <span>${monthNames[pm].substring(0,3)} → ${monthNames[analyticsMonth].substring(0,3)}</span>
        </div>` +
        rows.map(r => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px 4px;border-bottom:1px solid var(--border);">
          <div style="width:26px;height:26px;border-radius:50%;background:${r.w.avatarColor}33;color:${r.w.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:11px;flex-shrink:0;">${r.w.name[0]}</div>
          <div style="flex:1;font-size:12px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.w.name}</div>
          <div style="text-align:left;flex-shrink:0;">
            <div style="font-size:12px;color:var(--text2);">${r.prev.toFixed(1)} → ${r.cur.toFixed(1)}</div>
            <div style="font-size:11px;font-weight:700;color:${r.clr};">${r.arrow} ${Math.abs(r.diff).toFixed(1)} שע' (${r.pct}%)</div>
          </div>
        </div>`).join('');
    }
  }
}

function renderCeoDashboard() {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!company) return;
  document.getElementById('ceo-company-emoji').textContent = company.emoji;
  document.getElementById('ceo-company-name').textContent = company.name;
  document.getElementById('ceo-company-field').textContent = company.field;

  const emps = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const tasks = DATA.tasks.filter(t => t.company === currentUser.company);
  const openTasks = tasks.filter(t => t.status === 'open');
  const doneTasks = tasks.filter(t => t.status === 'done');

  document.getElementById('ceo-stat-employees').textContent = emps.length;
  document.getElementById('ceo-stat-workers').textContent = workers.length;
  document.getElementById('ceo-stat-tasks').textContent = openTasks.length;
  document.getElementById('ceo-stat-done').textContent = doneTasks.length;

  // Also render analytics section
  renderCeoAnalytics();
}

function renderCeoEmployees() {
  const tbody = document.getElementById('ceo-employees-table');
  const emps = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
  if (!emps.length) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text3);padding:24px;">אין עובדים</td></tr>'; return; }
  tbody.innerHTML = emps.map(emp => {
    const empTasks = DATA.tasks.filter(t => t.assignedTo === emp.id);
    const open = empTasks.filter(t => t.status === 'open').length;
    const done = empTasks.filter(t => t.status === 'done').length;
    const total = empTasks.length;
    const pct = total ? Math.round(done/total*100) : 0;
    return `
    <tr>
      <td><div style="display:flex;align-items:center;gap:8px;">
        <div style="width:32px;height:32px;border-radius:50%;background:${emp.avatarColor}33;color:${emp.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:700;">${emp.name[0]}</div>
        <div><div style="font-weight:600;">${emp.name}</div><div style="font-size:11px;color:var(--text3);">${emp.username}</div></div>
      </div></td>
      <td><span class="tag tag-blue">עובד</span></td>
      <td><span class="tag tag-yellow">${open}</span></td>
      <td><span class="tag tag-green">${done}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:8px;">
          <div class="progress-bar" style="width:100px;"><div class="progress-fill" style="width:${pct}%;background:#7bb3d8;"></div></div>
          <span style="font-size:12px;color:var(--text2);">${pct}%</span>
        </div>
      </td>
      <td>
        <button class="btn btn-primary btn-sm" onclick="openAssignTask(${emp.id})">+ משימה</button>
      </td>
    </tr>`;
  }).join('');
}

function renderCeoCredentials(searchQ) {
  const isFieldWorker = currentUser.role === 'employee' && currentUser.fieldWorker;
  const empBody = document.getElementById('ceo-emp-creds-table');
  const workerBody = document.getElementById('ceo-worker-creds-table');

  // Hide employees section for fieldWorker
  const empCard = empBody?.closest('.card');
  if (empCard) empCard.style.display = isFieldWorker ? 'none' : '';

  const q = (searchQ || '').toLowerCase().trim();
  let emps = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
  let workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  if (q) {
    emps = emps.filter(u => u.name.toLowerCase().includes(q) || u.username.toLowerCase().includes(q));
    workers = workers.filter(u => u.name.toLowerCase().includes(q) || u.username.toLowerCase().includes(q));
    document.getElementById('topbarInfo').textContent = `${(isFieldWorker ? 0 : emps.length) + workers.length} תוצאות`;
  } else {
    document.getElementById('topbarInfo').textContent = '';
  }

  function credRow(u, prefix) {
    const idIcon = u.idType === 'passport' ? '🛂' : '🪪';
    const idLabel = u.idType === 'passport' ? 'דרכון' : 'ת"ז';
    const idDisplay = u.idNumber
      ? `<span style="font-size:12px;display:flex;align-items:center;gap:4px;">${idIcon} <span style="font-family:monospace;">${u.idNumber}</span> <span style="font-size:10px;color:var(--text3);">(${idLabel})</span></span>`
      : `<span style="color:var(--text3);font-size:12px;">—</span>`;
    // fieldWorker sees only password-change button for workers
    const actionsHtml = (isFieldWorker && u.role === 'worker')
      ? `<td><button class="btn btn-outline btn-sm" onclick="fieldWorkerChangePass(${u.id})" title="שנה סיסמה">🔑 סיסמה</button></td>`
      : `<td><div style="display:flex;gap:6px;">
          <button class="btn btn-primary btn-sm" onclick="ceoEditCredentials(${u.id})" title="ערוך פרטי כניסה">✏️ ערוך</button>
          <button class="btn btn-danger btn-sm" onclick="ceoDeleteMember(${u.id})" title="מחק">🗑️</button>
         </div></td>`;
    return `<tr>
      <td><div style="display:flex;align-items:center;gap:8px;">
        <div style="width:30px;height:30px;border-radius:50%;background:${u.avatarColor}33;color:${u.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;">${u.name[0]}</div>
        <span style="font-weight:600;">${highlightText(u.name, q)}</span>
      </div></td>
      <td><code style="background:var(--bg3);padding:3px 10px;border-radius:6px;font-size:13px;">${highlightText(u.username, q)}</code></td>
      <td>${idDisplay}</td>
      <td><div style="display:flex;align-items:center;gap:8px;">
        <span id="ceo-pass-${prefix}-${u.id}" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 12px;font-size:12px;font-family:monospace;letter-spacing:2px;">••••••••</span>
        <button onclick="ceoPwToggle('${prefix}',${u.id},'${u.password}')" id="ceo-eye-${prefix}-${u.id}" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 8px;cursor:pointer;font-size:13px;color:var(--text2);">👁️</button>
      </div></td>
      ${actionsHtml}
    </tr>`;
  }

  empBody.innerHTML = emps.length ? emps.map(u => credRow(u,'emp')).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:20px;">אין עובדים</td></tr>';
  workerBody.innerHTML = workers.length ? workers.map(u => credRow(u,'wkr')).join('') : '<tr><td colspan="5" style="text-align:center;color:var(--text3);padding:20px;">אין פועלים</td></tr>';
}

const ceoPwVisible = {};
function ceoPwToggle(prefix, userId, password) {
  const key = `${prefix}-${userId}`;
  ceoPwVisible[key] = !ceoPwVisible[key];
  const el = document.getElementById(`ceo-pass-${key}`);
  const btn = document.getElementById(`ceo-eye-${key}`);
  if (el) el.textContent = ceoPwVisible[key] ? password : '••••••••';
  if (btn) btn.textContent = ceoPwVisible[key] ? '🙈' : '👁️';
}

function fieldWorkerChangePass(userId) {
  const u = DATA.users.find(x => x.id === userId);
  if (!u) return;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">🔑 שינוי סיסמה — ${u.name}</div>
    <div style="background:var(--bg3);border-radius:10px;padding:12px 16px;margin-bottom:18px;display:flex;align-items:center;gap:10px;">
      <div style="width:34px;height:34px;border-radius:50%;background:${u.avatarColor}33;color:${u.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">${u.name[0]}</div>
      <div><div style="font-weight:700;font-size:14px;">${u.name}</div><div style="font-size:11px;color:var(--text2);">פועל</div></div>
    </div>
    <div class="form-group">
      <label>סיסמה חדשה</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="password" id="fw-new-pass" class="form-input" placeholder="סיסמה חדשה..." style="flex:1;">
        <button onclick="(()=>{const i=document.getElementById('fw-new-pass');i.type=i.type==='password'?'text':'password';this.textContent=i.type==='password'?'👁️':'🙈'})()" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;cursor:pointer;font-size:14px;">👁️</button>
      </div>
    </div>
    <div class="form-group">
      <label>אימות סיסמה</label>
      <input type="password" id="fw-confirm-pass" class="form-input" placeholder="הכנס שוב...">
    </div>
    <div id="fw-pass-error" style="color:#c0506a;font-size:12px;margin-bottom:10px;display:none;padding:8px 12px;background:#fff5f5;border-radius:6px;border:1px solid #f0c0c8;"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="fieldWorkerSavePass(${userId})">🔑 עדכן סיסמה</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
  setTimeout(() => document.getElementById('fw-new-pass')?.focus(), 100);
}

async function fieldWorkerSavePass(userId) {
  const u = DATA.users.find(x => x.id === userId);
  const errEl = document.getElementById('fw-pass-error');
  const np = document.getElementById('fw-new-pass').value.trim();
  const cp = document.getElementById('fw-confirm-pass').value.trim();
  if (!np) { errEl.textContent = '❌ יש להזין סיסמה'; errEl.style.display = 'block'; return; }
  if (np.length < 4) { errEl.textContent = '❌ הסיסמה חייבת להכיל לפחות 4 תווים'; errEl.style.display = 'block'; return; }
  if (np !== cp) { errEl.textContent = '❌ הסיסמאות אינן תואמות'; errEl.style.display = 'block'; return; }
  if (HAS_SUPABASE) {
    await sbUpdateUser(userId, { password: np });
  } else {
    if (u) u.password = np;
  }
  closeModal();
  renderCeoCredentials();
  showToast(`✅ סיסמת ${u?.name} עודכנה!`);
}

function ceoEditCredentials(userId) {
  const user = DATA.users.find(u => u.id === userId);
  if (!user) return;
  const roleLabel = user.role === 'employee' ? 'עובד' : 'פועל';
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">✏️ עריכת פרטי עובד — ${user.name}</div>
    <div style="background:var(--bg3);border-radius:10px;padding:12px 16px;margin-bottom:18px;display:flex;align-items:center;gap:10px;">
      <div style="width:36px;height:36px;border-radius:50%;background:${user.avatarColor}33;color:${user.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;">${user.name[0]}</div>
      <div><div style="font-weight:700;font-size:14px;">${user.name}</div><div style="font-size:11px;color:var(--text2);">${roleLabel}</div></div>
    </div>

    <!-- Name + Role -->
    <div style="display:flex;gap:10px;margin-bottom:14px;">
      <div style="flex:2;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">שם מלא</label>
        <input type="text" id="ceo-edit-name" class="form-input" value="${user.name}" placeholder="שם מלא...">
      </div>
      <div style="flex:1;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">תפקיד</label>
        <select id="ceo-edit-role" class="form-input" style="padding:8px 12px;">
          <option value="employee" ${user.role === 'employee' ? 'selected' : ''}>💼 עובד</option>
          <option value="worker" ${user.role === 'worker' ? 'selected' : ''}>🔧 פועל</option>
        </select>
      </div>
    </div>

    ${user.role === 'employee' ? `
    <div style="background:linear-gradient(135deg,#f0ebff,#e8f0ff);border:1px solid #c8b8f0;border-radius:12px;padding:14px 16px;margin-bottom:10px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <div style="font-size:13px;font-weight:700;color:#5a4a8a;">👑 ממשק עובד מורחב</div>
          <div style="font-size:11px;color:#8878b0;margin-top:3px;">עובד זה יראה ממשק מנכ"ל עם גישה לניהול החברה</div>
        </div>
        <div onclick="toggleCeoInterfaceUI()" id="ceo-interface-toggle-wrap"
          style="width:44px;height:24px;border-radius:24px;background:${user.ceoInterface ? '#8b6cda' : '#ccc'};cursor:pointer;position:relative;transition:background 0.25s;flex-shrink:0;">
          <div id="ceo-interface-thumb"
            style="position:absolute;top:3px;width:18px;height:18px;border-radius:50%;background:white;box-shadow:0 1px 3px rgba(0,0,0,0.2);transition:left 0.25s;left:${user.ceoInterface ? '23px' : '3px'};"></div>
        </div>
        <input type="hidden" id="ceo-edit-ceointerface" value="${user.ceoInterface ? '1' : '0'}">
      </div>
    </div>
    <div style="background:linear-gradient(135deg,#fff3e0,#fff8ee);border:1px solid #f0c870;border-radius:12px;padding:14px 16px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
        <div>
          <div style="font-size:13px;font-weight:700;color:#9a6a10;">🏗️ עובד שטח</div>
          <div style="font-size:11px;color:#b08030;margin-top:3px;">גישה לניהול פועלים ושעות + פניות פועלים, ללא הוספת עובדים</div>
        </div>
        <div onclick="toggleFieldWorkerUI()" id="fieldworker-toggle-wrap"
          style="width:44px;height:24px;border-radius:24px;background:${user.fieldWorker ? '#e8a820' : '#ccc'};cursor:pointer;position:relative;transition:background 0.25s;flex-shrink:0;">
          <div id="fieldworker-thumb"
            style="position:absolute;top:3px;width:18px;height:18px;border-radius:50%;background:white;box-shadow:0 1px 3px rgba(0,0,0,0.2);transition:left 0.25s;left:${user.fieldWorker ? '23px' : '3px'};"></div>
        </div>
        <input type="hidden" id="ceo-edit-fieldworker" value="${user.fieldWorker ? '1' : '0'}">
      </div>
    </div>` : ''}

    <div class="form-group">
      <label>שם משתמש</label>
      <input type="text" id="ceo-edit-username" class="form-input" value="${user.username}" placeholder="שם משתמש...">
      <div style="font-size:11px;color:var(--text3);margin-top:4px;">שם המשתמש חייב להיות באנגלית, ללא רווחים</div>
    </div>

    <div style="border-top:1px solid var(--border);margin:16px 0;"></div>

    <div style="display:flex;gap:10px;margin-bottom:14px;">
      <div style="flex:1;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">סוג מסמך</label>
        <select id="ceo-edit-idtype" class="form-input" style="padding:8px 12px;">
          <option value="id" ${(!user.idType || user.idType==='id') ? 'selected' : ''}>🪪 תעודת זהות</option>
          <option value="passport" ${user.idType==='passport' ? 'selected' : ''}>🛂 דרכון</option>
        </select>
      </div>
      <div style="flex:2;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">מספר מסמך</label>
        <input type="text" id="ceo-edit-idnumber" class="form-input" value="${user.idNumber || ''}" placeholder="מספר ת&quot;ז / דרכון...">
      </div>
    </div>

    <div style="border-top:1px solid var(--border);margin:16px 0;"></div>

    <div class="form-group">
      <label>סיסמה חדשה <span style="color:var(--text3);font-weight:400;font-size:11px;">(השאר ריק אם לא רוצה לשנות)</span></label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input type="password" id="ceo-new-pass" class="form-input" placeholder="סיסמה חדשה..." style="flex:1;">
        <button onclick="toggleCeoNewPass()" id="ceo-new-pass-eye" style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;cursor:pointer;font-size:14px;flex-shrink:0;">👁️</button>
      </div>
    </div>
    <div class="form-group">
      <label>אימות סיסמה</label>
      <input type="password" id="ceo-confirm-pass" class="form-input" placeholder="הכנס שוב את הסיסמה...">
    </div>

    <div id="ceo-pass-error" style="color:#c0506a;font-size:12px;margin-bottom:10px;display:none;padding:8px 12px;background:#fff5f5;border-radius:6px;border:1px solid #f0c0c8;"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="ceoSaveCredentials(${userId})">💾 שמור שינויים</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
  setTimeout(() => document.getElementById('ceo-edit-name')?.focus(), 100);
}

function toggleCeoNewPass() {
  const input = document.getElementById('ceo-new-pass');
  const btn = document.getElementById('ceo-new-pass-eye');
  if (!input) return;
  input.type = input.type === 'password' ? 'text' : 'password';
  btn.textContent = input.type === 'password' ? '👁️' : '🙈';
}

function toggleCeoInterfaceUI() {
  const input = document.getElementById('ceo-edit-ceointerface');
  const wrap  = document.getElementById('ceo-interface-toggle-wrap');
  const thumb = document.getElementById('ceo-interface-thumb');
  if (!input) return;
  const on = input.value !== '1';
  input.value = on ? '1' : '0';
  wrap.style.background  = on ? '#8b6cda' : '#ccc';
  thumb.style.left       = on ? '23px' : '3px';
  // Mutually exclusive: turn off fieldWorker if ceoInterface is on
  if (on) {
    const fw = document.getElementById('ceo-edit-fieldworker');
    const fwWrap = document.getElementById('fieldworker-toggle-wrap');
    const fwThumb = document.getElementById('fieldworker-thumb');
    if (fw) { fw.value = '0'; if (fwWrap) fwWrap.style.background = '#ccc'; if (fwThumb) fwThumb.style.left = '3px'; }
  }
}

function toggleFieldWorkerUI() {
  const input = document.getElementById('ceo-edit-fieldworker');
  const wrap  = document.getElementById('fieldworker-toggle-wrap');
  const thumb = document.getElementById('fieldworker-thumb');
  if (!input) return;
  const on = input.value !== '1';
  input.value = on ? '1' : '0';
  wrap.style.background = on ? '#e8a820' : '#ccc';
  thumb.style.left      = on ? '23px' : '3px';
  // Mutually exclusive: turn off ceoInterface if fieldWorker is on
  if (on) {
    const ci = document.getElementById('ceo-edit-ceointerface');
    const ciWrap = document.getElementById('ceo-interface-toggle-wrap');
    const ciThumb = document.getElementById('ceo-interface-thumb');
    if (ci) { ci.value = '0'; if (ciWrap) ciWrap.style.background = '#ccc'; if (ciThumb) ciThumb.style.left = '3px'; }
  }
}

async function ceoSaveCredentials(userId) {
  const user = DATA.users.find(u => u.id === userId);
  if (!user) return;
  const errEl = document.getElementById('ceo-pass-error');
  errEl.style.display = 'none';

  const newName = document.getElementById('ceo-edit-name').value.trim();
  const newRole = document.getElementById('ceo-edit-role').value;
  const newUsername = document.getElementById('ceo-edit-username').value.trim();
  const newIdType = document.getElementById('ceo-edit-idtype').value;
  const newIdNumber = document.getElementById('ceo-edit-idnumber').value.trim();
  const newPass = document.getElementById('ceo-new-pass').value.trim();
  const confirm = document.getElementById('ceo-confirm-pass').value.trim();

  if (!newName) { errEl.textContent = '❌ שם מלא לא יכול להיות ריק'; errEl.style.display = 'block'; return; }
  if (!newUsername) { errEl.textContent = '❌ שם משתמש לא יכול להיות ריק'; errEl.style.display = 'block'; return; }
  if (/\s/.test(newUsername)) { errEl.textContent = '❌ שם משתמש לא יכול להכיל רווחים'; errEl.style.display = 'block'; return; }
  if (newUsername !== user.username && DATA.users.find(u => u.username === newUsername)) {
    errEl.textContent = '❌ שם משתמש זה כבר קיים במערכת'; errEl.style.display = 'block'; return;
  }
  if (newPass) {
    if (newPass.length < 4) { errEl.textContent = '❌ הסיסמה חייבת להכיל לפחות 4 תווים'; errEl.style.display = 'block'; return; }
    if (newPass !== confirm) { errEl.textContent = '❌ הסיסמאות אינן תואמות'; errEl.style.display = 'block'; return; }
  }

  const ceoInterfaceEl = document.getElementById('ceo-edit-ceointerface');
  const fieldWorkerEl  = document.getElementById('ceo-edit-fieldworker');
  const updates = {
    name: newName, role: newRole, username: newUsername,
    id_type: newIdType, id_number: newIdNumber,
    avatar: newRole === 'employee' ? '💼' : '🔧',
    avatar_color: newRole === 'employee' ? '#4ade80' : '#fb923c',
    ceo_interface: ceoInterfaceEl ? ceoInterfaceEl.value === '1' : false,
    field_worker: fieldWorkerEl ? fieldWorkerEl.value === '1' : false,
  };
  if (newPass) updates.password = newPass;

  if (HAS_SUPABASE) {
    const res = await sbUpdateUser(userId, updates);
    if (!res.ok) { errEl.textContent = res.data?.error || '❌ שגיאת שרת'; errEl.style.display = 'block'; return; }
  } else {
    Object.assign(user, { name: updates.name, role: updates.role, username: updates.username,
      idType: updates.id_type, idNumber: updates.id_number,
      avatar: updates.avatar, avatarColor: updates.avatar_color,
      ceoInterface: updates.ceo_interface, fieldWorker: updates.field_worker });
    if (newPass) user.password = newPass;
  }

  closeModal();
  renderCeoCredentials();
  showToast(`✅ פרטי ${newName} עודכנו בהצלחה!`);
}

async function confirmCeoDeleteMember(userId) {
  const user = DATA.users.find(u => u.id === userId);
  if (!user) return;
  const name = user.name;
  if (HAS_SUPABASE) {
    const res = await sbDeleteUser(userId);
    if (!res.ok) { showToast('❌ שגיאה במחיקה', 'error'); return; }
  } else {
    DATA.users.splice(DATA.users.findIndex(u => u.id === userId), 1);
    DATA.tasks.forEach(t => { if (t.assignedTo === userId) t.assignedTo = null; });
  }
  closeModal();
  renderCeoCredentials();
  showToast(`🗑️ ${name} נמחק מהמערכת`);
}

function toggleSection(sectionId, iconId) {
  const section = document.getElementById(sectionId);
  const icon = document.getElementById(iconId);
  if (!section) return;
  const isOpen = section.style.display !== 'none';
  section.style.display = isOpen ? 'none' : '';
  if (icon) icon.style.transform = isOpen ? 'rotate(-90deg)' : 'rotate(0deg)';
}

function filterWorkersTable() {
  const searchType = document.getElementById('workers-search-type')?.value || 'name';
  const searchQ = (document.getElementById('workers-search-input')?.value || '').trim().toLowerCase();
  const countEl = document.getElementById('workers-search-count');

  const tbody = document.getElementById('ceo-workers-table');
  if (!tbody) return;

  const rows = tbody.querySelectorAll('tr');
  let visible = 0;

  rows.forEach(tr => {
    const workerId = parseInt(tr.dataset.workerId);
    if (!workerId) { tr.style.display = ''; return; }
    const worker = DATA.users.find(u => u.id === workerId);
    if (!worker) { tr.style.display = ''; return; }

    let match = true;
    if (searchQ) {
      if (searchType === 'name') match = worker.name.toLowerCase().includes(searchQ);
      else match = (worker.idNumber || '').toLowerCase().includes(searchQ);
    }

    tr.style.display = match ? '' : 'none';
    if (match) visible++;
  });

  if (countEl) {
    const total = rows.length;
    countEl.textContent = searchQ ? `${visible} מתוך ${total} פועלים` : '';
  }
}

function renderCeoWorkers() {
  // Hide add/import buttons for field workers
  const isFieldWorker = currentUser.role === 'employee' && currentUser.fieldWorker;
  const actionBtns = document.getElementById('workers-action-btns');
  if (actionBtns) actionBtns.style.display = isFieldWorker ? 'none' : 'flex';

  const tbody = document.getElementById('ceo-workers-table');
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!workers.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--text3);padding:24px;">אין פועלים</td></tr>'; return; }
  const now = new Date();
  const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();

  tbody.innerHTML = workers.map(w => {
    const key = `${w.id}-${now.getFullYear()}-${now.getMonth()}`;
    const hours = DATA.workerHours[key] || {};
    const signedInfo = company && company.signed[key];
    const isFullSigned = signedInfo && signedInfo.type === 'full';
    const partialDays = (signedInfo && signedInfo.type === 'partial') ? signedInfo.days : [];

    // Calculate total, signed, and unsigned hours
    let totalH = 0, signedH = 0, unsignedH = 0;
    for (let d = 1; d <= daysInMonth; d++) {
      const v = hours[d];
      if (!v) continue;
      const h = v.start && v.end
        ? calcHoursFromTime(v.start, v.end)
        : (parseFloat(v.hours) || 0);
      if (h <= 0) continue;
      totalH += h;
      const isDaySigned = isFullSigned || partialDays.includes(d);
      if (isDaySigned) signedH += h;
      else unsignedH += h;
    }

    // Status badge
    let statusBadge;
    if (isFullSigned) {
      statusBadge = '<span class="tag tag-green">✅ כל החודש</span>';
    } else if (partialDays.length > 0) {
      statusBadge = `<span class="tag tag-purple">📅 ${partialDays.length} ימים</span>`;
    } else {
      statusBadge = '<span class="tag tag-red">❌ לא חתום</span>';
    }

    return `
    <tr data-worker-id="${w.id}">
      <td><div style="display:flex;align-items:center;gap:8px;">
        <div style="width:32px;height:32px;border-radius:50%;background:${w.avatarColor}33;color:${w.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:700;">${w.name[0]}</div>
        <div>
          <div style="font-weight:600;">${w.name}</div>
          ${w.idNumber ? `<div style="font-size:10px;color:var(--text3);">${w.idType==='passport'?'🛂':'🪪'} ${w.idNumber}</div>` : ''}
        </div>
      </div></td>
      <td><span style="font-size:16px;font-weight:800;color:#4a6080;">${totalH.toFixed(1)}</span> <span style="color:var(--text2);font-size:11px;">שע'</span></td>
      <td><span style="font-size:15px;font-weight:700;color:#3a9a7a;">${signedH > 0 ? signedH.toFixed(1) : '—'}</span>${signedH > 0 ? ' <span style="color:var(--text2);font-size:11px;">שע\'</span>' : ''}</td>
      <td><span style="font-size:15px;font-weight:700;color:${unsignedH > 0 ? '#c07030' : 'var(--text3)'};">${unsignedH > 0 ? unsignedH.toFixed(1) : '—'}</span>${unsignedH > 0 ? ' <span style="color:var(--text2);font-size:11px;">שע\'</span>' : ''}</td>
      <td>${statusBadge}</td>
      <td><button class="btn btn-outline btn-sm" onclick="viewWorkerReport(${w.id})">👁️ צפייה</button></td>
      <td><div style="display:flex;gap:6px;">
        ${signedInfo ? `<button class="btn btn-outline btn-sm" onclick="ceoUnsignWorker(${w.id})" title="בטל חתימה">🔓 בטל</button>` : ''}
        <button class="btn btn-danger btn-sm" onclick="removeWorker(${w.id})">🗑️</button>
      </div></td>
    </tr>`;
  }).join('');

  // Update current sig password display
  if (company) {
    document.getElementById('sigPasswordInput').value = '';
    const dispEl = document.getElementById('current-sig-pass-display');
    if (dispEl) { dispEl.textContent = '••••••••'; dispEl.dataset.pass = company.sigPassword || ''; }
    const eyeEl = document.getElementById('current-sig-pass-eye');
    if (eyeEl) eyeEl.textContent = '👁️';
    sigPassVisible = false;
  }
}

let gridZoomNormal = 11;   // px for inline grid
let gridZoomFS = 13;       // px for fullscreen grid

function stepGridZoom(delta, isFS) {
  const currentVal = isFS ? gridZoomFS : gridZoomNormal;
  const min = isFS ? 7 : 7;
  const max = isFS ? 22 : 18;
  const newVal = Math.min(max, Math.max(min, currentVal + delta));
  applyGridZoom(newVal, isFS);
}

function updateSliderFill(slider) {
  if (!slider) return;
  const min = parseFloat(slider.min);
  const max = parseFloat(slider.max);
  const val = parseFloat(slider.value);
  const pct = ((val - min) / (max - min)) * 100;
  slider.style.background = `linear-gradient(to left, var(--accent) ${pct}%, var(--border) ${pct}%)`;
}

function applyGridZoom(val, isFS) {
  const size = parseFloat(val);
  const cellW = Math.max(28, Math.round(size * 3.0));
  const nameW = Math.max(80, Math.round(size * 9));

  if (isFS) {
    gridZoomFS = size;
    const lbl = document.getElementById('fs-grid-zoom-label');
    const slider = document.getElementById('fs-grid-zoom-slider');
    if (lbl) lbl.textContent = Math.round(size) + 'px';
    if (slider) { slider.value = size; updateSliderFill(slider); }
    const table = document.querySelector('#fs-workers-grid-wrap .hours-grid-table');
    if (table) applyZoomToTable(table, size, cellW, nameW);
  } else {
    gridZoomNormal = size;
    const lbl = document.getElementById('grid-zoom-label');
    const slider = document.getElementById('grid-zoom-slider');
    if (lbl) lbl.textContent = Math.round(size) + 'px';
    if (slider) { slider.value = size; updateSliderFill(slider); }
    const table = document.querySelector('#workers-grid-wrap .hours-grid-table');
    if (table) applyZoomToTable(table, size, cellW, nameW);
  }
}

function fitGridToScreen(isFS) {
  // Calculate the available width and compute optimal font size so all columns fit
  const daysInMonth = new Date(gridYear, gridMonth + 1, 0).getDate();
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');

  let containerWidth;
  if (isFS) {
    containerWidth = window.innerWidth - 80; // overlay padding
  } else {
    const container = document.getElementById('grid-scroll-container');
    containerWidth = container ? container.clientWidth : window.innerWidth - 300;
  }

  // nameCol + daysInMonth day cols + total col
  // Try sizes from 7 to 18, pick the largest that fits
  let bestSize = 7;
  for (let s = 18; s >= 7; s -= 0.5) {
    const cellW = Math.max(28, Math.round(s * 3.0));
    const nameW = Math.max(80, Math.round(s * 9));
    const totalWidth = nameW + (daysInMonth * cellW) + 55; // 55 for totals col
    if (totalWidth <= containerWidth) {
      bestSize = s;
      break;
    }
  }

  applyGridZoom(bestSize, isFS);
  applyGridZoom(bestSize, isFS);
}


function applyZoomToTable(table, size, cellW, nameW) {
  table.style.fontSize = size + 'px';
  // Set th/td sizes
  const allTh = table.querySelectorAll('th');
  const allTd = table.querySelectorAll('td');
  allTh.forEach(el => {
    if (el.classList.contains('worker-name-col')) { el.style.minWidth = nameW + 'px'; el.style.maxWidth = (nameW + 20) + 'px'; }
    else { el.style.minWidth = cellW + 'px'; el.style.padding = Math.max(2, size * 0.4) + 'px ' + Math.max(1, size * 0.2) + 'px'; }
  });
  allTd.forEach(el => {
    if (el.classList.contains('worker-name-td')) { el.style.minWidth = nameW + 'px'; }
    else if (!el.classList.contains('total-td')) { el.style.minWidth = cellW + 'px'; el.style.padding = Math.max(2, size * 0.4) + 'px ' + Math.max(1, size * 0.2) + 'px'; }
  });
}

function openGridFullscreen() {
  const overlay = document.getElementById('gridFullscreenOverlay');
  overlay.style.display = 'block';
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const subtitle = document.getElementById('fs-grid-subtitle');
  if (subtitle) subtitle.textContent = `${company ? company.name : ''} • ${workers.length} פועלים`;
  // Sync FS slider
  const fsSlider = document.getElementById('fs-grid-zoom-slider');
  const fsLbl = document.getElementById('fs-grid-zoom-label');
  if (fsSlider) fsSlider.value = gridZoomFS;
  if (fsLbl) fsLbl.textContent = gridZoomFS + 'px';
  renderCeoWorkersGrid(true);
  document.addEventListener('keydown', _fsGridEscHandler);
}

function closeGridFullscreen() {
  document.getElementById('gridFullscreenOverlay').style.display = 'none';
  document.removeEventListener('keydown', _fsGridEscHandler);
}

function _fsGridEscHandler(e) {
  if (e.key === 'Escape') closeGridFullscreen();
}

function changeGridMonthFS(delta) {
  gridMonth += delta;
  if (gridMonth > 11) { gridMonth = 0; gridYear++; }
  if (gridMonth < 0) { gridMonth = 11; gridYear--; }
  // Update both grids
  renderCeoWorkersGrid(false);
  renderCeoWorkersGrid(true);
}


let gridYear = new Date().getFullYear();
let gridMonth = new Date().getMonth();

function changeGridMonth(delta) {
  gridMonth += delta;
  if (gridMonth > 11) { gridMonth = 0; gridYear++; }
  if (gridMonth < 0) { gridMonth = 11; gridYear--; }
  renderCeoWorkersGrid(false);
}

function renderCeoWorkersGrid(fullscreen) {
  const monthNames = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];
  const dayNames = ['א׳','ב׳','ג׳','ד׳','ה׳','ו׳','ש׳'];
  const monthLabel = `${monthNames[gridMonth]} ${gridYear}`;

  // Update both month labels
  const labelEl = document.getElementById('grid-month-label');
  if (labelEl) labelEl.textContent = monthLabel;
  const fsLabelEl = document.getElementById('fs-grid-month-label');
  if (fsLabelEl) fsLabelEl.textContent = monthLabel;

  const wrap = document.getElementById(fullscreen ? 'fs-workers-grid-wrap' : 'workers-grid-wrap');
  if (!wrap) return;

  let workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const company = DATA.companies.find(c => c.id === currentUser.company);

  // Apply search filter (inline or fullscreen)
  const searchTypeId = fullscreen ? 'fs-grid-search-type' : 'grid-search-type';
  const searchInputId = fullscreen ? 'fs-grid-search-input' : 'grid-search-input';
  const searchCountId = fullscreen ? 'fs-grid-search-count' : 'grid-search-count';
  const searchType = document.getElementById(searchTypeId)?.value || 'name';
  const searchQ = (document.getElementById(searchInputId)?.value || '').trim().toLowerCase();
  const showIdInCell = searchType === 'idpassport'; // show ID number column regardless of search text

  if (searchQ) {
    workers = workers.filter(w => {
      if (searchType === 'name') return w.name.toLowerCase().includes(searchQ);
      if (searchType === 'idpassport') return (w.idNumber || '').toLowerCase().includes(searchQ);
      return true;
    });
  }
  const countEl = document.getElementById(searchCountId);
  if (countEl) {
    const totalWorkers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker').length;
    countEl.textContent = searchQ ? `${workers.length} מתוך ${totalWorkers} פועלים` : '';
  }

  if (!workers.length) { wrap.innerHTML = '<div style="text-align:center;color:var(--text3);padding:24px;">לא נמצאו פועלים תואמים לחיפוש</div>'; return; }

  const daysInMonth = new Date(gridYear, gridMonth + 1, 0).getDate();
  const todayDate = new Date();
  const todayDay = (todayDate.getFullYear() === gridYear && todayDate.getMonth() === gridMonth) ? todayDate.getDate() : -1;

  // Header column label changes when showing IDs
  const nameColLabel = showIdInCell ? 'ת"ז / דרכון \\ יום' : 'פועל \\ יום';
  let headerCells = `<th class="worker-name-col">${nameColLabel}</th>`;
  for (let d = 1; d <= daysInMonth; d++) {
    const dayIdx = new Date(gridYear, gridMonth, d).getDay();
    const isWeekend = dayIdx === 5 || dayIdx === 6;
    const isToday = d === todayDay;
    const cls = isToday ? 'today-col' : (isWeekend ? 'weekend-col' : '');
    const todayMark = isToday ? '<div style="font-size:7px;margin-top:1px;color:#3366aa;">●</div>' : '';
    headerCells += `<th class="${cls}" title="${d}/${gridMonth+1} ${dayNames[dayIdx]}">${d}<br><span style="font-size:8px;opacity:0.7;">${dayNames[dayIdx]}</span>${todayMark}</th>`;
  }
  headerCells += `<th class="total-col">סה"כ</th>`;

  // Build worker rows
  let workerRows = '';
  const dayTotals = new Array(daysInMonth + 1).fill(0);

  workers.forEach(w => {
    const key = `${w.id}-${gridYear}-${gridMonth}`;
    const hours = DATA.workerHours[key] || {};
    const signedInfo = company && company.signed[key];
    const isFullSigned = signedInfo && signedInfo.type === 'full';
    const partialDays = (signedInfo && signedInfo.type === 'partial') ? signedInfo.days : [];

    let workerTotal = 0;
    let dayCells = '';
    for (let d = 1; d <= daysInMonth; d++) {
      const dayIdx = new Date(gridYear, gridMonth, d).getDay();
      const isWeekend = dayIdx === 5 || dayIdx === 6;
      const isToday = d === todayDay;
      const entry = hours[d];
      const h = entry
        ? (entry.start && entry.end ? calcHoursFromTime(entry.start, entry.end) : (parseFloat(entry.hours) || 0))
        : 0;
      if (h > 0) { workerTotal += h; dayTotals[d] += h; }
      const isDaySigned = isFullSigned || partialDays.includes(d);

      let cls = '';
      if (isToday) cls = 'today-col';
      else if (isWeekend) cls = 'weekend-col';
      if (isDaySigned && h > 0) cls += ' signed-cell';
      if (h > 0) cls += ' has-hours';

      const signedDot = isDaySigned && h > 0 ? '<span style="color:#3a9a7a;font-size:7px;display:block;line-height:1;">✓</span>' : '';
      const display = h > 0 ? (h % 1 === 0 ? h.toFixed(0) : h.toFixed(1)) : '';
      dayCells += `<td class="${cls.trim()}" title="${d}/${gridMonth+1}: ${h > 0 ? h.toFixed(1)+' שעות' : 'ללא נוכחות'}">${display}${signedDot}</td>`;
    }

    // Name cell content: show ID number when in ID search mode
    const idIcon = w.idType === 'passport' ? '🛂' : '🪪';
    const nameCellContent = showIdInCell
      ? `<div style="display:flex;align-items:center;gap:4px;"><span style="font-size:11px;">${idIcon}</span><span style="font-family:monospace;font-size:10px;">${w.idNumber || '—'}</span></div>`
      : `<div style="display:flex;align-items:center;gap:5px;">
          <div style="width:20px;height:20px;border-radius:50%;background:${w.avatarColor}33;color:${w.avatarColor};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:9px;flex-shrink:0;">${w.name[0]}</div>
          <span>${w.name}</span>
        </div>`;

    workerRows += `
    <tr>
      <td class="worker-name-td" title="${w.name}${w.idNumber ? ' | '+(w.idType==='passport'?'דרכון':'ת"ז')+': '+w.idNumber : ''}">
        ${nameCellContent}
      </td>
      ${dayCells}
      <td class="total-td" title="סה&quot;כ שעות חודשי">${workerTotal > 0 ? workerTotal.toFixed(1) : '—'}</td>
    </tr>`;
  });

  // Build totals row
  let totalCells = '';
  let grandTotal = 0;
  for (let d = 1; d <= daysInMonth; d++) {
    const dayIdx = new Date(gridYear, gridMonth, d).getDay();
    const isWeekend = dayIdx === 5 || dayIdx === 6;
    const isToday = d === todayDay;
    grandTotal += dayTotals[d];
    const cls = isToday ? 'today-col' : (isWeekend ? 'weekend-col' : '');
    totalCells += `<td class="${cls}" style="font-weight:800;color:#4a6080;">${dayTotals[d] > 0 ? dayTotals[d].toFixed(1) : ''}</td>`;
  }

  wrap.innerHTML = `
    <table class="hours-grid-table">
      <thead><tr>${headerCells}</tr></thead>
      <tbody>
        ${workerRows}
        <tr class="total-row">
          <td class="worker-name-td" style="color:var(--text2);font-size:10px;">סה"כ יומי</td>
          ${totalCells}
          <td class="total-td">${grandTotal > 0 ? grandTotal.toFixed(1) : '—'}</td>
        </tr>
      </tbody>
    </table>`;

  // Apply current zoom level after render
  const currentSize = fullscreen ? gridZoomFS : gridZoomNormal;
  const appliedCellW = Math.max(28, Math.round(currentSize * 3.0));
  const appliedNameW = Math.max(80, Math.round(currentSize * 9));
  const renderedTable = wrap.querySelector('.hours-grid-table');
  if (renderedTable) applyZoomToTable(renderedTable, currentSize, appliedCellW, appliedNameW);
}

function copyGridToExcel() { _copyGridToExcelImpl(false); }
function copyGridToExcelFS() { _copyGridToExcelImpl(true); }

function _copyGridToExcelImpl(fullscreen) {
  const monthNames = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const daysInMonth = new Date(gridYear, gridMonth + 1, 0).getDate();
  const m = gridMonth + 1;

  // Apply same search filter as the current view
  const searchTypeId = fullscreen ? 'fs-grid-search-type' : 'grid-search-type';
  const searchInputId = fullscreen ? 'fs-grid-search-input' : 'grid-search-input';
  const searchType = document.getElementById(searchTypeId)?.value || 'name';
  const searchQ = (document.getElementById(searchInputId)?.value || '').trim().toLowerCase();
  let workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  if (searchQ) {
    workers = workers.filter(w => {
      if (searchType === 'name') return w.name.toLowerCase().includes(searchQ);
      if (searchType === 'idpassport') return (w.idNumber || '').toLowerCase().includes(searchQ);
      return true;
    });
  }

  const showId = searchType === 'idpassport';

  const rows = [];
  rows.push([`לוח שעות - ${monthNames[gridMonth]} ${gridYear} - ${company ? company.name : ''}`]);
  rows.push([]);

  const headerRow = [showId ? 'ת"ז / דרכון' : 'שם פועל'];
  for (let d = 1; d <= daysInMonth; d++) headerRow.push(`${d}.${m}`);
  headerRow.push('סה"כ');
  rows.push(headerRow);

  const dayTotals = new Array(daysInMonth + 1).fill(0);
  workers.forEach(w => {
    const key = `${w.id}-${gridYear}-${gridMonth}`;
    const hours = DATA.workerHours[key] || {};
    let workerTotal = 0;
    const workerRow = [showId ? (w.idNumber || '—') : w.name];
    for (let d = 1; d <= daysInMonth; d++) {
      const entry = hours[d];
      const h = entry ? (entry.start && entry.end ? calcHoursFromTime(entry.start, entry.end) : (parseFloat(entry.hours) || 0)) : 0;
      workerTotal += h;
      dayTotals[d] += h;
      workerRow.push(h > 0 ? h : '');
    }
    workerRow.push(workerTotal > 0 ? workerTotal : '');
    rows.push(workerRow);
  });

  const totalsRow = ['סה"כ יומי'];
  let grandTotal = 0;
  for (let d = 1; d <= daysInMonth; d++) {
    grandTotal += dayTotals[d];
    totalsRow.push(dayTotals[d] > 0 ? dayTotals[d] : '');
  }
  totalsRow.push(grandTotal > 0 ? grandTotal : '');
  rows.push([]);
  rows.push(totalsRow);

  rows.push([]);
  rows.push(['סטטוס חתימה:']);
  workers.forEach(w => {
    const key = `${w.id}-${gridYear}-${gridMonth}`;
    const signedInfo = company && company.signed[key];
    let status = 'לא חתום';
    if (signedInfo && signedInfo.type === 'full') status = `חתום - כל החודש (${signedInfo.date})`;
    else if (signedInfo && signedInfo.type === 'partial') status = `חתום חלקית - תאריכים: ${signedInfo.days.join(', ')} (${signedInfo.date})`;
    rows.push([showId ? (w.idNumber || w.name) : w.name, status]);
  });

  const tsv = rows.map(row => row.join('\t')).join('\n');
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(tsv).then(() => showToast('✅ הועתק! פתח אקסל ולחץ Ctrl+V להדבקה', 'success')).catch(() => fallbackCopy(tsv));
  } else {
    fallbackCopy(tsv);
  }
}

function fallbackCopy(text) {
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try {
    document.execCommand('copy');
    showToast('✅ הועתק! פתח אקסל ולחץ Ctrl+V להדבקה', 'success');
  } catch {
    showToast('❌ לא ניתן להעתיק, נסה שנית', 'error');
  }
  document.body.removeChild(ta);
}

function renderCeoTasks() {
  const grid = document.getElementById('ceo-tasks-grid');
  let tasks = DATA.tasks.filter(t => t.company === currentUser.company);

  // Populate employee filter dropdown (employees only, not workers)
  const empFilter = document.getElementById('ceo-task-employee-filter');
  if (empFilter) {
    const currentVal = empFilter.value;
    const companyEmployees = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
    empFilter.innerHTML = '<option value="">💼 כל העובדים</option>' +
      companyEmployees.map(u =>
        `<option value="${u.id}" ${currentVal == u.id ? 'selected' : ''}>💼 ${u.name}</option>`
      ).join('');
    if (currentVal) empFilter.value = currentVal;
  }

  // Apply status/priority filter
  if (taskFilter === 'open') tasks = tasks.filter(t => t.status === 'open');
  else if (taskFilter === 'done') tasks = tasks.filter(t => t.status === 'done');
  else if (taskFilter === 'high') tasks = tasks.filter(t => t.priority === 'high');

  // Apply employee filter
  const selectedEmp = empFilter?.value;
  if (selectedEmp) tasks = tasks.filter(t => String(t.assignedTo) === String(selectedEmp));

  renderTaskCards(grid, tasks, 'ceo');
}

// ── CEO AI ASSISTANT ──
let aiChatHistory = [];

function initAiPage() {
  // Reset scroll on enter
  const msgs = document.getElementById('ai-chat-messages');
  if (msgs) msgs.scrollTop = msgs.scrollHeight;
}

function clearAiChat() {
  aiChatHistory = [];
  const msgs = document.getElementById('ai-chat-messages');
  msgs.innerHTML = `
    <div id="ai-welcome-msg" style="text-align:center;padding:32px 16px;color:var(--text2);">
      <div style="font-size:40px;margin-bottom:12px;">🤖</div>
      <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:6px;">שלום! אני העוזר החכם שלך</div>
      <div style="font-size:13px;">אני יכול לענות על שאלות על הפועלים, העובדים, המשימות, ושעות העבודה בחברה שלך.<br>אני יכול גם לבצע פעולות כמו יצירת משימות ועוד.</div>
    </div>`;
  document.getElementById('ai-suggestions').style.display = 'flex';
}

function sendAiSuggestion(text) {
  document.getElementById('ai-input').value = text;
  sendAiMessage();
}

function buildCompanyContext() {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const employees = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
  const workers = DATA.users.filter(u => u.company === currentUser.company && u.role === 'worker');
  const tasks = DATA.tasks.filter(t => t.company === currentUser.company);
  const now = new Date();
  const monthNames = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];

  // Build worker hours summary for current month
  const workerHoursSummary = workers.map(w => {
    const key = `${w.id}-${now.getFullYear()}-${now.getMonth()}`;
    const hours = DATA.workerHours[key] || {};
    let total = 0;
    Object.values(hours).forEach(e => {
      const h = e.start && e.end ? calcHoursFromTime(e.start, e.end) : (parseFloat(e.hours)||0);
      total += h;
    });
    const signedInfo = company && company.signed[key];
    const signStatus = signedInfo ? (signedInfo.type === 'full' ? 'חתום כל החודש' : `חתום חלקית (${signedInfo.days?.length || 0} ימים)`) : 'לא חתום';
    return `  - ${w.name} (ת"ז/דרכון: ${w.idNumber||'לא הוזן'}, ${w.idType==='passport'?'דרכון':'ת"ז'}): ${total.toFixed(1)} שעות החודש, סטטוס: ${signStatus}`;
  }).join('\n');

  const tasksSummary = tasks.map(t => {
    const assignee = DATA.users.find(u => u.id === t.assignedTo);
    return `  - "${t.title}" | עדיפות: ${t.priority==='high'?'גבוהה':t.priority==='medium'?'בינונית':'נמוכה'} | סטטוס: ${t.status==='open'?'פתוחה':'הושלמה'} | מוקצה ל: ${assignee?.name||'—'} | תאריך יעד: ${t.dueDate}`;
  }).join('\n');

  return `אתה עוזר AI חכם של מנכ"ל חברה. אתה מדבר עברית בלבד. אתה מכיר את כל הנתונים של החברה ויכול לענות על שאלות ולבצע משימות.

== פרטי החברה ==
שם: ${company?.name || '—'}
תחום: ${company?.field || '—'}
מנכ"ל: ${currentUser.name}
תאריך היום: ${now.toLocaleDateString('he-IL')} (${monthNames[now.getMonth()]} ${now.getFullYear()})

== עובדים (${employees.length}) ==
${employees.map(e => `  - ${e.name} (שם משתמש: ${e.username})`).join('\n') || '  אין עובדים'}

== פועלים (${workers.length}) ==
${workers.map(w => `  - ${w.name} (ת"ז/דרכון: ${w.idNumber||'לא הוזן'})`).join('\n') || '  אין פועלים'}

== שעות עבודה חודש נוכחי (${monthNames[now.getMonth()]}) ==
${workerHoursSummary || '  אין נתונים'}

== משימות (${tasks.length}) ==
${tasksSummary || '  אין משימות'}

== הוראות לביצוע פעולות ==
אם המשתמש מבקש לבצע פעולה (כגון יצירת משימה, שינוי סטטוס, וכו'), תאר בדיוק מה אתה מבצע ובסוף ההודעה הוסף JSON בפורמט הבא בתוך תגיות <ACTION>:
<ACTION>{"type":"create_task","title":"כותרת","desc":"תיאור","assignedTo":"שם העובד","priority":"high|medium|low","dueDate":"YYYY-MM-DD"}</ACTION>
או לסגירת משימה:
<ACTION>{"type":"close_task","title":"חלק מהכותרת"}</ACTION>
או לפתיחת משימה:
<ACTION>{"type":"open_task","title":"חלק מהכותרת"}</ACTION>

אם אין פעולה לביצוע, אל תוסיף תגיות ACTION.
ענה בצורה ידידותית, תמציתית ומקצועית בעברית.`;
}

async function sendAiMessage() {
  const input = document.getElementById('ai-input');
  const text = input.value.trim();
  if (!text) return;

  // Hide welcome + suggestions
  const welcome = document.getElementById('ai-welcome-msg');
  if (welcome) welcome.remove();
  document.getElementById('ai-suggestions').style.display = 'none';

  input.value = '';
  input.disabled = true;
  document.getElementById('ai-send-btn').disabled = true;

  const msgs = document.getElementById('ai-chat-messages');

  // Add user message
  msgs.innerHTML += `
    <div style="display:flex;justify-content:flex-start;">
      <div style="max-width:75%;background:#e8e0ff;border-radius:14px 14px 4px 14px;padding:10px 14px;font-size:13px;line-height:1.6;color:var(--text);">${text.replace(/\n/g,'<br>')}</div>
    </div>`;
  msgs.scrollTop = msgs.scrollHeight;

  // Add typing indicator
  const typingId = 'ai-typing-' + Date.now();
  msgs.innerHTML += `
    <div id="${typingId}" style="display:flex;justify-content:flex-end;">
      <div style="background:var(--bg3);border-radius:14px 14px 14px 4px;padding:10px 16px;font-size:13px;color:var(--text2);">
        <span style="display:inline-flex;gap:4px;align-items:center;">
          <span style="width:6px;height:6px;background:#7b63d8;border-radius:50%;animation:aiDot 1.2s infinite 0s;"></span>
          <span style="width:6px;height:6px;background:#7b63d8;border-radius:50%;animation:aiDot 1.2s infinite 0.4s;"></span>
          <span style="width:6px;height:6px;background:#7b63d8;border-radius:50%;animation:aiDot 1.2s infinite 0.8s;"></span>
        </span>
      </div>
    </div>`;
  msgs.scrollTop = msgs.scrollHeight;

  // Add CSS animation if not present
  if (!document.getElementById('ai-dot-style')) {
    const s = document.createElement('style');
    s.id = 'ai-dot-style';
    s.textContent = '@keyframes aiDot{0%,80%,100%{opacity:0.2;transform:scale(0.8)}40%{opacity:1;transform:scale(1.2)}}';
    document.head.appendChild(s);
  }

  // Add to history
  aiChatHistory.push({ role: 'user', content: text });

  try {
    const systemPrompt = buildCompanyContext();
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        system: systemPrompt,
        messages: aiChatHistory
      })
    });

    const data = await response.json();
    const rawReply = data.content?.[0]?.text || '❌ לא התקבלה תגובה';

    // Parse and execute any actions
    let displayReply = rawReply;
    const actionMatch = rawReply.match(/<ACTION>([\s\S]*?)<\/ACTION>/);
    if (actionMatch) {
      displayReply = rawReply.replace(/<ACTION>[\s\S]*?<\/ACTION>/, '').trim();
      try {
        const action = JSON.parse(actionMatch[1]);
        executeAiAction(action);
      } catch(e) { console.error('Action parse error', e); }
    }

    aiChatHistory.push({ role: 'assistant', content: rawReply });

    // Remove typing, add response
    document.getElementById(typingId)?.remove();
    msgs.innerHTML += `
      <div style="display:flex;justify-content:flex-end;">
        <div style="max-width:80%;background:var(--card);border:1px solid var(--border);border-radius:14px 14px 14px 4px;padding:12px 16px;font-size:13px;line-height:1.7;color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.06);">${displayReply.replace(/\n/g,'<br>')}</div>
      </div>`;
  } catch(err) {
    document.getElementById(typingId)?.remove();
    msgs.innerHTML += `
      <div style="display:flex;justify-content:flex-end;">
        <div style="max-width:80%;background:#fff5f5;border:1px solid #f0c0c8;border-radius:14px 14px 14px 4px;padding:12px 16px;font-size:13px;color:#c0506a;">❌ שגיאה בחיבור ל-AI. נסה שוב.</div>
      </div>`;
  }

  msgs.scrollTop = msgs.scrollHeight;
  input.disabled = false;
  document.getElementById('ai-send-btn').disabled = false;
  input.focus();
}

function executeAiAction(action) {
  if (action.type === 'create_task') {
    const assignee = DATA.users.find(u =>
      u.company === currentUser.company &&
      (u.name === action.assignedTo || u.name.includes(action.assignedTo))
    );
    const newTask = {
      id: ++nextTaskId,
      title: action.title,
      desc: action.desc || '',
      assignedTo: assignee?.id || null,
      assignedBy: currentUser.id,
      company: currentUser.company,
      priority: action.priority || 'medium',
      status: 'open',
      dueDate: action.dueDate || new Date().toISOString().split('T')[0],
      createdByEmp: false
    };
    DATA.tasks.push(newTask);
    showToast(`✅ משימה "${action.title}" נוצרה על ידי AI`);
  } else if (action.type === 'close_task') {
    const task = DATA.tasks.find(t => t.company === currentUser.company && t.title.includes(action.title));
    if (task) { task.status = 'done'; showToast(`✅ משימה "${task.title}" נסגרה`); }
  } else if (action.type === 'open_task') {
    const task = DATA.tasks.find(t => t.company === currentUser.company && t.title.includes(action.title));
    if (task) { task.status = 'open'; showToast(`✅ משימה "${task.title}" נפתחה מחדש`); }
  }
}

// ── ADMIN AI ASSISTANT ──
let adminAiHistory = [];

function clearAdminAiChat() {
  adminAiHistory = [];
  const msgs = document.getElementById('admin-ai-messages');
  if (!msgs) return;
  msgs.innerHTML = `
    <div id="admin-ai-welcome" style="text-align:center;padding:32px 16px;color:var(--text2);">
      <div style="font-size:40px;margin-bottom:12px;">🤖</div>
      <div style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px;">שלום מנהל המערכת!</div>
      <div style="font-size:13px;line-height:1.7;">אני מכיר את כל הנתונים במערכת ויכול לעזור לך לנהל אותה.<br>
      אני יכול <strong>לענות שאלות</strong>, לתת <strong>עצות לשיפור</strong>, וגם <strong>לבצע פעולות</strong> כמו הוספת חברה, הוספת משתמש, מחיקה, ועוד.</div>
    </div>`;
  document.getElementById('admin-ai-suggestions').style.display = 'flex';
}

function sendAdminAiSuggestion(text) {
  const input = document.getElementById('admin-ai-input');
  if (input) input.value = text;
  sendAdminAiMessage();
}

function buildAdminContext() {
  const now = new Date();
  const monthNames = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];

  // Companies summary
  const companiesSummary = DATA.companies.map(c => {
    const members = DATA.users.filter(u => u.company === c.id);
    const ceos = members.filter(u => u.role === 'ceo').map(u => u.name);
    const employees = members.filter(u => u.role === 'employee').length;
    const workers = members.filter(u => u.role === 'worker').length;
    const tasks = DATA.tasks.filter(t => t.company === c.id);
    const openTasks = tasks.filter(t => t.status === 'open').length;
    return `  - ${c.emoji} ${c.name} (${c.field}): מנכ"ל: ${ceos.join(', ')||'אין'}, ${employees} עובדים, ${workers} פועלים, ${openTasks} משימות פתוחות`;
  }).join('\n');

  // All users summary
  const usersSummary = DATA.users.filter(u => u.role !== 'admin').map(u => {
    const company = DATA.companies.find(c => c.id === u.company);
    const roleMap = { ceo:'מנכ"ל', employee:'עובד', worker:'פועל' };
    return `  - ${u.name} (@${u.username}) | ${roleMap[u.role]||u.role} | חברה: ${company?.name||'ללא חברה'}`;
  }).join('\n');

  // Tasks overview
  const allTasks = DATA.tasks;
  const openTasks = allTasks.filter(t => t.status === 'open').length;
  const doneTasks = allTasks.filter(t => t.status === 'done').length;
  const highPriority = allTasks.filter(t => t.priority === 'high' && t.status === 'open').length;

  // Anomalies / insights
  const noCompanyUsers = DATA.users.filter(u => !u.company && u.role !== 'admin');
  const companiesNoCeo = DATA.companies.filter(c => !DATA.users.find(u => u.company === c.id && u.role === 'ceo'));

  return `אתה עוזר AI מתקדם של מנהל מערכת. אתה מדבר עברית בלבד. אתה מכיר את כל הנתונים במערכת ויכול לענות על שאלות, לנתח, לתת המלצות, ולבצע פעולות ניהוליות.

== פרטי מנהל המערכת ==
שם: ${currentUser.name}
תאריך: ${now.toLocaleDateString('he-IL')} (${monthNames[now.getMonth()]} ${now.getFullYear()})

== סיכום מערכת ==
סה"כ חברות: ${DATA.companies.length}
סה"כ משתמשים (לא כולל מנהל): ${DATA.users.filter(u=>u.role!=='admin').length}
סה"כ משימות: ${allTasks.length} (פתוחות: ${openTasks}, הושלמו: ${doneTasks}, דחופות: ${highPriority})

== חברות (${DATA.companies.length}) ==
${companiesSummary || '  אין חברות'}

== כל המשתמשים ==
${usersSummary || '  אין משתמשים'}

${noCompanyUsers.length ? `== ⚠️ משתמשים ללא חברה (${noCompanyUsers.length}) ==\n${noCompanyUsers.map(u=>`  - ${u.name} (@${u.username})`).join('\n')}` : ''}
${companiesNoCeo.length ? `== ⚠️ חברות ללא מנכ"ל (${companiesNoCeo.length}) ==\n${companiesNoCeo.map(c=>`  - ${c.emoji} ${c.name}`).join('\n')}` : ''}

== הוראות לביצוע פעולות ==
כשהמשתמש מבקש לבצע פעולה, תאר מה אתה עושה ובסוף הוסף JSON בתגיות <ADMIN_ACTION>:

הוספת חברה:
<ADMIN_ACTION>{"type":"add_company","name":"שם","field":"תחום","emoji":"🏢"}</ADMIN_ACTION>

הוספת משתמש:
<ADMIN_ACTION>{"type":"add_user","name":"שם מלא","username":"username","password":"סיסמה","role":"ceo|employee|worker","company":"שם החברה"}</ADMIN_ACTION>

מחיקת משתמש:
<ADMIN_ACTION>{"type":"delete_user","username":"username"}</ADMIN_ACTION>

מחיקת חברה:
<ADMIN_ACTION>{"type":"delete_company","name":"שם החברה"}</ADMIN_ACTION>

הוספת הערה אישית:
<ADMIN_ACTION>{"type":"add_note","content":"תוכן ההערה"}</ADMIN_ACTION>

שינוי סיסמת משתמש:
<ADMIN_ACTION>{"type":"change_password","username":"username","password":"סיסמה חדשה"}</ADMIN_ACTION>

שינוי חברה של משתמש:
<ADMIN_ACTION>{"type":"move_user","username":"username","company":"שם החברה"}</ADMIN_ACTION>

== עצות לשיפור — הנחיות ==
כשמבקשים המלצות, תנתח את הנתונים לעומק: האם יש חברות עם מעט עובדים? אנומליות? משתמשים לא פעילים? משימות פתוחות ישנות? תן המלצות קונקרטיות ומנומקות.

ענה בצורה מקצועית, ידידותית ותמציתית בעברית.`;
}

async function sendAdminAiMessage() {
  const input = document.getElementById('admin-ai-input');
  const text = (input?.value || '').trim();
  if (!text) return;

  const welcome = document.getElementById('admin-ai-welcome');
  if (welcome) welcome.remove();
  document.getElementById('admin-ai-suggestions').style.display = 'none';

  input.value = '';
  input.disabled = true;
  const sendBtn = document.getElementById('admin-ai-send-btn');
  if (sendBtn) sendBtn.disabled = true;

  const msgs = document.getElementById('admin-ai-messages');

  // User bubble
  msgs.innerHTML += `
    <div style="display:flex;justify-content:flex-start;">
      <div style="max-width:75%;background:#dde8ff;border-radius:14px 14px 4px 14px;padding:10px 14px;font-size:13px;line-height:1.6;color:var(--text);">${text.replace(/\n/g,'<br>')}</div>
    </div>`;
  msgs.scrollTop = msgs.scrollHeight;

  // Typing dots
  if (!document.getElementById('ai-dot-style')) {
    const s = document.createElement('style');
    s.id = 'ai-dot-style';
    s.textContent = '@keyframes aiDot{0%,80%,100%{opacity:0.2;transform:scale(0.8)}40%{opacity:1;transform:scale(1.2)}}';
    document.head.appendChild(s);
  }
  const typingId = 'admin-typing-' + Date.now();
  msgs.innerHTML += `
    <div id="${typingId}" style="display:flex;justify-content:flex-end;">
      <div style="background:var(--bg3);border-radius:14px 14px 14px 4px;padding:10px 16px;">
        <span style="display:inline-flex;gap:4px;align-items:center;">
          <span style="width:6px;height:6px;background:#4a6cc8;border-radius:50%;animation:aiDot 1.2s infinite 0s;"></span>
          <span style="width:6px;height:6px;background:#4a6cc8;border-radius:50%;animation:aiDot 1.2s infinite 0.4s;"></span>
          <span style="width:6px;height:6px;background:#4a6cc8;border-radius:50%;animation:aiDot 1.2s infinite 0.8s;"></span>
        </span>
      </div>
    </div>`;
  msgs.scrollTop = msgs.scrollHeight;

  adminAiHistory.push({ role: 'user', content: text });

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1200,
        system: buildAdminContext(),
        messages: adminAiHistory
      })
    });
    const data = await response.json();
    const rawReply = data.content?.[0]?.text || '❌ לא התקבלה תגובה';

    // Parse and execute actions
    let displayReply = rawReply;
    const actionMatch = rawReply.match(/<ADMIN_ACTION>([\s\S]*?)<\/ADMIN_ACTION>/);
    let actionResult = '';
    if (actionMatch) {
      displayReply = rawReply.replace(/<ADMIN_ACTION>[\s\S]*?<\/ADMIN_ACTION>/, '').trim();
      try {
        const action = JSON.parse(actionMatch[1]);
        actionResult = executeAdminAiAction(action);
      } catch(e) { console.error('Admin action parse error', e); }
    }

    adminAiHistory.push({ role: 'assistant', content: rawReply });

    document.getElementById(typingId)?.remove();

    // Action result badge
    const actionBadge = actionResult
      ? `<div style="margin-top:8px;padding:6px 10px;background:#f0fff4;border:1px solid #a8e0b8;border-radius:8px;font-size:11px;color:#2d8a5a;font-weight:600;">${actionResult}</div>`
      : '';

    msgs.innerHTML += `
      <div style="display:flex;justify-content:flex-end;">
        <div style="max-width:82%;background:var(--card);border:1px solid var(--border);border-radius:14px 14px 14px 4px;padding:12px 16px;font-size:13px;line-height:1.7;color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,0.06);">
          ${displayReply.replace(/\n/g,'<br>')}${actionBadge}
        </div>
      </div>`;

  } catch(err) {
    document.getElementById(typingId)?.remove();
    msgs.innerHTML += `
      <div style="display:flex;justify-content:flex-end;">
        <div style="max-width:80%;background:#fff5f5;border:1px solid #f0c0c8;border-radius:14px 14px 14px 4px;padding:12px 16px;font-size:13px;color:#c0506a;">❌ שגיאה בחיבור ל-AI. נסה שוב.</div>
      </div>`;
  }

  msgs.scrollTop = msgs.scrollHeight;
  input.disabled = false;
  if (sendBtn) sendBtn.disabled = false;
  input.focus();
}

function executeAdminAiAction(action) {
  const roleMap = { ceo:'מנכ"ל', employee:'עובד', worker:'פועל' };
  const avatarColors = { ceo:'#a78bfa', employee:'#4ade80', worker:'#fb923c' };
  const avatarIcons = { ceo:'👔', employee:'💼', worker:'🔧' };

  if (action.type === 'add_company') {
    const id = 'co_' + Date.now();
    DATA.companies.push({ id, name: action.name, field: action.field || 'כללי', emoji: action.emoji || '🏢', signed: {} });
    renderAdminCompanies?.();
    return `✅ חברה "${action.name}" נוספה בהצלחה`;
  }

  if (action.type === 'add_user') {
    if (DATA.users.find(u => u.username === action.username)) return `❌ שם משתמש "${action.username}" כבר קיים`;
    const company = DATA.companies.find(c => c.name === action.company || c.id === action.company);
    const maxId = Math.max(...DATA.users.map(u => u.id));
    const role = action.role || 'employee';
    DATA.users.push({
      id: maxId + 1, username: action.username, password: action.password || '1234',
      name: action.name, role, company: company?.id || null,
      avatar: avatarIcons[role] || '👤', avatarColor: avatarColors[role] || '#888'
    });
    renderAdminUsers?.();
    return `✅ משתמש "${action.name}" (@${action.username}) נוסף כ${roleMap[role]||role}${company ? ' לחברת ' + company.name : ''}`;
  }

  if (action.type === 'delete_user') {
    const idx = DATA.users.findIndex(u => u.username === action.username && u.role !== 'admin');
    if (idx === -1) return `❌ משתמש "${action.username}" לא נמצא`;
    const name = DATA.users[idx].name;
    DATA.users.splice(idx, 1);
    DATA.tasks.forEach(t => { if (t.assignedTo === DATA.users[idx]?.id) t.assignedTo = null; });
    renderAdminUsers?.();
    return `✅ משתמש "${name}" נמחק מהמערכת`;
  }

  if (action.type === 'delete_company') {
    const idx = DATA.companies.findIndex(c => c.name === action.name);
    if (idx === -1) return `❌ חברה "${action.name}" לא נמצאה`;
    const compId = DATA.companies[idx].id;
    DATA.companies.splice(idx, 1);
    DATA.users.forEach(u => { if (u.company === compId) u.company = null; });
    renderAdminCompanies?.();
    return `✅ חברה "${action.name}" נמחקה`;
  }

  if (action.type === 'add_note') {
    const notesEl = document.getElementById('admin-notes');
    if (notesEl) {
      const existing = notesEl.value;
      notesEl.value = existing ? existing + '\n' + action.content : action.content;
    }
    return `✅ הערה נוספה לאזור ההערות האישיות`;
  }

  if (action.type === 'change_password') {
    const user = DATA.users.find(u => u.username === action.username);
    if (!user) return `❌ משתמש "${action.username}" לא נמצא`;
    user.password = action.password;
    renderAdminUsers?.();
    return `✅ סיסמת "${user.name}" שונתה בהצלחה`;
  }

  if (action.type === 'move_user') {
    const user = DATA.users.find(u => u.username === action.username);
    const company = DATA.companies.find(c => c.name === action.company);
    if (!user) return `❌ משתמש "${action.username}" לא נמצא`;
    if (!company) return `❌ חברה "${action.company}" לא נמצאה`;
    user.company = company.id;
    renderAdminUsers?.();
    return `✅ ${user.name} הועבר לחברת "${company.name}"`;
  }

  return '';
}

// ── EMPLOYEE ──
function renderEmpDashboard() {
  document.getElementById('emp-welcome-name').textContent = currentUser.name;
  const company = DATA.companies.find(c => c.id === currentUser.company);
  document.getElementById('emp-company-label').textContent = company ? `${company.emoji} ${company.name}` : '';
  const myTasks = DATA.tasks.filter(t => t.assignedTo === currentUser.id || (t.createdByEmp && t.assignedTo === currentUser.id));
  const open = myTasks.filter(t => t.status === 'open');
  const done = myTasks.filter(t => t.status === 'done');
  const urgent = myTasks.filter(t => t.status === 'open' && t.priority === 'high');
  document.getElementById('emp-stat-open').textContent = open.length;
  document.getElementById('emp-stat-done').textContent = done.length;
  document.getElementById('emp-stat-urgent').textContent = urgent.length;
  document.getElementById('emp-stat-today').textContent = open.filter(t => t.dueDate === new Date().toISOString().split('T')[0]).length;

  const urgentDiv = document.getElementById('emp-urgent-tasks');
  if (!urgent.length) { urgentDiv.innerHTML = '<div class="empty-state"><div class="icon">🎉</div><p>אין משימות דחופות!</p></div>'; return; }
  urgentDiv.innerHTML = `<div class="tasks-grid">${urgent.slice(0,3).map(t => taskCardHTML(t,'emp')).join('')}</div>`;
}

function renderEmpTasks() {
  const grid = document.getElementById('emp-tasks-grid');
  let tasks = DATA.tasks.filter(t => t.assignedTo === currentUser.id);
  if (taskFilter === 'open') tasks = tasks.filter(t => t.status === 'open');
  else if (taskFilter === 'done') tasks = tasks.filter(t => t.status === 'done');
  else if (taskFilter === 'high') tasks = tasks.filter(t => t.priority === 'high');
  else if (taskFilter === 'mine') tasks = tasks.filter(t => t.createdByEmp);
  renderTaskCards(grid, tasks, 'emp');
}

function renderEmpCalendar() {
  const tasks = DATA.tasks.filter(t => t.assignedTo === currentUser.id && t.status === 'open')
    .sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));
  const div = document.getElementById('emp-upcoming-tasks');
  if (!tasks.length) { div.innerHTML = '<div class="empty-state"><div class="icon">📅</div><p>אין משימות ממתינות</p></div>'; return; }
  div.innerHTML = '<div style="text-align:right;">' + tasks.map(t => {
    const due = new Date(t.dueDate);
    const today = new Date();
    const diff = Math.ceil((due - today) / (1000*60*60*24));
    const urgency = diff < 0 ? 'tag-red' : diff <= 2 ? 'tag-yellow' : 'tag-green';
    const urgencyText = diff < 0 ? `איחור ${Math.abs(diff)} ימים` : diff === 0 ? 'היום!' : `עוד ${diff} ימים`;
    return `<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg3);border-radius:10px;margin-bottom:8px;">
      <div class="priority-dot p-${t.priority}"></div>
      <div style="flex:1;"><div style="font-weight:600;font-size:13px;">${t.title}</div>
      <div style="font-size:11px;color:var(--text2);">${t.dueDate}</div></div>
      <span class="tag ${urgency}">${urgencyText}</span>
    </div>`;
  }).join('') + '</div>';
}

// ── WORKER HOURS ──
function calcHoursFromTime(start, end) {
  if (!start || !end) return 0;
  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);
  const startMins = sh * 60 + sm;
  let endMins = eh * 60 + em;
  if (endMins <= startMins) endMins += 24 * 60; // overnight shift
  const diff = (endMins - startMins) / 60;
  return diff > 0 ? Math.round(diff * 10) / 10 : 0;
}

function isWorkerMonthSigned() {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const key = `${currentUser.id}-${workerCurrentYear}-${workerCurrentMonth}`;
  const sig = company && company.signed[key];
  return sig && sig.type === 'full';
}

function isDayLocked(day) {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const key = `${currentUser.id}-${workerCurrentYear}-${workerCurrentMonth}`;
  const sig = company && company.signed[key];
  if (!sig) return false;
  if (sig.type === 'full') return true;
  if (sig.type === 'partial') return sig.days.includes(day);
  return false;
}

function renderWorkerHours(viewWorkerId, viewMonth, viewYear) {
  // If called as viewer by CEO, use different context
  const isViewer = !!viewWorkerId;
  const workerId = viewWorkerId || currentUser.id;
  const month = viewMonth !== undefined ? viewMonth : workerCurrentMonth;
  const year = viewYear !== undefined ? viewYear : workerCurrentYear;
  const worker = DATA.users.find(u => u.id === workerId);

  if (!isViewer) {
    document.getElementById('worker-name-display').textContent = currentUser.name;
    const company = DATA.companies.find(c => c.id === currentUser.company);
    document.getElementById('worker-company-display').textContent = company ? `${company.emoji} ${company.name}` : '';
    const months = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];
    document.getElementById('worker-month-label').textContent = `${months[month]} ${year}`;
  }

  const companyId = worker ? worker.company : currentUser.company;
  const company = DATA.companies.find(c => c.id === companyId);
  const key = `${workerId}-${year}-${month}`;
  const hours = DATA.workerHours[key] || {};
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const dayNames = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];

  const signedInfo = company && company.signed[key];
  const isFullSigned = signedInfo && signedInfo.type === 'full';
  const partialDays = (signedInfo && signedInfo.type === 'partial') ? signedInfo.days : [];

  // For worker: lock signed days
  let totalH = 0, workDays = 0;
  const tbody = document.getElementById('worker-hours-table');
  const todayDate = new Date();
  const todayDay = (todayDate.getFullYear() === year && todayDate.getMonth() === month) ? todayDate.getDate() : -1;
  let rows = '';
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    const dayIdx = date.getDay();
    const isWeekend = dayIdx === 5 || dayIdx === 6;
    const isToday = d === todayDay;
    const entry = hours[d] || { hours:'', start:'', end:'', note:'' };
    const computed = entry.start && entry.end ? calcHoursFromTime(entry.start, entry.end) : (parseFloat(entry.hours)||0);
    if (computed > 0) { totalH += computed; workDays++; }

    const isDaySigned = isFullSigned || partialDays.includes(d);
    // Future days: disable for workers (not for CEO viewer)
    const isFuture = !isViewer && currentUser.role === 'worker' && todayDay > 0 && d > todayDay;
    const locked = (isDaySigned && !isViewer && currentUser.role === 'worker') || isFuture;
    let rowBg = isWeekend ? 'background:#fdf0f0;' : '';
    if (isDaySigned) rowBg = 'background:#f0fff4;';
    if (isToday) rowBg = 'background:linear-gradient(90deg,#e8f4ff,#f0e8ff);';
    if (isFuture) rowBg = 'background:#f8f8f8;';
    const signedBadge = isDaySigned ? `<span style="font-size:10px;color:#3a9a7a;font-weight:700;margin-right:4px;">✓</span>` : '';
    const todayBadge = isToday ? `<span style="font-size:9px;background:#7bb3d8;color:white;padding:1px 5px;border-radius:4px;margin-right:4px;font-weight:700;">היום</span>` : '';
    const futureBadge = isFuture ? `<span style="font-size:9px;color:var(--text3);margin-right:2px;">🔒</span>` : '';
    const leftBorder = isToday ? 'border-right:3px solid #7bb3d8;' : '';

    rows += `
    <tr data-day="${d}" style="${rowBg}${(locked && !isFuture) ? 'opacity:0.75;' : ''}${isFuture ? 'opacity:0.45;' : ''}${leftBorder}${isToday ? 'font-weight:600;' : ''}">
      <td style="font-weight:${isToday?'700':'600'};">${todayBadge}${futureBadge}${d}/${month+1} ${signedBadge}</td>
      <td style="color:${isWeekend ? '#c0506a' : 'var(--text2)'};">${dayNames[dayIdx]}</td>
      <td><input class="hours-input hi-time" type="time" value="${entry.start||''}" onchange="updateHourEntry(${d},'start',this.value,'${workerId}')" ${locked || isViewer ? 'disabled' : ''}></td>
      <td><input class="hours-input hi-time" type="time" value="${entry.end||''}" onchange="updateHourEntry(${d},'end',this.value,'${workerId}')" ${locked || isViewer ? 'disabled' : ''}></td>
      <td style="font-weight:700;color:#4a88b8;text-align:center;" class="computed-hours">${computed > 0 ? computed.toFixed(1) : '—'}</td>
      <td><input class="hours-input" type="text" value="${entry.note||''}" onchange="updateHourEntry(${d},'note',this.value,'${workerId}')" placeholder="הערה..." ${locked || isViewer ? 'disabled' : ''}></td>
    </tr>`;
  }
  tbody.innerHTML = rows;

  // Auto-scroll to today's row
  if (!isViewer && todayDay > 0) {
    setTimeout(() => {
      const allRows = tbody.querySelectorAll('tr');
      if (allRows[todayDay - 1]) {
        allRows[todayDay - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 50);
  }

  if (!isViewer) {
    document.getElementById('worker-total-hours').textContent = totalH.toFixed(1);
    document.getElementById('worker-work-days').textContent = workDays;
    document.getElementById('worker-avg-hours').textContent = workDays ? (totalH/workDays).toFixed(1) : '0';

    // Lock banner
    const fullyLocked = isFullSigned && currentUser.role === 'worker';
    const saveBtn = document.getElementById('worker-save-btn');
    const lockedBanner = document.getElementById('worker-locked-banner');
    if (saveBtn) saveBtn.style.display = fullyLocked ? 'none' : 'inline-flex';
    if (lockedBanner) lockedBanner.style.display = fullyLocked ? 'block' : 'none';

    // Signature status UI
    const hasSig = !!signedInfo;
    // Show unsigned form if: fully unsigned, OR partially signed (can still add more days)
    const showUnsignedForm = !hasSig || (signedInfo && signedInfo.type === 'partial');
    const showSignedBox = hasSig;
    document.getElementById('sig-unsigned').style.display = showUnsignedForm ? 'block' : 'none';
    document.getElementById('sig-signed').style.display = showSignedBox ? 'block' : 'none';

    // When partially signed, hide the "sign full month" block only, keep partial block visible
    const fullMonthBlock = document.getElementById('sig-full-month-block');
    if (fullMonthBlock) {
      fullMonthBlock.style.display = (signedInfo && signedInfo.type === 'partial') ? 'none' : 'block';
    }

    if (hasSig) {
      document.getElementById('sig-info').textContent = isFullSigned
        ? `✅ כל החודש אושר ב-${signedInfo.date}`
        : `📅 חלק מהימים אושרו ב-${signedInfo.date}`;
      const partialEl = document.getElementById('sig-partial-info');
      if (partialEl) {
        if (!isFullSigned && partialDays.length) {
          partialEl.style.display = 'block';
          partialEl.textContent = `תאריכים חתומים: ${partialDays.join(', ')}`;
        } else {
          partialEl.style.display = 'none';
        }
      }
    }

      const partialNote = document.getElementById('sig-partial-note');
      if (partialNote) partialNote.style.display = (!isFullSigned && partialDays.length) ? 'block' : 'none';
    const daysList = document.getElementById('sig-days-list');
    const daysTags = document.getElementById('sig-days-tags');
    if (daysList && daysTags) {
      if (!isFullSigned && partialDays.length > 0) {
        daysList.style.display = 'block';
        daysTags.innerHTML = partialDays.map(d => `<span class="tag tag-green" style="font-size:11px;">${d}/${month+1}</span>`).join('');
      } else {
        daysList.style.display = 'none';
      }
    }
  }
}

function updateHourEntry(day, field, val, wid) {
  const workerId = wid ? parseInt(wid) : currentUser.id;
  if (workerId === currentUser.id && isDayLocked(day)) {
    showToast('❌ יום זה נחתם ולא ניתן לערוך', 'error');
    renderWorkerHours();
    return;
  }
  if (currentUser.role === 'worker' && workerId === currentUser.id) {
    const today = new Date();
    const dayDate = new Date(workerCurrentYear, workerCurrentMonth, day);
    dayDate.setHours(0,0,0,0);
    today.setHours(0,0,0,0);
    if (dayDate > today) {
      showToast('❌ לא ניתן לרשום שעות לימים עתידיים', 'error');
      renderWorkerHours();
      return;
    }
  }
  const key = `${workerId}-${workerCurrentYear}-${workerCurrentMonth}`;
  if (!DATA.workerHours[key]) DATA.workerHours[key] = {};
  if (!DATA.workerHours[key][day]) DATA.workerHours[key][day] = { hours:'', start:'', end:'', note:'' };
  DATA.workerHours[key][day][field] = val;

  const entry = DATA.workerHours[key][day];
  if (field === 'start' || field === 'end') {
    entry.hours = calcHoursFromTime(entry.start, entry.end).toString();
  }

  // Persist to Supabase (debounced)
  sbSaveHour(workerId, workerCurrentYear, workerCurrentMonth, day, entry);

  if (workerId === currentUser.id) {
    let totalH = 0, workDays = 0;
    const daysInMonth = new Date(workerCurrentYear, workerCurrentMonth+1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++) {
      const e = DATA.workerHours[key][d];
      if (e) {
        const h = e.start && e.end ? calcHoursFromTime(e.start, e.end) : (parseFloat(e.hours)||0);
        if (h > 0) { totalH += h; workDays++; }
      }
    }
    document.getElementById('worker-total-hours').textContent = totalH.toFixed(1);
    document.getElementById('worker-work-days').textContent = workDays;
    document.getElementById('worker-avg-hours').textContent = workDays ? (totalH/workDays).toFixed(1) : '0';

    const rows = document.getElementById('worker-hours-table').rows;
    for (let i = 0; i < rows.length; i++) {
      if (parseInt(rows[i].dataset.day) === day) {
        const computed = calcHoursFromTime(entry.start, entry.end);
        const cell = rows[i].querySelector('.computed-hours');
        if (cell) cell.textContent = computed > 0 ? computed.toFixed(1) : '—';
        break;
      }
    }
  }
}

function saveWorkerHours() {
  showToast('✅ שעות נשמרו בהצלחה!');
}

async function changeWorkerMonth(delta) {
  workerCurrentMonth += delta;
  if (workerCurrentMonth > 11) { workerCurrentMonth = 0; workerCurrentYear++; }
  if (workerCurrentMonth < 0)  { workerCurrentMonth = 11; workerCurrentYear--; }
  // Lazy-load hours for this month if not already in memory
  if (HAS_SUPABASE && currentUser) {
    await sbLoadMonthHours(currentUser.id, workerCurrentYear, workerCurrentMonth);
  }
  renderWorkerHours();
}

async function signReport(mode) {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!company) return;
  const key = `${currentUser.id}-${workerCurrentYear}-${workerCurrentMonth}`;

  if (mode === 'full') {
    const pass = document.getElementById('sigPasswordVerify').value;
    if (!pass) { showToast('❌ יש להזין סיסמה', 'error'); return; }
    if (pass !== company.sigPassword) { showToast('❌ סיסמה שגויה!', 'error'); return; }
    const now = new Date().toLocaleDateString('he-IL');
    if (HAS_SUPABASE) await sbSign(currentUser.id, workerCurrentYear, workerCurrentMonth, 'full', null);
    company.signed[key] = { type:'full', date: now, days: null };
    document.getElementById('sigPasswordVerify').value = '';
    showToast('✅ כל הדוח אושר וחתום!');

  } else if (mode === 'partial') {
    const pass = document.getElementById('sigPasswordVerifyPartial').value;
    if (!pass) { showToast('❌ יש להזין סיסמה', 'error'); return; }
    if (pass !== company.sigPassword) { showToast('❌ סיסמה שגויה!', 'error'); return; }
    const from = document.getElementById('sigDayFrom').value;
    const to = document.getElementById('sigDayTo').value;
    if (!from || !to) { showToast('❌ יש לבחור טווח תאריכים', 'error'); return; }
    if (from > to) { showToast('❌ תאריך ההתחלה חייב להיות לפני הסיום', 'error'); return; }
    const days = [];
    const cur = new Date(from);
    const end = new Date(to);
    while (cur <= end) {
      if (cur.getFullYear() === workerCurrentYear && cur.getMonth() === workerCurrentMonth) days.push(cur.getDate());
      cur.setDate(cur.getDate() + 1);
    }
    if (!days.length) { showToast('❌ הטווח לא כולל ימים בחודש הנוכחי', 'error'); return; }
    const now = new Date().toLocaleDateString('he-IL');
    const existing = company.signed[key];
    let existingDays = (existing && existing.type === 'partial') ? existing.days : [];
    const merged = [...new Set([...existingDays, ...days])].sort((a,b)=>a-b);
    if (HAS_SUPABASE) await sbSign(currentUser.id, workerCurrentYear, workerCurrentMonth, 'partial', merged);
    company.signed[key] = { type:'partial', date: now, days: merged };
    document.getElementById('sigPasswordVerifyPartial').value = '';
    showToast(`✅ ימים ${days[0]}-${days[days.length-1]} אושרו וחתומו!`);
  }
  renderWorkerHours();
}

async function unsignReport() {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!company) return;
  const pass = document.getElementById('unsignPassword').value;
  if (!pass) { showToast('❌ יש להזין סיסמה', 'error'); return; }
  if (pass !== company.sigPassword) { showToast('❌ סיסמה שגויה!', 'error'); return; }
  const key = `${currentUser.id}-${workerCurrentYear}-${workerCurrentMonth}`;
  if (HAS_SUPABASE) await sbUnsign(currentUser.id, workerCurrentYear, workerCurrentMonth);
  delete company.signed[key];
  document.getElementById('unsignPassword').value = '';
  renderWorkerHours();
  showToast('✅ האישור בוטל — ניתן לערוך שוב');
}

async function ceoUnsignWorker(workerId) {
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!company) return;
  const now = new Date();
  const key = `${workerId}-${now.getFullYear()}-${now.getMonth()}`;
  if (!company.signed[key]) { showToast('הדוח אינו חתום', 'error'); return; }
  if (!confirm('לבטל את חתימת הפועל הזה לחודש הנוכחי?')) return;
  if (HAS_SUPABASE) await sbUnsign(workerId, now.getFullYear(), now.getMonth());
  delete company.signed[key];
  renderCeoWorkers();
  showToast('✅ חתימה בוטלה — הפועל יכול לערוך שוב');
}

function setSignToday() {
  const today = new Date().toISOString().split('T')[0];
  const fromEl = document.getElementById('sigDayFrom');
  const toEl = document.getElementById('sigDayTo');
  if (fromEl) fromEl.value = today;
  if (toEl) toEl.value = today;
  showToast('📌 תאריך היום סומן אוטומטית');
}

function ceoOpenAddMember(role) {
  const roleLabel = role === 'employee' ? 'עובד' : 'פועל';
  const roleEmoji = role === 'employee' ? '💼' : '🔧';
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">${roleEmoji} הוסף ${roleLabel} חדש לחברה</div>
    <div class="form-group"><label>שם מלא</label><input type="text" id="cm-name" placeholder="שם מלא..."></div>
    <div class="form-group"><label>שם משתמש</label><input type="text" id="cm-username" placeholder="username (אנגלית בלבד)..."></div>
    <div class="form-group"><label>סיסמה</label><input type="password" id="cm-pass" placeholder="סיסמה ראשונית..."></div>
    <div style="display:flex;gap:10px;margin-bottom:14px;">
      <div style="flex:1;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">סוג מסמך</label>
        <select id="cm-idtype" class="form-input" style="padding:8px 12px;">
          <option value="id">🪪 תעודת זהות</option>
          <option value="passport">🛂 דרכון</option>
        </select>
      </div>
      <div style="flex:2;">
        <label style="font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:6px;">מספר מסמך</label>
        <input type="text" id="cm-idnumber" class="form-input" placeholder="מספר ת&quot;ז / דרכון...">
      </div>
    </div>
    <div style="padding:12px;background:var(--bg3);border-radius:8px;font-size:12px;color:var(--text2);margin-bottom:8px;">
      ℹ️ ה${roleLabel} יצורף אוטומטית לחברה שלך: <strong>${DATA.companies.find(c=>c.id===currentUser.company)?.name || ''}</strong>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="ceoAddMember('${role}')">+ הוסף ${roleLabel}</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
}

async function ceoAddMember(role) {
  const name = document.getElementById('cm-name').value.trim();
  const username = document.getElementById('cm-username').value.trim();
  const pass = document.getElementById('cm-pass').value.trim();
  const idType = document.getElementById('cm-idtype').value;
  const idNumber = document.getElementById('cm-idnumber').value.trim();
  if (!name || !username || !pass) { showToast('❌ יש למלא שם, שם משתמש וסיסמה', 'error'); return; }
  if (DATA.users.find(u => u.username === username)) { showToast('❌ שם משתמש כבר קיים במערכת', 'error'); return; }
  const colors = { employee:'#4ade80', worker:'#fb923c' };
  const avatars = { employee:'💼', worker:'🔧' };
  const payload = {
    username, password: pass, name, role,
    company_id: currentUser.company,
    avatar: avatars[role], avatar_color: colors[role],
    id_type: idType, id_number: idNumber,
  };
  if (HAS_SUPABASE) {
    const res = await sbCreateUser(payload);
    if (!res.ok) { showToast(res.data?.error || '❌ שגיאה בהוספה', 'error'); return; }
  } else {
    DATA.users.push({ id: Math.max(...DATA.users.map(u => u.id)) + 1,
      username, password: pass, name, role, company: currentUser.company,
      avatar: avatars[role], avatarColor: colors[role], idType, idNumber });
  }
  closeModal();
  if (role === 'employee') renderCeoEmployees();
  else renderCeoWorkers();
  showToast(`✅ ${name} נוסף${role==='worker'?'':'ה'} בהצלחה!`);
}

// ── BULK IMPORT WORKERS ──
const BULK_ROWS = 10; // initial empty rows

function openBulkImportWorkers() {
  // Use wide modal
  const modal = document.getElementById('modalContent');
  modal.dataset.prevMaxWidth = modal.style.maxWidth || '';
  modal.style.maxWidth = '780px';

  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">📥 ייבוא פועלים מאקסל</div>

    <!-- Instructions -->
    <div style="background:linear-gradient(135deg,#f0f7ff,#e8f5ff);border:1px solid #c0d8f0;border-radius:10px;padding:12px 16px;margin-bottom:14px;font-size:12px;color:var(--text2);">
      ✏️ <strong>מלא את הטבלה</strong> ישירות כאן, או <strong>העתק</strong> אותה לאקסל, מלא שם, ו<strong>הדבק חזרה</strong> (Ctrl+V).
      <br>העמודה האחרונה — אם הכותרת <strong>דרכון</strong> יירשם דרכון, אם <strong>ת"ז</strong> יירשם ת"ז.
    </div>

    <!-- Doc type toggle -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <span style="font-size:12px;font-weight:600;color:var(--text);">סוג מסמך:</span>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:13px;">
        <input type="radio" name="bulk-doctype" value="id" onchange="updateBulkDocHeader(this.value)"> 🪪 ת"ז
      </label>
      <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:13px;">
        <input type="radio" name="bulk-doctype" value="passport" checked onchange="updateBulkDocHeader(this.value)"> 🛂 דרכון
      </label>
      <div style="margin-right:auto;display:flex;gap:6px;">
        <button onclick="copyBulkTable()" class="btn btn-outline btn-sm" style="font-size:11px;">📋 העתק טבלה לאקסל</button>
        <button onclick="addBulkRow()" class="btn btn-outline btn-sm" style="font-size:11px;">+ הוסף שורה</button>
        <button onclick="clearBulkTable()" class="btn btn-outline btn-sm" style="font-size:11px;color:var(--text3);">🗑️ נקה</button>
      </div>
    </div>

    <!-- Editable table -->
    <div style="overflow-x:auto;border:1px solid var(--border);border-radius:10px;background:white;">
      <table id="bulk-table" style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="background:#f0f4f8;">
            <th style="padding:8px 10px;border-bottom:2px solid var(--border);border-left:1px solid var(--border);font-weight:700;text-align:right;color:var(--text);min-width:140px;">שם מלא</th>
            <th style="padding:8px 10px;border-bottom:2px solid var(--border);border-left:1px solid var(--border);font-weight:700;text-align:right;color:var(--text);min-width:130px;">שם משתמש</th>
            <th style="padding:8px 10px;border-bottom:2px solid var(--border);border-left:1px solid var(--border);font-weight:700;text-align:right;color:var(--text);min-width:110px;">סיסמה</th>
            <th id="bulk-doc-header" style="padding:8px 10px;border-bottom:2px solid var(--border);font-weight:700;text-align:right;color:var(--text);min-width:130px;">🛂 דרכון</th>
          </tr>
        </thead>
        <tbody id="bulk-tbody"></tbody>
      </table>
    </div>

    <!-- Validation feedback -->
    <div id="bulk-validation" style="margin-top:10px;font-size:12px;display:none;"></div>

    <div class="modal-actions" style="margin-top:14px;">
      <button class="btn btn-primary" id="bulk-import-btn" onclick="executeBulkImport()">📥 ייבא פועלים</button>
      <button class="btn btn-outline" onclick="closeBulkModal()">ביטול</button>
    </div>`;

  // Build initial empty rows
  buildBulkRows(BULK_ROWS);
  openModal();

  // Handle paste on whole modal
  document.getElementById('bulk-table').addEventListener('paste', handleBulkPaste);
}

function closeBulkModal() {
  const modal = document.getElementById('modalContent');
  modal.style.maxWidth = modal.dataset.prevMaxWidth || '';
  closeModal();
}

function buildBulkRows(count) {
  const tbody = document.getElementById('bulk-tbody');
  tbody.innerHTML = '';
  for (let i = 0; i < count; i++) addBulkRow();
}

function addBulkRow(values = ['','','','']) {
  const tbody = document.getElementById('bulk-tbody');
  const rowIdx = tbody.rows.length;
  const tr = document.createElement('tr');
  tr.style.cssText = 'border-bottom:1px solid var(--border);';
  tr.innerHTML = values.map((v, ci) => `
    <td style="padding:0;border-left:${ci < 3 ? '1px solid var(--border)' : 'none'};">
      <input type="${ci === 2 ? 'text' : 'text'}" value="${v.replace(/"/g,'&quot;')}"
        style="width:100%;border:none;outline:none;padding:7px 10px;font-size:13px;background:transparent;font-family:inherit;box-sizing:border-box;"
        onkeydown="bulkCellKeydown(event,this,${rowIdx},${ci})"
        oninput="validateBulkTable()"
        onfocus="this.style.background='#f0f4ff'" onblur="this.style.background='transparent'">
    </td>`).join('');
  tbody.appendChild(tr);
}

function bulkCellKeydown(e, input, row, col) {
  const tbody = document.getElementById('bulk-tbody');
  const numCols = 4;
  if (e.key === 'Tab') {
    e.preventDefault();
    const next = e.shiftKey ? (col - 1 + numCols * (row + 1)) : (col + 1 + numCols * row);
    const allInputs = tbody.querySelectorAll('input');
    const nextIdx = row * numCols + col + (e.shiftKey ? -1 : 1);
    if (nextIdx >= 0 && nextIdx < allInputs.length) allInputs[nextIdx].focus();
    else if (!e.shiftKey && nextIdx >= allInputs.length) { addBulkRow(); setTimeout(() => tbody.querySelectorAll('input')[nextIdx]?.focus(), 10); }
  } else if (e.key === 'Enter') {
    e.preventDefault();
    const allInputs = tbody.querySelectorAll('input');
    const nextIdx = (row + 1) * numCols + col;
    if (nextIdx < allInputs.length) allInputs[nextIdx].focus();
    else { addBulkRow(); setTimeout(() => tbody.querySelectorAll('input')[nextIdx]?.focus(), 10); }
  }
}

function updateBulkDocHeader(type) {
  const h = document.getElementById('bulk-doc-header');
  if (h) h.textContent = type === 'passport' ? '🛂 דרכון' : '🪪 ת"ז';
  validateBulkTable();
}

function getBulkDocType() {
  return document.querySelector('input[name="bulk-doctype"]:checked')?.value || 'passport';
}

function getBulkTableData() {
  const tbody = document.getElementById('bulk-tbody');
  const rows = [];
  for (const tr of tbody.rows) {
    const inputs = tr.querySelectorAll('input');
    const vals = [...inputs].map(i => i.value.trim());
    if (vals.some(v => v)) rows.push(vals); // skip fully empty rows
  }
  return rows;
}

function validateBulkTable() {
  const rows = getBulkTableData();
  const docType = getBulkDocType();
  const validEl = document.getElementById('bulk-validation');
  const btn = document.getElementById('bulk-import-btn');

  if (!rows.length) { validEl.style.display='none'; btn.disabled=true; btn.style.opacity='0.5'; btn.textContent='📥 ייבא פועלים'; return; }

  const errors = [];
  const validRows = [];

  rows.forEach((cols, idx) => {
    const [name, username, password, idNumber] = cols;
    const rowErrors = [];
    if (!name) rowErrors.push('שם מלא חסר');
    if (!username) rowErrors.push('שם משתמש חסר');
    else if (/\s/.test(username)) rowErrors.push('שם משתמש מכיל רווחים');
    if (!password) rowErrors.push('סיסמה חסרה');
    else if (password.length < 4) rowErrors.push('סיסמה קצרה');
    if (username && DATA.users.find(u => u.username === username)) rowErrors.push('שם משתמש תפוס');

    // Highlight row
    const tbody = document.getElementById('bulk-tbody');
    const allRows = [...tbody.rows].filter(tr => {
      const vals = [...tr.querySelectorAll('input')].map(i => i.value.trim());
      return vals.some(v => v);
    });
    if (allRows[idx]) {
      allRows[idx].style.background = rowErrors.length ? '#fff5f5' : '#f0fff4';
    }

    if (rowErrors.length) errors.push(`שורה ${idx+1} (${name||'?'}): ${rowErrors.join(', ')}`);
    else validRows.push({ name, username, password, idType: docType, idNumber });
  });

  if (errors.length) {
    validEl.style.display = 'block';
    validEl.innerHTML = `<div style="background:#fff5f5;border:1px solid #f0c0c8;border-radius:8px;padding:8px 12px;color:#c0506a;">⚠️ ${errors.join('<br>')}</div>`;
  } else {
    validEl.style.display = 'none';
  }

  if (validRows.length) {
    btn.disabled = false; btn.style.opacity = '1';
    btn.textContent = `📥 ייבא ${validRows.length} פועלים`;
  } else {
    btn.disabled = true; btn.style.opacity = '0.5';
    btn.textContent = '📥 ייבא פועלים';
  }
}

function handleBulkPaste(e) {
  e.preventDefault();
  const text = (e.clipboardData || window.clipboardData).getData('text');
  const lines = text.trim().split(/\r?\n/).filter(l => l.trim());
  if (!lines.length) return;

  // Check if first line is a header (contains Hebrew letters that look like headers)
  let dataLines = lines;
  const firstCols = lines[0].split('\t');
  const looksLikeHeader = firstCols.some(c => /^(שם|דרכון|ת"ז|סיסמה|מסמך|משתמש)/.test(c.trim()));

  // If header includes דרכון → set doctype to passport
  if (looksLikeHeader) {
    const lastHeader = firstCols[firstCols.length - 1].trim();
    if (lastHeader === 'דרכון' || lastHeader === '🛂 דרכון') {
      document.querySelector('input[name="bulk-doctype"][value="passport"]').checked = true;
      updateBulkDocHeader('passport');
    } else {
      document.querySelector('input[name="bulk-doctype"][value="id"]').checked = true;
      updateBulkDocHeader('id');
    }
    dataLines = lines.slice(1);
  }

  // Re-build table with pasted rows + a few empty rows at end
  const tbody = document.getElementById('bulk-tbody');
  tbody.innerHTML = '';
  dataLines.forEach(line => {
    const cols = line.split('\t');
    addBulkRow([cols[0]||'', cols[1]||'', cols[2]||'', cols[3]||'']);
  });
  // Add 3 empty rows at bottom for extra entry
  for (let i = 0; i < 3; i++) addBulkRow();
  validateBulkTable();
}

function copyBulkTable() {
  const docType = getBulkDocType();
  const docLabel = docType === 'passport' ? 'דרכון' : 'ת"ז';
  // Copy header + all current rows (including empty ones) as TSV
  const header = `שם מלא\tשם משתמש\tסיסמה\t${docLabel}`;
  const tbody = document.getElementById('bulk-tbody');
  const allRows = [...tbody.rows].map(tr => {
    const inputs = tr.querySelectorAll('input');
    return [...inputs].map(i => i.value).join('\t');
  });
  const tsv = header + '\n' + allRows.join('\n');

  const fallback = () => {
    const ta = document.createElement('textarea');
    ta.value = tsv; ta.style.position='fixed'; ta.style.opacity='0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    showToast('📋 הטבלה הועתקה! פתח אקסל ולחץ Ctrl+V');
  };

  if (navigator.clipboard?.writeText) {
    navigator.clipboard.writeText(tsv)
      .then(() => showToast('📋 הטבלה הועתקה! פתח אקסל ולחץ Ctrl+V'))
      .catch(fallback);
  } else {
    fallback();
  }
}

function clearBulkTable() {
  buildBulkRows(BULK_ROWS);
  document.getElementById('bulk-validation').style.display = 'none';
  const btn = document.getElementById('bulk-import-btn');
  btn.disabled = true; btn.style.opacity = '0.5'; btn.textContent = '📥 ייבא פועלים';
}

async function executeBulkImport() {
  const rows = getBulkTableData();
  const docType = getBulkDocType();
  const valid = [];

  rows.forEach(cols => {
    const [name, username, password, idNumber] = cols;
    if (!name || !username || !password || password.length < 4 || /\s/.test(username)) return;
    if (DATA.users.find(u => u.username === username)) return;
    valid.push({ name, username, password, idType: docType, idNumber });
  });

  if (!valid.length) { showToast('❌ אין פועלים תקינים לייבוא', 'error'); return; }

  if (HAS_SUPABASE) {
    let success = 0;
    for (const w of valid) {
      const res = await sbCreateUser({
        username: w.username, password: w.password, name: w.name,
        role: 'worker', company_id: currentUser.company,
        avatar: '🔧', avatar_color: '#fb923c',
        id_type: w.idType, id_number: w.idNumber,
      });
      if (res.ok) success++;
    }
    closeBulkModal();
    renderCeoWorkers();
    renderCeoWorkersGrid(false);
    showToast(`✅ ${success} פועלים יובאו בהצלחה!`, 'success');
  } else {
    let maxId = Math.max(...DATA.users.map(u => u.id));
    valid.forEach(w => {
      DATA.users.push({ id: ++maxId, username: w.username, password: w.password, name: w.name,
        role: 'worker', company: currentUser.company, avatar: '🔧', avatarColor: '#fb923c',
        idType: w.idType, idNumber: w.idNumber });
    });
    closeBulkModal();
    renderCeoWorkers();
    renderCeoWorkersGrid(false);
    showToast(`✅ ${valid.length} פועלים יובאו בהצלחה!`, 'success');
  }
}

let sigPassVisible = false;
function toggleCurrentSigPass() {
  sigPassVisible = !sigPassVisible;
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const dispEl = document.getElementById('current-sig-pass-display');
  const eyeEl = document.getElementById('current-sig-pass-eye');
  if (!dispEl || !company) return;
  dispEl.textContent = sigPassVisible ? (company.sigPassword || '(לא הוגדרה)') : '••••••••';
  if (eyeEl) eyeEl.textContent = sigPassVisible ? '🙈' : '👁️';
}

async function setSigPassword() {
  const pass = document.getElementById('sigPasswordInput').value;
  if (!pass) { showToast('❌ יש להזין סיסמה', 'error'); return; }
  const company = DATA.companies.find(c => c.id === currentUser.company);
  if (!company) return;
  if (HAS_SUPABASE) await sbUpdateCompany(company.id, { sig_password: pass });
  company.sigPassword = pass;
  const dispEl = document.getElementById('current-sig-pass-display');
  if (dispEl) { dispEl.textContent = '••••••••'; dispEl.dataset.pass = pass; sigPassVisible = false; }
  showToast('✅ סיסמת החתימה עודכנה!');
  document.getElementById('sigPasswordInput').value = '';
}



function exportHours() {
  showToast('📥 הדוח יוצוא בהצלחה (PDF)');
}

// ── TASKS ──
function taskCardHTML(t, mode) {
  const assignee = DATA.users.find(u => u.id === t.assignedTo);
  const priorLabels = { high:'🔥 דחוף', medium:'⚡ בינוני', low:'🌿 נמוך' };
  const priorTags = { high:'tag-red', medium:'tag-yellow', low:'tag-green' };
  const due = t.dueDate ? new Date(t.dueDate) : null;
  const today = new Date();
  const isOverdue = due && due < today && t.status === 'open';
  const leftBorder = t.priority === 'high' ? '#e04060' : t.priority === 'medium' ? '#e8b840' : '#4aaa7a';
  const subs = t.subtasks || [];
  const subsDone = subs.filter(s => s.done).length;
  const subsPct  = subs.length ? Math.round(subsDone / subs.length * 100) : 0;
  return `
  <div class="task-card ${t.status === 'done' ? 'done' : ''}" onclick="openTaskDetail(${t.id})" style="border-right:4px solid ${leftBorder};">
    <div class="priority-dot p-${t.priority}" title="${priorLabels[t.priority]}" style="flex-shrink:0;"></div>
    <div class="task-card-top">
      <div>
        <div class="task-title">${t.title}</div>
        ${subs.length ? `<div style="display:flex;align-items:center;gap:6px;margin-top:5px;">
          <div style="width:80px;height:4px;border-radius:4px;background:var(--bg3);overflow:hidden;"><div style="height:100%;background:#4aaa7a;width:${subsPct}%;border-radius:4px;"></div></div>
          <span style="font-size:10px;color:var(--text3);">${subsDone}/${subs.length}</span>
        </div>` : ''}
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;flex-wrap:wrap;">
      <span class="tag ${priorTags[t.priority]}">${priorLabels[t.priority]}</span>
      ${t.status === 'done' ? '<span class="tag tag-green">✅ הושלם</span>' : '<span class="tag tag-gray">📋 פתוח</span>'}
      ${isOverdue ? '<span class="tag tag-red">⚠️ באיחור</span>' : ''}
      ${t.dueDate ? `<span style="font-size:11px;color:var(--text3);white-space:nowrap;">📅 ${t.dueDate}</span>` : ''}
      ${assignee ? `<span style="font-size:11px;color:var(--text3);white-space:nowrap;">👤 ${assignee.name}</span>` : ''}
    </div>
  </div>`;
}

function renderTaskCards(grid, tasks, mode) {
  if (!tasks.length) { grid.innerHTML = '<div class="empty-state"><div class="icon">📋</div><p>אין משימות</p></div>'; return; }
  grid.innerHTML = tasks.map(t => taskCardHTML(t, mode)).join('');
}

function filterTasks(f, el) {
  taskFilter = f;
  document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (currentPage === 'ceo-tasks') renderCeoTasks();
  else if (currentPage === 'emp-tasks') renderEmpTasks();
}

function filterEmpTasks(f, el) { filterTasks(f, el); }

function openTaskDetail(taskId) {
  const t = DATA.tasks.find(x => x.id === taskId);
  if (!t) return;
  const assignee = DATA.users.find(u => u.id === t.assignedTo);
  const priorLabels = { high:'🔥 דחוף', medium:'⚡ בינוני', low:'🌿 נמוך' };
  const priorTagCls  = { high:'tag-red', medium:'tag-yellow', low:'tag-green' };
  if (!t.subtasks) t.subtasks = [];
  const isCeo = currentUser.role === 'ceo' || (currentUser.role === 'employee' && currentUser.ceoInterface);
  const canEdit = isCeo || (currentUser.role === 'employee' && t.createdByEmp && t.assignedTo === currentUser.id);

  const subtasksHtml = () => {
    const done = t.subtasks.filter(s => s.done).length;
    const pct  = t.subtasks.length ? Math.round(done / t.subtasks.length * 100) : 0;
    return `
    <div style="margin-bottom:18px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
        <div style="font-size:13px;font-weight:700;">📝 תתי משימות ${t.subtasks.length ? `<span style="font-size:11px;color:var(--text3);font-weight:400;">(${done}/${t.subtasks.length})</span>` : ''}</div>
      </div>
      ${t.subtasks.length ? `
        <div style="background:var(--bg3);border-radius:8px;height:6px;margin-bottom:12px;overflow:hidden;">
          <div style="height:100%;border-radius:8px;background:#4aaa7a;width:${pct}%;transition:width 0.4s;"></div>
        </div>` : ''}
      <div id="subtask-list">
        ${t.subtasks.map(s => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;background:var(--bg3);margin-bottom:6px;">
          <div onclick="toggleSubtask(${taskId},${s.id})" style="width:20px;height:20px;border-radius:50%;border:2px solid ${s.done ? '#4aaa7a' : 'var(--border2)'};background:${s.done ? '#4aaa7a' : 'transparent'};cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;">${s.done ? '<span style="color:white;font-size:11px;">✓</span>' : ''}</div>
          <div style="flex:1;font-size:13px;${s.done ? 'text-decoration:line-through;color:var(--text3);' : ''}">${s.title}</div>
          <button onclick="deleteSubtask(${taskId},${s.id})" style="background:none;border:none;cursor:pointer;color:var(--text3);font-size:14px;padding:2px 4px;border-radius:4px;" title="מחק">✕</button>
        </div>`).join('')}
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <input type="text" id="new-subtask-input" placeholder="הוסף תת משימה..." onkeydown="if(event.key==='Enter')addSubtask(${taskId})"
          style="flex:1;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;background:var(--bg3);font-family:inherit;color:var(--text);outline:none;">
        <button class="btn btn-primary btn-sm" onclick="addSubtask(${taskId})">+ הוסף</button>
      </div>
    </div>`;
  };

  const renderTaskModal = () => {
    document.getElementById('modalBody').innerHTML = `
      <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:12px;">
        <div class="modal-title" style="margin:0;flex:1;">${t.title}</div>
        ${canEdit ? `<button class="btn btn-outline btn-sm" onclick="editTask(${taskId})" style="flex-shrink:0;">✏️ ערוך</button>` : ''}
      </div>
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        <span class="tag tag-${t.status==='done'?'green':'yellow'}">${t.status==='done'?'✅ הושלם':'📋 פתוח'}</span>
        <span class="tag ${priorTagCls[t.priority]}">${priorLabels[t.priority]}</span>
      </div>
      ${t.desc ? `<p style="color:var(--text2);font-size:14px;line-height:1.6;margin-bottom:16px;background:var(--bg3);border-radius:10px;padding:12px 14px;">${t.desc}</p>` : ''}
      ${assignee ? `<div style="margin-bottom:10px;font-size:13px;color:var(--text2);">👤 מוקצה ל: <strong>${assignee.name}</strong></div>` : ''}
      ${t.dueDate ? `<div style="margin-bottom:16px;font-size:13px;color:var(--text2);">📅 תאריך יעד: <strong>${t.dueDate}</strong></div>` : ''}
      <div style="border-top:1px solid var(--border);margin:16px 0;"></div>
      ${subtasksHtml()}
      <div class="modal-actions" style="border-top:1px solid var(--border);padding-top:14px;margin-top:4px;">
        ${t.status === 'open'
          ? `<button class="btn btn-success btn-sm" onclick="toggleTaskStatus(${t.id});openTaskDetail(${t.id});">✅ סמן כהושלם</button>`
          : `<button class="btn btn-outline btn-sm" onclick="toggleTaskStatus(${t.id});openTaskDetail(${t.id});">↩️ פתח מחדש</button>`}
        ${canEdit ? `<button class="btn btn-danger btn-sm" onclick="deleteTask(${t.id})">🗑️ מחק</button>` : ''}
        <button class="btn btn-outline btn-sm" onclick="closeModal()">סגור</button>
      </div>`;
  };

  renderTaskModal();
  openModal();
}

async function addSubtask(taskId) {
  const t = DATA.tasks.find(x => x.id === taskId);
  const input = document.getElementById('new-subtask-input');
  const title = input?.value.trim();
  if (!t || !title) return;
  if (HAS_SUPABASE) {
    const res = await sbCreateSubtask(taskId, title);
    if (!res.ok) { showToast('❌ שגיאה בהוספת תת-משימה', 'error'); return; }
  } else {
    if (!t.subtasks) t.subtasks = [];
    t.subtasks.push({ id: nextSubtaskId++, title, done: false });
  }
  openTaskDetail(taskId);
}

async function toggleSubtask(taskId, subtaskId) {
  const t = DATA.tasks.find(x => x.id === taskId);
  const s = t?.subtasks?.find(x => x.id === subtaskId);
  if (!s) return;
  if (HAS_SUPABASE) {
    await sbToggleSubtask(taskId, subtaskId, !s.done);
  } else {
    s.done = !s.done;
  }
  openTaskDetail(taskId);
}

async function deleteSubtask(taskId, subtaskId) {
  const t = DATA.tasks.find(x => x.id === taskId);
  if (HAS_SUPABASE) {
    await sbDeleteSubtask(taskId, subtaskId);
  } else {
    if (t?.subtasks) t.subtasks = t.subtasks.filter(s => s.id !== subtaskId);
  }
  openTaskDetail(taskId);
}

function editTask(taskId) {
  const t = DATA.tasks.find(x => x.id === taskId);
  if (!t) return;
  const isCeo = currentUser.role === 'ceo' || (currentUser.role === 'employee' && currentUser.ceoInterface);
  const assignees = DATA.users.filter(u => u.company === currentUser.company && u.role === 'employee');
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">✏️ עריכת משימה</div>
    <div class="form-group"><label>כותרת</label><input type="text" id="et-title" class="form-input" value="${t.title.replace(/"/g,'&quot;')}" placeholder="כותרת המשימה..."></div>
    <div class="form-group"><label>תיאור</label><textarea id="et-desc" class="form-input" placeholder="פרטי המשימה..." rows="3">${t.desc || ''}</textarea></div>
    ${isCeo ? `<div class="form-group"><label>הוקצה ל</label><select id="et-assign" class="form-input"><option value="">בחר עובד</option>${assignees.map(e=>`<option value="${e.id}" ${t.assignedTo===e.id?'selected':''}>${e.name}</option>`).join('')}</select></div>` : ''}
    <div class="form-group"><label>עדיפות</label><select id="et-priority" class="form-input">
      <option value="high" ${t.priority==='high'?'selected':''}>🔥 דחוף</option>
      <option value="medium" ${t.priority==='medium'?'selected':''}>⚡ בינוני</option>
      <option value="low" ${t.priority==='low'?'selected':''}>🌿 נמוך</option>
    </select></div>
    <div class="form-group"><label>תאריך יעד</label><input type="date" id="et-date" class="form-input" value="${t.dueDate || ''}"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveEditTask(${taskId})">💾 שמור שינויים</button>
      <button class="btn btn-outline" onclick="openTaskDetail(${taskId})">← חזור</button>
    </div>`;
}

async function saveEditTask(taskId) {
  const t = DATA.tasks.find(x => x.id === taskId);
  if (!t) return;
  const title = document.getElementById('et-title').value.trim();
  if (!title) { showToast('❌ יש להזין כותרת', 'error'); return; }
  const updates = {
    title,
    description: document.getElementById('et-desc').value,
    priority: document.getElementById('et-priority').value,
    due_date: document.getElementById('et-date').value || null,
  };
  const assignEl = document.getElementById('et-assign');
  if (assignEl) updates.assigned_to = parseInt(assignEl.value) || t.assignedTo;
  if (HAS_SUPABASE) {
    const res = await sbUpdateTask(taskId, updates);
    if (!res.ok) { showToast('❌ שגיאה בשמירה', 'error'); return; }
  } else {
    t.title = updates.title; t.desc = updates.description;
    t.priority = updates.priority; t.dueDate = updates.due_date || t.dueDate;
    if (assignEl) t.assignedTo = updates.assigned_to;
  }
  renderPage(currentPage);
  openTaskDetail(taskId);
  showToast('✅ משימה עודכנה!');
}

async function toggleTaskStatus(taskId) {
  const t = DATA.tasks.find(x => x.id === taskId);
  if (!t) return;
  const newStatus = t.status === 'open' ? 'done' : 'open';
  if (HAS_SUPABASE) {
    await sbUpdateTask(taskId, { status: newStatus });
  } else {
    t.status = newStatus;
  }
  renderPage(currentPage);
}

async function deleteTask(taskId) {
  if (HAS_SUPABASE) {
    const res = await sbDeleteTask(taskId);
    if (!res.ok) { showToast('❌ שגיאה במחיקה', 'error'); return; }
  } else {
    DATA.tasks.splice(DATA.tasks.findIndex(t => t.id === taskId), 1);
  }
  closeModal();
  renderPage(currentPage);
}

// ── ADD TASK MODAL ──
function openAddTask(mode) {
  const companyId = currentUser.company;
  const assignees = DATA.users.filter(u => u.company === companyId && u.role === 'employee');
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">➕ הוספת משימה חדשה</div>
    <div class="form-group"><label>כותרת</label><input type="text" id="nt-title" placeholder="כותרת המשימה..."></div>
    <div class="form-group"><label>תיאור</label><textarea id="nt-desc" placeholder="פרטי המשימה..." rows="3"></textarea></div>
    ${mode === 'ceo' ? `<div class="form-group"><label>הוקצה ל</label><select id="nt-assign"><option value="">בחר עובד</option>${assignees.map(e=>`<option value="${e.id}">${e.name}</option>`).join('')}</select></div>` : ''}
    <div class="form-group"><label>עדיפות</label><select id="nt-priority"><option value="high">🔥 דחוף</option><option value="medium" selected>⚡ בינוני</option><option value="low">🌿 נמוך</option></select></div>
    <div class="form-group"><label>תאריך יעד</label><input type="date" id="nt-date"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="addTask('${mode}')">➕ הוסף</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
}

function openAssignTask(empId) {
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">📋 הוסף משימה לעובד</div>
    <div class="form-group"><label>כותרת</label><input type="text" id="at-title" placeholder="כותרת המשימה..."></div>
    <div class="form-group"><label>תיאור</label><textarea id="at-desc" placeholder="פרטים..." rows="3"></textarea></div>
    <div class="form-group"><label>עדיפות</label><select id="at-priority"><option value="high">🔥 דחוף</option><option value="medium" selected>⚡ בינוני</option><option value="low">🌿 נמוך</option></select></div>
    <div class="form-group"><label>תאריך יעד</label><input type="date" id="at-date"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="addTaskToEmp(${empId})">הוסף</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
}

async function addTask(mode) {
  const title = document.getElementById('nt-title').value.trim();
  if (!title) { showToast('❌ יש להזין כותרת', 'error'); return; }
  const assignTo = mode === 'ceo' ? parseInt(document.getElementById('nt-assign').value) || currentUser.id : currentUser.id;
  const payload = {
    title, description: document.getElementById('nt-desc').value,
    assigned_to: assignTo, company_id: currentUser.company,
    priority: document.getElementById('nt-priority').value,
    due_date: document.getElementById('nt-date').value || null,
    created_by_emp: mode === 'emp',
  };
  if (HAS_SUPABASE) {
    const res = await sbCreateTask(payload);
    if (!res.ok) { showToast('❌ שגיאה בהוספת משימה', 'error'); return; }
  } else {
    DATA.tasks.push({ id: nextTaskId++, title, desc: payload.description,
      assignedTo: assignTo, assignedBy: currentUser.id, company: currentUser.company,
      priority: payload.priority, status: 'open', dueDate: payload.due_date || '', createdByEmp: mode === 'emp' });
  }
  closeModal(); renderPage(currentPage); showToast('✅ משימה נוספה!');
}

async function addTaskToEmp(empId) {
  const title = document.getElementById('at-title').value.trim();
  if (!title) { showToast('❌ יש להזין כותרת', 'error'); return; }
  const payload = {
    title, description: document.getElementById('at-desc').value,
    assigned_to: empId, company_id: currentUser.company,
    priority: document.getElementById('at-priority').value,
    due_date: document.getElementById('at-date').value || null,
    created_by_emp: false,
  };
  if (HAS_SUPABASE) {
    const res = await sbCreateTask(payload);
    if (!res.ok) { showToast('❌ שגיאה בהוספת משימה', 'error'); return; }
  } else {
    DATA.tasks.push({ id: nextTaskId++, title, desc: payload.description,
      assignedTo: empId, assignedBy: currentUser.id, company: currentUser.company,
      priority: payload.priority, status: 'open', dueDate: payload.due_date || '', createdByEmp: false });
  }
  closeModal(); renderPage(currentPage); showToast('✅ משימה הוקצתה!');
}

// ── COMPANY MANAGEMENT ──
function openAddCompany() {
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">🏢 הוסף חברה חדשה</div>
    <div class="form-group"><label>שם החברה</label><input type="text" id="nc-name" placeholder="שם החברה..."></div>
    <div class="form-group"><label>תחום פעילות</label><input type="text" id="nc-field" placeholder="תחום פעילות..."></div>
    <div class="form-group"><label>אמוג׳י</label><input type="text" id="nc-emoji" placeholder="🏢" maxlength="2" style="font-size:24px;width:80px;text-align:center;"></div>
    <div class="form-group"><label>צבע</label><input type="color" id="nc-color" value="#6c63ff" style="width:60px;height:40px;border-radius:8px;border:none;cursor:pointer;"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="addCompany()">הוסף</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
}

function editCompany(compId) {
  const c = DATA.companies.find(x => x.id === compId);
  if (!c) return;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">✏️ עריכת ${c.name}</div>
    <div class="form-group"><label>שם החברה</label><input type="text" id="ec-name" value="${c.name}"></div>
    <div class="form-group"><label>תחום פעילות</label><input type="text" id="ec-field" value="${c.field}"></div>
    <div class="form-group"><label>אמוג׳י</label><input type="text" id="ec-emoji" value="${c.emoji}" maxlength="2" style="font-size:24px;width:80px;text-align:center;"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveCompany('${compId}')">💾 שמור</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
}

function deleteCompany(compId) {
  const comp = DATA.companies.find(c => c.id === compId);
  if (!comp) return;
  const memberCount = DATA.users.filter(u => u.company === compId).length;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">🗑️ מחיקת חברה</div>
    <div style="background:#fff5f5;border:1px solid #f0c0c8;border-radius:12px;padding:18px;margin-bottom:18px;text-align:center;">
      <div style="font-size:36px;margin-bottom:8px;">${comp.emoji}</div>
      <div style="font-size:18px;font-weight:800;">${comp.name}</div>
      <div style="font-size:13px;color:var(--text2);margin-top:4px;">${comp.field}</div>
    </div>
    <div style="background:#fff8f0;border:1px solid #f0d0a8;border-radius:10px;padding:14px;margin-bottom:18px;font-size:13px;color:#a05010;">
      ⚠️ <strong>שים לב:</strong> מחיקת החברה תנתק את <strong>${memberCount} המשתמשים</strong> הקשורים אליה. הם לא יימחקו אך לא יהיו משויכים לשום חברה.
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="confirmDeleteCompany('${compId}')">🗑️ כן, מחק חברה</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
}

async function addCompany() {
  const name = document.getElementById('nc-name').value.trim();
  if (!name) { showToast('❌ יש להזין שם', 'error'); return; }
  const payload = {
    name, emoji: document.getElementById('nc-emoji').value || '🏢',
    field: document.getElementById('nc-field').value || 'כללי',
    color: document.getElementById('nc-color').value,
  };
  if (HAS_SUPABASE) {
    const res = await sbCreateCompany(payload);
    if (!res.ok) { showToast('❌ שגיאה בהוספת חברה', 'error'); return; }
  } else {
    const id = name.toLowerCase().replace(/\s+/g, '');
    DATA.companies.push({ id, ...payload, employees: 0, sigPassword: 'sign123', signed: {} });
  }
  closeModal(); renderAdminCompanies(); showToast('✅ חברה נוספה!');
}

async function saveCompany(compId) {
  const updates = {
    name:  document.getElementById('ec-name').value,
    field: document.getElementById('ec-field').value,
    emoji: document.getElementById('ec-emoji').value || DATA.companies.find(c=>c.id===compId)?.emoji,
  };
  if (HAS_SUPABASE) {
    await sbUpdateCompany(compId, updates);
  } else {
    const c = DATA.companies.find(x => x.id === compId);
    if (c) Object.assign(c, updates);
  }
  closeModal(); renderAdminCompanies(); showToast('✅ חברה עודכנה!');
}

async function confirmDeleteCompany(compId) {
  const idx = DATA.companies.findIndex(c => c.id === compId);
  if (idx === -1) return;
  const name = DATA.companies[idx].name;
  if (HAS_SUPABASE) {
    const res = await sbDeleteCompany(compId);
    if (!res.ok) { showToast('❌ שגיאה במחיקה', 'error'); return; }
  } else {
    DATA.companies.splice(idx, 1);
    DATA.users.filter(u => u.company === compId).forEach(u => u.company = null);
  }
  closeModal(); renderAdminCompanies();
  showToast(`🗑️ החברה "${name}" נמחקה`);
}

// ── USER MANAGEMENT ──
function openAddUser() {
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">👤 הוסף משתמש חדש</div>
    <div class="form-group"><label>שם מלא</label><input type="text" id="nu-name" placeholder="שם המשתמש..."></div>
    <div class="form-group"><label>שם משתמש</label><input type="text" id="nu-username" placeholder="username..."></div>
    <div class="form-group"><label>סיסמה</label><input type="password" id="nu-pass" placeholder="סיסמה..."></div>
    <div class="form-group"><label>תפקיד</label>
      <select id="nu-role"><option value="ceo">מנכ"ל</option><option value="employee" selected>עובד</option><option value="worker">פועל</option></select>
    </div>
    <div class="form-group"><label>חברה</label>
      <select id="nu-company"><option value="">בחר חברה</option>${DATA.companies.map(c=>`<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('')}</select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="addUser()">הוסף</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
}

async function addUser() {
  const name = document.getElementById('nu-name').value.trim();
  const username = document.getElementById('nu-username').value.trim();
  const pass = document.getElementById('nu-pass').value;
  if (!name || !username || !pass) { showToast('❌ יש למלא את כל השדות', 'error'); return; }
  if (DATA.users.find(u => u.username === username)) { showToast('❌ שם משתמש תפוס', 'error'); return; }
  const role = document.getElementById('nu-role').value;
  const colors = { ceo:'#60a5fa', employee:'#4ade80', worker:'#fb923c' };
  const payload = {
    username, password: pass, name, role,
    company_id: document.getElementById('nu-company').value || null,
    avatar: role === 'ceo' ? '🏢' : role === 'worker' ? '🔧' : '💼',
    avatar_color: colors[role],
  };
  if (HAS_SUPABASE) {
    const res = await sbCreateUser(payload);
    if (!res.ok) { showToast(res.data?.error || '❌ שגיאה בהוספת משתמש', 'error'); return; }
  } else {
    DATA.users.push({ id: Math.max(...DATA.users.map(u=>u.id))+1, username, password: pass, name,
      role, company: payload.company_id, avatar: payload.avatar, avatarColor: payload.avatar_color });
  }
  closeModal(); renderAdminUsers(); showToast('✅ משתמש נוסף!');
}

async function saveUser(userId) {
  const updates = {
    name: document.getElementById('eu-name').value,
    company_id: document.getElementById('eu-company').value || null,
  };
  if (HAS_SUPABASE) {
    await sbUpdateUser(userId, updates);
  } else {
    const u = DATA.users.find(x => x.id === userId);
    if (u) { u.name = updates.name; u.company = updates.company_id; }
  }
  closeModal(); renderAdminUsers(); showToast('✅ משתמש עודכן!');
}

async function doChangePass(userId) {
  const np = document.getElementById('new-pass').value;
  const cp = document.getElementById('conf-pass').value;
  if (!np) { showToast('❌ יש להזין סיסמה', 'error'); return; }
  if (np !== cp) { showToast('❌ הסיסמאות לא תואמות', 'error'); return; }
  if (HAS_SUPABASE) {
    await sbUpdateUser(userId, { password: np });
  } else {
    const u = DATA.users.find(x => x.id === userId);
    if (u) u.password = np;
  }
  closeModal(); showToast('✅ סיסמה עודכנה!');
}

async function confirmDeleteUser(userId) {
  const idx = DATA.users.findIndex(x => x.id === userId);
  if (idx === -1) return;
  const name = DATA.users[idx].name;
  if (HAS_SUPABASE) {
    const res = await sbDeleteUser(userId);
    if (!res.ok) { showToast('❌ שגיאה במחיקה', 'error'); return; }
  } else {
    DATA.users.splice(idx, 1);
    DATA.tasks.forEach(t => { if (t.assignedTo === userId) t.assignedTo = null; });
  }
  closeModal();
  renderAdminUsers();
  showToast(`🗑️ ${name} נמחק מהמערכת`);
}

function editUser(userId) {
  const u = DATA.users.find(x => x.id === userId);
  if (!u) return;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">✏️ עריכת ${u.name}</div>
    <div class="form-group"><label>שם מלא</label><input type="text" id="eu-name" value="${u.name}"></div>
    <div class="form-group"><label>חברה</label>
      <select id="eu-company"><option value="">ללא חברה</option>${DATA.companies.map(c=>`<option value="${c.id}" ${u.company===c.id?'selected':''}>${c.emoji} ${c.name}</option>`).join('')}</select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveUser(${userId})">💾 שמור</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
}

function viewWorkerReport(workerId) {
  const worker = DATA.users.find(u => u.id === workerId);
  if (!worker) return;
  const company = DATA.companies.find(c => c.id === currentUser.company);
  const now = new Date();
  const months = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];

  // Build month selector
  const monthOptions = [];
  for (let i = 0; i < 6; i++) {
    let m = now.getMonth() - i;
    let y = now.getFullYear();
    if (m < 0) { m += 12; y--; }
    monthOptions.push({ m, y, label: `${months[m]} ${y}` });
  }

  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">📊 דוח שעות — ${worker.name}</div>
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">
      <select id="report-month-select" onchange="loadWorkerReportMonth(${workerId})" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'Heebo',sans-serif;font-size:13px;outline:none;">
        ${monthOptions.map((o,i) => `<option value="${o.m}|${o.y}" ${i===0?'selected':''}>${o.label}</option>`).join('')}
      </select>
      <span id="report-sig-badge" style="font-size:12px;"></span>
    </div>
    <div id="report-stats" style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:14px;padding:14px;background:var(--bg3);border-radius:10px;"></div>
    <div class="table-wrap" style="max-height:400px;overflow-y:auto;">
      <table class="hours-table">
        <thead><tr><th>תאריך</th><th>יום</th><th>שעות</th><th>הגעה</th><th>יציאה</th><th>הערות</th></tr></thead>
        <tbody id="report-table-body"></tbody>
      </table>
    </div>
    <div class="modal-actions" style="margin-top:16px;">
      <button class="btn btn-outline btn-sm" onclick="closeModal()">סגור</button>
    </div>`;

  openModal();
  loadWorkerReportMonth(workerId);
}

function loadWorkerReportMonth(workerId) {
  const sel = document.getElementById('report-month-select');
  if (!sel) return;
  const [m, y] = sel.value.split('|').map(Number);
  const worker = DATA.users.find(u => u.id === workerId);
  const company = DATA.companies.find(c => c.id === worker?.company);
  const key = `${workerId}-${y}-${m}`;
  const hours = DATA.workerHours[key] || {};
  const daysInMonth = new Date(y, m+1, 0).getDate();
  const dayNames = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];
  const months = ['ינואר','פברואר','מרץ','אפריל','מאי','יוני','יולי','אוגוסט','ספטמבר','אוקטובר','נובמבר','דצמבר'];

  const signedInfo = company && company.signed[key];
  const isFullSigned = signedInfo && signedInfo.type === 'full';
  const partialDays = (signedInfo && signedInfo.type === 'partial') ? signedInfo.days : [];

  // Signature badge
  const badge = document.getElementById('report-sig-badge');
  if (badge) {
    if (isFullSigned) badge.innerHTML = '<span class="tag tag-green">✅ כל החודש חתום</span>';
    else if (partialDays.length) badge.innerHTML = `<span class="tag tag-purple">📅 ${partialDays.length} תאריכים חתומים</span>`;
    else badge.innerHTML = '<span class="tag tag-red">❌ לא חתום</span>';
  }

  // Build rows & stats
  let totalH = 0, workDays = 0;
  let rows = '';
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(y, m, d);
    const dayIdx = date.getDay();
    const isWeekend = dayIdx === 5 || dayIdx === 6;
    const entry = hours[d] || {};
    const computed = entry.start && entry.end ? calcHoursFromTime(entry.start, entry.end) : (parseFloat(entry.hours)||0);
    if (computed > 0) { totalH += computed; workDays++; }
    const isDaySigned = isFullSigned || partialDays.includes(d);
    const rowBg = isDaySigned ? 'background:#f0fff4;' : (isWeekend ? 'background:#fdf0f0;' : '');
    const sigMark = isDaySigned ? ' ✓' : '';

    rows += `<tr style="${rowBg}">
      <td style="font-weight:600;font-size:12px;">${d}/${m+1}${sigMark}</td>
      <td style="color:${isWeekend ? '#c0506a' : 'var(--text2)'};font-size:12px;">${dayNames[dayIdx]}</td>
      <td style="font-weight:700;color:#4a88b8;font-size:13px;">${computed > 0 ? computed.toFixed(1) : '—'}</td>
      <td style="font-size:12px;color:var(--text2);">${entry.start || '—'}</td>
      <td style="font-size:12px;color:var(--text2);">${entry.end || '—'}</td>
      <td style="font-size:12px;color:var(--text2);">${entry.note || ''}</td>
    </tr>`;
  }

  const tbody = document.getElementById('report-table-body');
  if (tbody) tbody.innerHTML = rows;

  const stats = document.getElementById('report-stats');
  if (stats) stats.innerHTML = `
    <div><div style="font-size:22px;font-weight:800;color:#b06830;">${totalH.toFixed(1)}</div><div style="font-size:11px;color:var(--text2);">סה"כ שעות</div></div>
    <div><div style="font-size:22px;font-weight:800;color:#a07820;">${workDays}</div><div style="font-size:11px;color:var(--text2);">ימי עבודה</div></div>
    <div><div style="font-size:22px;font-weight:800;color:#3a9a7a;">${workDays ? (totalH/workDays).toFixed(1) : '0'}</div><div style="font-size:11px;color:var(--text2);">ממוצע יומי</div></div>
    <div><div style="font-size:22px;font-weight:800;color:#7b63d8;">${months[m]} ${y}</div><div style="font-size:11px;color:var(--text2);">חודש</div></div>`;
}

function removeWorker(workerId) {
  const w = DATA.users.find(u => u.id === workerId);
  if (!confirm(`להסיר את ${w.name}?`)) return;
  w.company = null;
  renderCeoWorkers(); showToast('✅ פועל הוסר מהחברה');
}

// ── NOTES ──

// ═══════════════════════════════════════════
// WORKER REQUESTS
// ═══════════════════════════════════════════
const requestTypeLabels = {
  equipment: '🔧 ציוד חסר',
  safety:    '⛑️ בטיחות',
  schedule:  '📅 לוח זמנים',
  payment:   '💰 תשלום / שכר',
  other:     '💬 כללי / אחר'
};
const requestStatusLabels = {
  pending:  { text: '⏳ ממתין לטיפול', cls: 'tag-yellow' },
  inprogress:{ text: '🔄 בטיפול',       cls: 'tag-purple' },
  done:     { text: '✅ טופל',           cls: 'tag-green' },
};

async function submitWorkerRequest() {
  const type = document.getElementById('request-type').value;
  const text = document.getElementById('request-text').value.trim();
  if (!text) { showToast('❌ יש לכתוב תוכן לפנייה', 'error'); return; }
  if (HAS_SUPABASE) {
    const res = await sbCreateRequest({ type, text });
    if (!res.ok) { showToast('❌ שגיאה בשליחת פנייה', 'error'); return; }
  } else {
    DATA.requests.unshift({
      id: Date.now(), workerId: currentUser.id, workerName: currentUser.name,
      company: currentUser.company, type, text,
      date: new Date().toLocaleDateString('he-IL'), status: 'pending'
    });
  }
  document.getElementById('request-text').value = '';
  renderWorkerRequests();
  buildNav();
  showToast('📤 הפנייה נשלחה למנכ"ל!');
}

async function updateRequestStatus(reqId, status) {
  if (HAS_SUPABASE) await sbUpdateRequest(reqId, { status });
  else { const r = DATA.requests.find(x => x.id === reqId); if (r) r.status = status; }
  renderCeoRequests();
  showToast('✅ סטטוס עודכן');
}

async function saveRequestReply(reqId) {
  const text = document.getElementById('reply-text').value.trim();
  const r = DATA.requests.find(x => x.id === reqId);
  const newStatus = r?.status === 'pending' ? 'inprogress' : r?.status;
  if (HAS_SUPABASE) {
    await sbUpdateRequest(reqId, { reply: text, status: newStatus });
  } else {
    if (r) { r.reply = text; if (r.status === 'pending') r.status = 'inprogress'; }
  }
  closeModal();
  renderCeoRequests();
  showToast('✅ תשובה נשמרה ונשלחה לפועל');
}

async function confirmDeleteRequest(reqId) {
  if (HAS_SUPABASE) {
    const res = await sbDeleteRequest(reqId);
    if (!res.ok) { showToast('❌ שגיאה במחיקה', 'error'); return; }
  } else {
    const idx = DATA.requests.findIndex(x => x.id === reqId);
    if (idx !== -1) DATA.requests.splice(idx, 1);
  }
  closeModal();
  renderCeoRequests();
  buildNav();
  showToast('🗑️ הפנייה נמחקה');
}

function renderWorkerRequests() {
  const list = document.getElementById('worker-requests-list');
  if (!list) return;
  const myRequests = DATA.requests.filter(r => r.workerId === currentUser.id)
    .sort((a, b) => b.id - a.id);
  if (!myRequests.length) {
    list.innerHTML = '<div class="empty-state"><div class="icon">📭</div><p>עדיין לא שלחת פניות</p></div>';
    return;
  }
  list.innerHTML = myRequests.map(r => {
    const st = requestStatusLabels[r.status] || requestStatusLabels.pending;
    return `
    <div style="padding:14px 0;border-bottom:1px solid var(--border);">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:6px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span class="tag tag-purple" style="font-size:11px;">${requestTypeLabels[r.type] || r.type}</span>
          <span class="tag ${st.cls}" style="font-size:11px;">${st.text}</span>
        </div>
        <span style="font-size:11px;color:var(--text3);">${r.date}</span>
      </div>
      <div style="font-size:13px;color:var(--text);line-height:1.5;">${r.text}</div>
      ${r.reply ? `<div style="margin-top:8px;background:#f0fff4;border:1px solid #a8e8c0;border-radius:8px;padding:10px 12px;font-size:12px;color:#2d7a5a;"><strong>תשובת המנכ"ל:</strong> ${r.reply}</div>` : ''}
    </div>`;
  }).join('');
}

// ── CEO: view and manage worker requests ──
function renderCeoRequests() {
  const container = document.getElementById('ceo-requests-container');
  if (!container) return;
  const company = currentUser.company;
  let reqs = DATA.requests.filter(r => r.company === company).sort((a,b) => b.id - a.id);

  // Filter
  const f = document.getElementById('ceo-req-filter')?.value || 'all';
  if (f !== 'all') reqs = reqs.filter(r => r.status === f);

  const pending = DATA.requests.filter(r => r.company === company && r.status === 'pending').length;
  const badge = document.getElementById('ceo-requests-badge');
  if (badge) badge.textContent = pending > 0 ? pending : '';

  if (!reqs.length) {
    container.innerHTML = '<div class="empty-state"><div class="icon">📭</div><p>אין פניות</p></div>';
    return;
  }
  container.innerHTML = reqs.map(r => {
    const st = requestStatusLabels[r.status] || requestStatusLabels.pending;
    const worker = DATA.users.find(u => u.id === r.workerId);
    return `
    <div style="padding:16px;border:1px solid var(--border);border-radius:12px;margin-bottom:12px;background:var(--card);">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:32px;height:32px;border-radius:50%;background:${worker?.avatarColor||'#ccc'}33;color:${worker?.avatarColor||'#888'};display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;">${r.workerName[0]}</div>
          <div>
            <div style="font-weight:700;font-size:13px;">${r.workerName}</div>
            <div style="font-size:11px;color:var(--text3);">${r.date}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span class="tag tag-purple" style="font-size:11px;">${requestTypeLabels[r.type] || r.type}</span>
          <span class="tag ${st.cls}" style="font-size:11px;">${st.text}</span>
        </div>
      </div>
      <div style="font-size:13px;color:var(--text);line-height:1.5;margin-bottom:12px;">${r.text}</div>
      ${r.reply ? `<div style="background:#f0fff4;border:1px solid #a8e8c0;border-radius:8px;padding:10px 12px;font-size:12px;color:#2d7a5a;margin-bottom:10px;"><strong>תשובתך:</strong> ${r.reply}</div>` : ''}
      <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
        <select onchange="updateRequestStatus(${r.id},this.value)" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:12px;color:var(--text);font-family:inherit;cursor:pointer;outline:none;">
          <option value="pending"    ${r.status==='pending'    ?'selected':''}>⏳ ממתין</option>
          <option value="inprogress" ${r.status==='inprogress' ?'selected':''}>🔄 בטיפול</option>
          <option value="done"       ${r.status==='done'       ?'selected':''}>✅ טופל</option>
        </select>
        <button class="btn btn-outline btn-sm" onclick="openReplyRequest(${r.id})">💬 ${r.reply ? 'ערוך תשובה' : 'השב'}</button>
        ${(!currentUser.fieldWorker) ? `<button class="btn btn-danger btn-sm" onclick="deleteRequest(${r.id})">🗑️ מחק</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

function openReplyRequest(reqId) {
  const r = DATA.requests.find(x => x.id === reqId);
  if (!r) return;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">💬 תשובה לפנייה — ${r.workerName}</div>
    <div style="background:var(--bg3);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:13px;color:var(--text2);">${r.text}</div>
    <div class="form-group">
      <label>תשובתך</label>
      <textarea id="reply-text" class="notes-area" rows="4" placeholder="כתוב תשובה לפועל...">${r.reply || ''}</textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveRequestReply(${reqId})">💾 שמור תשובה</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
  setTimeout(() => document.getElementById('reply-text')?.focus(), 100);
}

function deleteRequest(reqId) {
  const r = DATA.requests.find(x => x.id === reqId);
  if (!r) return;
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">🗑️ מחיקת פנייה</div>
    <div style="background:#fff5f5;border:1px solid #f0c0c8;border-radius:12px;padding:16px;margin-bottom:18px;">
      <div style="font-size:13px;font-weight:700;color:#c0506a;margin-bottom:6px;">${requestTypeLabels[r.type] || r.type} — ${r.workerName}</div>
      <div style="font-size:13px;color:var(--text2);line-height:1.5;">${r.text}</div>
    </div>
    <div style="background:#fff8f0;border:1px solid #f0d0a8;border-radius:10px;padding:12px 14px;margin-bottom:18px;font-size:13px;color:#a05010;">
      ⚠️ פעולה זו תמחק את הפנייה לצמיתות ולא ניתן לשחזרה.
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" onclick="confirmDeleteRequest(${reqId})">🗑️ כן, מחק</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
}

function renderNotes(type) {
  const el = document.getElementById(`${type}-notes`);
  if (el && DATA.notes[`${type}-${currentUser.id}`]) el.value = DATA.notes[`${type}-${currentUser.id}`];
  renderQuickNotes(type);
}

async function saveNotes(type) {
  const el = document.getElementById(`${type}-notes`);
  if (!el) return;
  const content = el.value;
  DATA.notes[`${type}-${currentUser.id}`] = content;
  sbSaveNote(content);
  showToast('✅ הערות נשמרו!');
}


function addQuickNote(type) {
  document.getElementById('modalBody').innerHTML = `
    <div class="modal-title">📌 פתק מהיר חדש</div>
    <div class="form-group">
      <label>תוכן הפתק</label>
      <textarea id="quick-note-text" class="form-input" rows="4" placeholder="כתוב כאן את הפתק..." style="resize:vertical;font-family:inherit;"></textarea>
    </div>
    <div style="margin-bottom:14px;">
      <label style="font-size:12px;color:var(--text2);font-weight:600;margin-bottom:6px;display:block;">צבע</label>
      <div style="display:flex;gap:8px;">
        ${['#7bb3d8','#6bc4a6','#e8c46a','#e88fa0','#d4a0c8'].map((c,i) =>
          `<button onclick="selectNoteColor('${c}',this)" data-color="${c}" style="width:28px;height:28px;border-radius:50%;background:${c};border:3px solid ${i===0?'#333':'transparent'};cursor:pointer;" class="note-color-btn"></button>`
        ).join('')}
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-primary" onclick="saveQuickNote('${type}')">📌 הוסף פתק</button>
      <button class="btn btn-outline" onclick="closeModal()">ביטול</button>
    </div>`;
  openModal();
  setTimeout(() => document.getElementById('quick-note-text')?.focus(), 100);
}

function selectNoteColor(color, btn) {
  document.querySelectorAll('.note-color-btn').forEach(b => b.style.border = '3px solid transparent');
  btn.style.border = '3px solid #333';
  btn.closest('.modal') ? btn.dataset.selected = 'true' : null;
  window._selectedNoteColor = color;
}

function saveQuickNote(type) {
  const text = document.getElementById('quick-note-text')?.value.trim();
  if (!text) { showToast('❌ יש לכתוב תוכן לפתק', 'error'); return; }
  const color = window._selectedNoteColor || '#7bb3d8';
  const key = `${type}-${currentUser.id}`;
  if (!DATA.quickNotes[key]) DATA.quickNotes[key] = [];
  DATA.quickNotes[key].push({ text, time: new Date().toLocaleDateString('he-IL'), color });
  window._selectedNoteColor = null;
  closeModal();
  renderQuickNotes(type);
  showToast('📌 פתק נוסף!');
}

function renderQuickNotes(type) {
  const container = document.getElementById(`${type}-quick-notes`);
  if (!container) return;
  const key = `${type}-${currentUser.id}`;
  const notes = DATA.quickNotes[key] || [];
  if (!notes.length) { container.innerHTML = ''; return; }
  container.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:4px;">${notes.map((n,i) => `
    <div style="background:${n.color}15;border:1px solid ${n.color}44;border-radius:10px;padding:14px;position:relative;">
      <button onclick="deleteQuickNote('${type}',${i})" style="position:absolute;top:8px;left:8px;background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;">✕</button>
      <div style="font-size:13px;line-height:1.5;color:var(--text);margin-bottom:6px;">${n.text}</div>      <div style="font-size:11px;color:var(--text3);">${n.time}</div>
    </div>`).join('')}</div>`;
}

function deleteQuickNote(type, idx) {
  const key = `${type}-${currentUser.id}`;
  DATA.quickNotes[key].splice(idx, 1);
  renderQuickNotes(type);
}

const passVisible = {};
function togglePassView(userId, password) {
  passVisible[userId] = !passVisible[userId];
  const el = document.getElementById(`pass-display-${userId}`);
  const btn = document.getElementById(`eye-btn-${userId}`);
  if (el) el.textContent = passVisible[userId] ? password : '••••••••';
  if (btn) btn.textContent = passVisible[userId] ? '🙈' : '👁️';
}


function openModal() { document.getElementById('modalOverlay').classList.add('open'); }
function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }
document.getElementById('modalOverlay').addEventListener('click', function(e) { if (e.target === this) closeModal(); });

// ── SIDEBAR ──
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('open');
}

// ── TOAST ──
function showToast(msg, type = 'success') {
  const t = document.createElement('div');
  t.style.cssText = `position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:${type==='error'?'#fde8ec':'white'};border:1px solid ${type==='error'?'#e88fa0':'var(--border)'};color:${type==='error'?'#c0506a':'var(--text)'};padding:12px 24px;border-radius:10px;font-size:14px;font-weight:600;z-index:9999;box-shadow:0 8px 30px rgba(100,130,170,0.2);animation:slideUp 0.2s ease;`;
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => { t.style.opacity='0'; t.style.transition='opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 2500);
}

// ── KEYBOARD ──
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
document.getElementById('loginUser').addEventListener('keydown', e => { if (e.key === 'Enter') document.getElementById('loginPass').focus(); });

// ── SUPABASE INIT ──
window.addEventListener('DOMContentLoaded', () => {
  initSupabaseData();
});

</script>
</body>
</html>